"undefined"!=typeof window&&function t(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.Hls=r():e.Hls=r()}(this,()=>(()=>{var t={"./src/config.ts"(t,e,r){"use strict";r.r(e),r.d(e,{enableStreamingMode:()=>E,hlsDefaultConfig:()=>x,mergeConfig:()=>T});var i=r(/*! ./controller/abr-controller */ "./src/controller/abr-controller.ts"),n=r(/*! ./controller/audio-stream-controller */ "./src/controller/audio-stream-controller.ts"),a=r(/*! ./controller/audio-track-controller */ "./src/controller/audio-track-controller.ts"),s=r(/*! ./controller/subtitle-stream-controller */ "./src/controller/subtitle-stream-controller.ts"),o=r(/*! ./controller/subtitle-track-controller */ "./src/controller/subtitle-track-controller.ts"),l=r(/*! ./controller/buffer-controller */ "./src/controller/buffer-controller.ts"),u=r(/*! ./controller/timeline-controller */ "./src/controller/timeline-controller.ts"),d=r(/*! ./controller/cap-level-controller */ "./src/controller/cap-level-controller.ts"),c=r(/*! ./utils/xhr-loader */ "./src/utils/xhr-loader.ts"),f=r(/*! ./utils/fetch-loader */ "./src/utils/fetch-loader.ts"),h=r(/*! ./utils/cues */ "./src/utils/cues.ts"),$=r(/*! ./utils/logger */ "./src/utils/logger.ts");function g(){return(g=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function v(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)}return r}function p(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?v(Object(r),!0).forEach(function(e){m(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):v(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function m(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var x=p(p({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,enableSoftwareAES:!0,manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,startLevel:void 0,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:c.default,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:i.default,bufferController:l.default,capLevelController:d.default,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystemOptions:{},testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0},{cueHandler:h.default,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:s.SubtitleStreamController,subtitleTrackController:o.default,timelineController:u.TimelineController,audioStreamController:n.default,audioTrackController:a.default});function T(t,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==e.liveMaxLatencyDurationCount&&(void 0===e.liveSyncDurationCount||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==e.liveMaxLatencyDuration&&(void 0===e.liveSyncDuration||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');return g({},t,e)}function E(t){var e=t.loader;e!==f.default&&e!==c.default?($.logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),t.progressive=!1):(0,f.fetchSupported)()&&(t.loader=f.default,t.progressive=!0,t.enableSoftwareAES=!0,$.logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}},"./src/controller/abr-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>c});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../utils/ewma-bandwidth-estimator */ "./src/utils/ewma-bandwidth-estimator.ts"),a=r(/*! ../events */ "./src/events.ts"),s=r(/*! ../errors */ "./src/errors.ts"),o=r(/*! ../types/loader */ "./src/types/loader.ts"),l=r(/*! ../utils/logger */ "./src/utils/logger.ts");function u(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var d=function(){function t(t){this.hls=void 0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=void 0,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=t;var e=t.config;this.bwEstimator=new n.default(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate),this.registerListeners()}var e,r,d,c=t.prototype;return c.registerListeners=function t(){var e=this.hls;e.on(a.Events.FRAG_LOADING,this.onFragLoading,this),e.on(a.Events.FRAG_LOADED,this.onFragLoaded,this),e.on(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(a.Events.ERROR,this.onError,this)},c.unregisterListeners=function t(){var e=this.hls;e.off(a.Events.FRAG_LOADING,this.onFragLoading,this),e.off(a.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(a.Events.ERROR,this.onError,this)},c.destroy=function t(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},c.onFragLoading=function t(e,r){var i,n=r.frag;n.type!==o.PlaylistLevelType.MAIN||this.timer||(this.fragCurrent=n,this.partCurrent=null!=(i=r.part)?i:null,this.timer=self.setInterval(this.onCheck,100))},c.onLevelLoaded=function t(e,r){var i=this.hls.config;r.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)},c._abandonRulesCheck=function t(){var e,r=this.fragCurrent,n=this.partCurrent,s=this.hls,o=s.autoLevelEnabled,u=(s.config,s.media);if(r&&u){var d=n?n.stats:r.stats,c=n?n.duration:r.duration;if(d.aborted||d.loaded&&d.loaded===d.total||0===r.level){this.clearTimer(),this._nextAutoLevel=-1;return}if(o&&!u.paused&&u.playbackRate&&u.readyState){var f=s.mainForwardBufferInfo;if(null!==f){var h=performance.now()-d.loading.start,$=Math.abs(u.playbackRate);if(!(h<=500*c/$)){var g=d.loaded&&d.loading.first,v=this.bwEstimator.getEstimate(),p=s.levels,m=s.minAutoLevel,x=p[r.level],T=d.total||Math.max(d.loaded,Math.round(c*x.maxBitrate/8)),E=g?1e3*d.loaded/h:0,y=E?(T-d.loaded)/E:8*T/v,S=f.len/$;if(!(y<=S)){var L=Number.POSITIVE_INFINITY;for(e=r.level-1;e>m;e--){var b=p[e].maxBitrate;if((L=E?c*b/(6.4*E):c*b/v)<S)break}!(L>=y)&&(l.logger.warn("Fragment "+r.sn+(n?" part "+n.index:"")+" of level "+r.level+" is loading too slowly and will cause an underbuffer; aborting and switching to level "+e+"\n      Current BW estimate: "+((0,i.isFiniteNumber)(v)?(v/1024).toFixed(3):"Unknown")+" Kb/s\n      Estimated load time for current fragment: "+y.toFixed(3)+" s\n      Estimated load time for the next fragment: "+L.toFixed(3)+" s\n      Time to underbuffer: "+S.toFixed(3)+" s"),s.nextLoadLevel=e,g&&this.bwEstimator.sample(h,d.loaded),this.clearTimer(),r.loader&&(this.fragCurrent=this.partCurrent=null,r.loader.abort()),s.trigger(a.Events.FRAG_LOAD_EMERGENCY_ABORTED,{frag:r,part:n,stats:d}))}}}}}},c.onFragLoaded=function t(e,r){var n=r.frag,s=r.part;if(n.type===o.PlaylistLevelType.MAIN&&(0,i.isFiniteNumber)(n.sn)){var l=s?s.stats:n.stats,u=s?s.duration:n.duration;if(this.clearTimer(),this.lastLoadedFragLevel=n.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var d=this.hls.levels[n.level],c=(d.loaded?d.loaded.bytes:0)+l.loaded,f=(d.loaded?d.loaded.duration:0)+u;d.loaded={bytes:c,duration:f},d.realBitrate=Math.round(8*c/f)}if(n.bitrateTest){var h={stats:l,frag:n,part:s,id:n.type};this.onFragBuffered(a.Events.FRAG_BUFFERED,h)}}},c.onFragBuffered=function t(e,r){var i=r.frag,n=r.part,a=n?n.stats:i.stats;if(!a.aborted&&i.type===o.PlaylistLevelType.MAIN&&"initSegment"!==i.sn){var s=a.parsing.end-a.loading.start;this.bwEstimator.sample(s,a.loaded),a.bwEstimate=this.bwEstimator.getEstimate(),i.bitrateTest?this.bitrateTestDelay=s/1e3:this.bitrateTestDelay=0}},c.onError=function t(e,r){switch(r.details){case s.ErrorDetails.FRAG_LOAD_ERROR:case s.ErrorDetails.FRAG_LOAD_TIMEOUT:this.clearTimer()}},c.clearTimer=function t(){self.clearInterval(this.timer),this.timer=void 0},c.getNextABRAutoLevel=function t(){var e=this.fragCurrent,r=this.partCurrent,i=this.hls,n=i.maxAutoLevel,a=i.config,s=i.minAutoLevel,o=i.media,u=r?r.duration:e?e.duration:0;o&&o.currentTime;var d=o&&0!==o.playbackRate?Math.abs(o.playbackRate):1,c=this.bwEstimator?this.bwEstimator.getEstimate():a.abrEwmaDefaultEstimate,f=i.mainForwardBufferInfo,h=(f?f.len:0)/d,$=this.findBestLevel(c,s,n,h,a.abrBandWidthFactor,a.abrBandWidthUpFactor);if($>=0)return $;l.logger.trace((h?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var g=u?Math.min(u,a.maxStarvationDelay):a.maxStarvationDelay,v=a.abrBandWidthFactor,p=a.abrBandWidthUpFactor;if(!h){var m=this.bitrateTestDelay;m&&(g=(u?Math.min(u,a.maxLoadingDelay):a.maxLoadingDelay)-m,l.logger.trace("bitrate test took "+Math.round(1e3*m)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*g)+" ms"),v=p=1)}return Math.max($=this.findBestLevel(c,s,n,h+g,v,p),0)},c.findBestLevel=function t(e,r,n,a,s,o){for(var u,d=this.fragCurrent,c=this.partCurrent,f=this.lastLoadedFragLevel,h=this.hls.levels,$=h[f],g=!!(null!=$&&null!==(u=$.details)&&void 0!==u&&u.live),v=null==$?void 0:$.codecSet,p=c?c.duration:d?d.duration:0,m=n;m>=r;m--){var x=h[m];if(x&&(!v||x.codecSet===v)){var T=x.details,E=(c?null==T?void 0:T.partTarget:null==T?void 0:T.averagetargetduration)||p,y=void 0;y=m<=f?s*e:o*e;var S=h[m].maxBitrate,L=S*E/y;if(l.logger.trace("level/adjustedbw/bitrate/avgDuration/maxFetchDuration/fetchDuration: "+m+"/"+Math.round(y)+"/"+S+"/"+E+"/"+a+"/"+L),y>S&&(0===L||!(0,i.isFiniteNumber)(L)||g&&!this.bitrateTestDelay||L<a))return m}}return -1},e=t,r=[{key:"nextAutoLevel",get:function t(){var e=this._nextAutoLevel,r=this.bwEstimator;if(-1!==e&&!r.canEstimate())return e;var i=this.getNextABRAutoLevel();return -1!==e&&this.hls.levels[i].loadError?e:(-1!==e&&(i=Math.min(e,i)),i)},set:function t(e){this._nextAutoLevel=e}}],u(e.prototype,r),d&&u(e,d),Object.defineProperty(e,"prototype",{writable:!1}),t}();let c=d},"./src/controller/audio-stream-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>T});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./base-stream-controller */ "./src/controller/base-stream-controller.ts"),a=r(/*! ../events */ "./src/events.ts"),s=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),o=r(/*! ./fragment-tracker */ "./src/controller/fragment-tracker.ts"),l=r(/*! ../types/level */ "./src/types/level.ts"),u=r(/*! ../types/loader */ "./src/types/loader.ts"),d=r(/*! ../loader/fragment */ "./src/loader/fragment.ts"),c=r(/*! ../demux/chunk-cache */ "./src/demux/chunk-cache.ts"),f=r(/*! ../demux/transmuxer-interface */ "./src/demux/transmuxer-interface.ts"),h=r(/*! ../types/transmuxer */ "./src/types/transmuxer.ts"),$=r(/*! ./fragment-finders */ "./src/controller/fragment-finders.ts"),g=r(/*! ../utils/discontinuities */ "./src/utils/discontinuities.ts"),v=r(/*! ../errors */ "./src/errors.ts");function p(){return(p=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function m(t,e){return(m=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var x=function(t){function e(e,r){var i;return(i=t.call(this,e,r,"[audio-stream-controller]")||this).videoBuffer=null,i.videoTrackCC=-1,i.waitingVideoCC=-1,i.audioSwitch=!1,i.trackId=-1,i.waitingData=null,i.mainDetails=null,i.bufferFlushed=!1,i.cachedTrackLoadedData=null,i._registerListeners(),i}r=e,x=t,r.prototype=Object.create(x.prototype),r.prototype.constructor=r,m(r,x);var r,x,T=e.prototype;return T.onHandlerDestroying=function t(){this._unregisterListeners(),this.mainDetails=null},T._registerListeners=function t(){var e=this.hls;e.on(a.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(a.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(a.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(a.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(a.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(a.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(a.Events.ERROR,this.onError,this),e.on(a.Events.BUFFER_RESET,this.onBufferReset,this),e.on(a.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(a.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(a.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(a.Events.FRAG_BUFFERED,this.onFragBuffered,this)},T._unregisterListeners=function t(){var e=this.hls;e.off(a.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(a.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(a.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(a.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(a.Events.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(a.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(a.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(a.Events.ERROR,this.onError,this),e.off(a.Events.BUFFER_RESET,this.onBufferReset,this),e.off(a.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(a.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(a.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(a.Events.FRAG_BUFFERED,this.onFragBuffered,this)},T.onInitPtsFound=function t(e,r){var i=r.frag,a=r.id,s=r.initPTS;if("main"===a){var o=i.cc;this.initPTS[i.cc]=s,this.log("InitPTS for cc: "+o+" found from main: "+s),this.videoTrackCC=o,this.state===n.State.WAITING_INIT_PTS&&this.tick()}},T.startLoad=function t(e){if(!this.levels){this.startPosition=e,this.state=n.State.STOPPED;return}var r=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),this.fragLoadError=0,r>0&&-1===e?(this.log("Override startPosition with lastCurrentTime @"+r.toFixed(3)),e=r,this.state=n.State.IDLE):(this.loadedmetadata=!1,this.state=n.State.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},T.doTick=function e(){switch(this.state){case n.State.IDLE:this.doTickIdle();break;case n.State.WAITING_TRACK:var r,i=this.levels,a=this.trackId,o=null==i?void 0:null===(r=i[a])||void 0===r?void 0:r.details;if(o){if(this.waitForCdnTuneIn(o))break;this.state=n.State.WAITING_INIT_PTS}break;case n.State.FRAG_LOADING_WAITING_RETRY:var l,u=performance.now(),d=this.retryDate;(!d||u>=d||null!==(l=this.media)&&void 0!==l&&l.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=n.State.IDLE);break;case n.State.WAITING_INIT_PTS:var c=this.waitingData;if(c){var f=c.frag,h=c.part,g=c.cache,v=c.complete;if(void 0!==this.initPTS[f.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=n.State.FRAG_LOADING;var p={frag:f,part:h,payload:g.flush(),networkDetails:null};this._handleFragmentLoadProgress(p),v&&t.prototype._handleFragmentLoadComplete.call(this,p)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+f.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var m=this.getLoadPosition(),x=s.BufferHelper.bufferInfo(this.mediaBuffer,m,this.config.maxBufferHole);0>(0,$.fragmentWithinToleranceTest)(x.end,this.config.maxFragLookUpTolerance,f)&&(this.log("Waiting fragment cc ("+f.cc+") @ "+f.start+" cancelled because another fragment at "+x.end+" is needed"),this.clearWaitingFragment())}}else this.state=n.State.IDLE}this.onTickEnd()},T.clearWaitingFragment=function t(){var e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=n.State.IDLE)},T.resetLoadingState=function e(){this.clearWaitingFragment(),t.prototype.resetLoadingState.call(this)},T.onTickEnd=function t(){var e=this.media;e&&e.readyState&&(this.lastCurrentTime=e.currentTime)},T.doTickIdle=function t(){var e,r,i=this.hls,s=this.levels,o=this.media,l=this.trackId,c=i.config;if(s&&s[l]&&(o||!this.startFragRequested&&c.startFragPrefetch)){var f=s[l].details;if(!f||f.live&&this.levelLastLoaded!==l||this.waitForCdnTuneIn(f)){this.state=n.State.WAITING_TRACK;return}var h=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&h&&(this.bufferFlushed=!1,this.afterBufferFlushed(h,d.ElementaryStreamTypes.AUDIO,u.PlaylistLevelType.AUDIO));var $=this.getFwdBufferInfo(h,u.PlaylistLevelType.AUDIO);if(null!==$){var g=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,u.PlaylistLevelType.MAIN),v=$.len,p=this.getMaxBufferLength(null==g?void 0:g.len),m=this.audioSwitch;if(!(v>=p)||m){if(!m&&this._streamEnded($,f)){i.trigger(a.Events.BUFFER_EOS,{type:"audio"}),this.state=n.State.ENDED;return}var x=f.fragments[0].start,T=$.end;if(m&&o){var E=this.getLoadPosition();T=E,f.PTSKnown&&E<x&&($.end>x||$.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),o.currentTime=x+.05)}if((!g||!(T>g.end+f.targetduration))&&(g&&g.len||!$.len)){var y=this.getNextFragment(T,f);if(!y){this.bufferFlushed=!0;return}(null===(e=y.decryptdata)||void 0===e?void 0:e.keyFormat)!=="identity"||null!==(r=y.decryptdata)&&void 0!==r&&r.key?this.loadFragment(y,f,T):this.loadKey(y,f)}}}}},T.getMaxBufferLength=function e(r){var i=t.prototype.getMaxBufferLength.call(this);return r?Math.max(i,r):i},T.onMediaDetaching=function e(){this.videoBuffer=null,t.prototype.onMediaDetaching.call(this)},T.onAudioTracksUpdated=function t(e,r){var i=r.audioTracks;this.resetTransmuxer(),this.levels=i.map(function(t){return new l.Level(t)})},T.onAudioTrackSwitching=function t(e,r){var i=!!r.url;this.trackId=r.id;var a=this.fragCurrent;null!=a&&a.loader&&a.loader.abort(),this.fragCurrent=null,this.clearWaitingFragment(),i?this.setInterval(100):this.resetTransmuxer(),i?(this.audioSwitch=!0,this.state=n.State.IDLE):this.state=n.State.STOPPED,this.tick()},T.onManifestLoading=function t(){this.mainDetails=null,this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1},T.onLevelLoaded=function t(e,r){this.mainDetails=r.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(a.Events.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},T.onAudioTrackLoaded=function t(e,r){if(null==this.mainDetails){this.cachedTrackLoadedData=r;return}var i,a=this.levels,s=r.details,o=r.id;if(!a){this.warn("Audio tracks were reset while loading level "+o);return}this.log("Track "+o+" loaded ["+s.startSN+","+s.endSN+"],duration:"+s.totalduration);var l=a[o],u=0;if(s.live||null!==(i=l.details)&&void 0!==i&&i.live){var d=this.mainDetails;if(s.fragments[0]||(s.deltaUpdateFailed=!0),s.deltaUpdateFailed||!d)return;!l.details&&s.hasProgramDateTime&&d.hasProgramDateTime?((0,g.alignMediaPlaylistByPDT)(s,d),u=s.fragments[0].start):u=this.alignPlaylists(s,l.details)}l.details=s,this.levelLastLoaded=o,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(l.details,u),this.state!==n.State.WAITING_TRACK||this.waitForCdnTuneIn(s)||(this.state=n.State.IDLE),this.tick()},T._handleFragmentLoadProgress=function t(e){var r,i=e.frag,a=e.part,s=e.payload,o=this.config,l=this.trackId,d=this.levels;if(!d){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+i.sn+" of level "+i.level+" will not be buffered");return}var $=d[l];console.assert($,"Audio track is defined on fragment load progress");var g=$.details;console.assert(g,"Audio track details are defined on fragment load progress");var v=o.defaultAudioCodec||$.audioCodec||"mp4a.40.2",p=this.transmuxer;p||(p=this.transmuxer=new f.default(this.hls,u.PlaylistLevelType.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var m=this.initPTS[i.cc],x=null===(r=i.initSegment)||void 0===r?void 0:r.data;if(void 0!==m){var T=a?a.index:-1,E=new h.ChunkMetadata(i.level,i.sn,i.stats.chunkCount,s.byteLength,T,-1!==T);p.push(s,x,v,"",i,a,g.totalduration,!1,E,m)}else this.log("Unknown video PTS for cc "+i.cc+", waiting for video PTS before demuxing audio frag "+i.sn+" of ["+g.startSN+" ,"+g.endSN+"],track "+l),(this.waitingData=this.waitingData||{frag:i,part:a,cache:new c.default,complete:!1}).cache.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=n.State.WAITING_INIT_PTS},T._handleFragmentLoadComplete=function e(r){if(this.waitingData){this.waitingData.complete=!0;return}t.prototype._handleFragmentLoadComplete.call(this,r)},T.onBufferReset=function t(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},T.onBufferCreated=function t(e,r){var i=r.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),r.tracks.video&&(this.videoBuffer=r.tracks.video.buffer||null)},T.onFragBuffered=function t(e,r){var i,n=r.frag,s=r.part;if(n.type!==u.PlaylistLevelType.AUDIO){!this.loadedmetadata&&n.type===u.PlaylistLevelType.MAIN&&null!==(i=this.videoBuffer||this.media)&&void 0!==i&&i.buffered.length&&(this.loadedmetadata=!0);return}if(this.fragContextChanged(n)){this.warn("Fragment "+n.sn+(s?" p: "+s.index:"")+" of level "+n.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+this.audioSwitch);return}"initSegment"!==n.sn&&(this.fragPrevious=n,this.audioSwitch&&(this.audioSwitch=!1,this.hls.trigger(a.Events.AUDIO_TRACK_SWITCHED,{id:this.trackId}))),this.fragBufferedComplete(n,s)},T.onError=function e(r,i){switch(i.details){case v.ErrorDetails.FRAG_LOAD_ERROR:case v.ErrorDetails.FRAG_LOAD_TIMEOUT:case v.ErrorDetails.KEY_LOAD_ERROR:case v.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(u.PlaylistLevelType.AUDIO,i);break;case v.ErrorDetails.AUDIO_TRACK_LOAD_ERROR:case v.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:this.state!==n.State.ERROR&&this.state!==n.State.STOPPED&&(this.state=i.fatal?n.State.ERROR:n.State.IDLE,this.warn(i.details+" while loading frag, switching to "+this.state+" state"));break;case v.ErrorDetails.BUFFER_FULL_ERROR:if("audio"===i.parent&&(this.state===n.State.PARSING||this.state===n.State.PARSED)){var a=!0,s=this.getFwdBufferInfo(this.mediaBuffer,u.PlaylistLevelType.AUDIO);s&&s.len>.5&&(a=!this.reduceMaxBufferLength(s.len)),a&&(this.warn("Buffer full error also media.currentTime is not buffered, flush audio buffer"),this.fragCurrent=null,t.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.resetLoadingState()}}},T.onBufferFlushed=function t(e,r){r.type===d.ElementaryStreamTypes.AUDIO&&(this.bufferFlushed=!0)},T._handleTransmuxComplete=function t(e){var r,i="audio",s=this.hls,o=e.remuxResult,l=e.chunkMeta,u=this.getCurrentContext(l);if(!u){this.warn("The loading context changed while buffering fragment "+l.sn+" of level "+l.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(l.level);return}var c=u.frag,f=u.part,h=u.level.details,$=o.audio,g=o.text,v=o.id3,m=o.initSegment;if(!this.fragContextChanged(c)&&h){if(this.state=n.State.PARSING,this.audioSwitch&&$&&this.completeAudioSwitch(),null!=m&&m.tracks&&(this._bufferInitSegment(m.tracks,c,l),s.trigger(a.Events.FRAG_PARSING_INIT_SEGMENT,{frag:c,id:i,tracks:m.tracks})),$){var x=$.startPTS,T=$.endPTS,E=$.startDTS,y=$.endDTS;f&&(f.elementaryStreams[d.ElementaryStreamTypes.AUDIO]={startPTS:x,endPTS:T,startDTS:E,endDTS:y}),c.setElementaryStreamInfo(d.ElementaryStreamTypes.AUDIO,x,T,E,y),this.bufferFragmentData($,c,f,l)}if(null!=v&&null!==(r=v.samples)&&void 0!==r&&r.length){var S=p({id:i,frag:c,details:h},v);s.trigger(a.Events.FRAG_PARSING_METADATA,S)}if(g){var L=p({id:i,frag:c,details:h},g);s.trigger(a.Events.FRAG_PARSING_USERDATA,L)}}},T._bufferInitSegment=function t(e,r,i){if(this.state===n.State.PARSING){e.video&&delete e.video;var s=e.audio;if(s){s.levelCodec=s.codec,s.id="audio",this.log("Init audio buffer, container:"+s.container+", codecs[parsed]=["+s.codec+"]"),this.hls.trigger(a.Events.BUFFER_CODECS,e);var o=s.initSegment;if(null!=o&&o.byteLength){var l={type:"audio",frag:r,part:null,chunkMeta:i,parent:r.type,data:o};this.hls.trigger(a.Events.BUFFER_APPENDING,l)}this.tick()}}},T.loadFragment=function e(r,a,s){var l=this.fragmentTracker.getState(r);this.fragCurrent=r,(this.audioSwitch||l===o.FragmentState.NOT_LOADED||l===o.FragmentState.PARTIAL)&&("initSegment"===r.sn?this._loadInitSegment(r):a.live&&!(0,i.isFiniteNumber)(this.initPTS[r.cc])?(this.log("Waiting for video PTS in continuity counter "+r.cc+" of live stream before loading audio fragment "+r.sn+" of level "+this.trackId),this.state=n.State.WAITING_INIT_PTS):(this.startFragRequested=!0,t.prototype.loadFragment.call(this,r,a,s)))},T.completeAudioSwitch=function e(){var r=this.hls,i=this.media,n=this.trackId;i&&(this.log("Switching audio track : flushing all audio"),t.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.audioSwitch=!1,r.trigger(a.Events.AUDIO_TRACK_SWITCHED,{id:n})},e}(n.default);let T=x},"./src/controller/audio-track-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>d});var i=r(/*! ../events */ "./src/events.ts"),n=r(/*! ../errors */ "./src/errors.ts"),a=r(/*! ./base-playlist-controller */ "./src/controller/base-playlist-controller.ts"),s=r(/*! ../types/loader */ "./src/types/loader.ts");function o(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function l(t,e){return(l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var u=function(t){function e(e){var r;return(r=t.call(this,e,"[audio-track-controller]")||this).tracks=[],r.groupId=null,r.tracksInGroup=[],r.trackId=-1,r.trackName="",r.selectDefaultTrack=!0,r.registerListeners(),r}r=e,a=t,r.prototype=Object.create(a.prototype),r.prototype.constructor=r,l(r,a);var r,a,u,d,c,f=e.prototype;return f.registerListeners=function t(){var e=this.hls;e.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(i.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(i.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(i.Events.ERROR,this.onError,this)},f.unregisterListeners=function t(){var e=this.hls;e.off(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(i.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(i.Events.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(i.Events.ERROR,this.onError,this)},f.destroy=function e(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,t.prototype.destroy.call(this)},f.onManifestLoading=function t(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.trackName="",this.selectDefaultTrack=!0},f.onManifestParsed=function t(e,r){this.tracks=r.audioTracks||[]},f.onAudioTrackLoaded=function t(e,r){var i=r.id,n=r.details,a=this.tracksInGroup[i];if(!a){this.warn("Invalid audio track id "+i);return}var s=a.details;a.details=r.details,this.log("audioTrack "+i+" loaded ["+n.startSN+"-"+n.endSN+"]"),i===this.trackId&&(this.retryCount=0,this.playlistLoaded(i,r,s))},f.onLevelLoading=function t(e,r){this.switchLevel(r.level)},f.onLevelSwitching=function t(e,r){this.switchLevel(r.level)},f.switchLevel=function t(e){var r=this.hls.levels[e];if(null!=r&&r.audioGroupIds){var n=r.audioGroupIds[r.urlId];if(this.groupId!==n){this.groupId=n;var a=this.tracks.filter(function(t){return!n||t.groupId===n});this.selectDefaultTrack&&!a.some(function(t){return t.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=a,this.log("Updating audio tracks, "+a.length+' track(s) found in "'+n+'" group-id'),this.hls.trigger(i.Events.AUDIO_TRACKS_UPDATED,{audioTracks:a}),this.selectInitialTrack()}}},f.onError=function e(r,i){t.prototype.onError.call(this,r,i),!i.fatal&&i.context&&i.context.type===s.PlaylistContextType.AUDIO_TRACK&&i.context.id===this.trackId&&i.context.groupId===this.groupId&&this.retryLoadingOrFail(i)},f.setAudioTrack=function t(e){var r=this.tracksInGroup;if(e<0||e>=r.length){this.warn("Invalid id passed to audio-track controller");return}this.clearTimer();var n=r[this.trackId];this.log("Now switching to audio-track index "+e);var a=r[e],s=a.id,o=a.groupId,l=a.name,u=a.type,d=a.url;if(this.trackId=e,this.trackName=l,this.selectDefaultTrack=!1,this.hls.trigger(i.Events.AUDIO_TRACK_SWITCHING,{id:s,groupId:void 0===o?"":o,name:l,type:u,url:d}),!a.details||a.details.live){var c=this.switchParams(a.url,null==n?void 0:n.details);this.loadPlaylist(c)}},f.selectInitialTrack=function t(){var e=this.tracksInGroup;console.assert(e.length,"Initial audio track should be selected when tracks are known");var r=this.trackName,a=this.findTrackId(r)||this.findTrackId();-1!==a?this.setAudioTrack(a):(this.warn("No track found for running audio group-ID: "+this.groupId),this.hls.trigger(i.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,fatal:!0}))},f.findTrackId=function t(e){for(var r=this.tracksInGroup,i=0;i<r.length;i++){var n=r[i];if((!this.selectDefaultTrack||n.default)&&(!e||e===n.name))return n.id}return -1},f.loadPlaylist=function t(e){var r=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(r)){var n=r.id,a=r.groupId,s=r.url;if(e)try{s=e.addDirectives(s)}catch(o){this.warn("Could not construct new URL with HLS Delivery Directives: "+o)}this.log("loading audio-track playlist for id: "+n),this.clearTimer(),this.hls.trigger(i.Events.AUDIO_TRACK_LOADING,{url:s,id:n,groupId:a,deliveryDirectives:e||null})}},u=e,d=[{key:"audioTracks",get:function t(){return this.tracksInGroup}},{key:"audioTrack",get:function t(){return this.trackId},set:function t(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}}],o(u.prototype,d),c&&o(u,c),Object.defineProperty(u,"prototype",{writable:!1}),e}(a.default);let d=u},"./src/controller/base-playlist-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>l});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../types/level */ "./src/types/level.ts"),a=r(/*! ./level-helper */ "./src/controller/level-helper.ts"),s=r(/*! ../utils/logger */ "./src/utils/logger.ts"),o=r(/*! ../errors */ "./src/errors.ts"),l=function(){function t(t,e){this.hls=void 0,this.timer=-1,this.canLoad=!1,this.retryCount=0,this.log=void 0,this.warn=void 0,this.log=s.logger.log.bind(s.logger,e+":"),this.warn=s.logger.warn.bind(s.logger,e+":"),this.hls=t}var e=t.prototype;return e.destroy=function t(){this.clearTimer(),this.hls=this.log=this.warn=null},e.onError=function t(e,r){r.fatal&&r.type===o.ErrorTypes.NETWORK_ERROR&&this.clearTimer()},e.clearTimer=function t(){clearTimeout(this.timer),this.timer=-1},e.startLoad=function t(){this.canLoad=!0,this.retryCount=0,this.loadPlaylist()},e.stopLoad=function t(){this.canLoad=!1,this.clearTimer()},e.switchParams=function t(e,r){var a=null==r?void 0:r.renditionReports;if(a)for(var s=0;s<a.length;s++){var o=a[s],l=""+o.URI;if(l===e.slice(-l.length)){var u=parseInt(o["LAST-MSN"]),d=parseInt(o["LAST-PART"]);if(r&&this.hls.config.lowLatencyMode){var c=Math.min(r.age-r.partTarget,r.targetduration);void 0!==d&&c>r.partTarget&&(d+=1)}if((0,i.isFiniteNumber)(u))return new n.HlsUrlParameters(u,(0,i.isFiniteNumber)(d)?d:void 0,n.HlsSkip.No)}}},e.loadPlaylist=function t(e){},e.shouldLoadTrack=function t(e){return this.canLoad&&e&&!!e.url&&(!e.details||e.details.live)},e.playlistLoaded=function t(e,r,i){var n=this,s=r.details,o=r.stats,l=o.loading.end?Math.max(0,self.performance.now()-o.loading.end):0;if(s.advancedDateTime=Date.now()-l,s.live||null!=i&&i.live){if(s.reloaded(i),i&&this.log("live playlist "+e+" "+(s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:"MISSED")),i&&s.fragments.length>0&&(0,a.mergeDetails)(i,s),!this.canLoad||!s.live)return;var u,d=void 0,c=void 0;if(s.canBlockReload&&s.endSN&&s.advanced){var f=this.hls.config.lowLatencyMode,h=s.lastPartSn,$=s.endSN,g=s.lastPartIndex,v=h===$;-1!==g?(d=v?$+1:h,c=v?f?0:g:g+1):d=$+1;var p=s.age,m=Math.min(p+s.ageHeader-s.partTarget,1.5*s.targetduration);if(m>0){if(i&&m>i.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+i.tuneInGoal+" to: "+m+" with playlist age: "+s.age),m=0;else{var x=Math.floor(m/s.targetduration);d+=x,void 0!==c&&(c+=Math.round(m%s.targetduration/s.partTarget)),this.log("CDN Tune-in age: "+s.ageHeader+"s last advanced "+p.toFixed(2)+"s goal: "+m+" skip sn "+x+" to part "+c)}s.tuneInGoal=m}if(u=this.getDeliveryDirectives(s,r.deliveryDirectives,d,c),f||!v){this.loadPlaylist(u);return}}else u=this.getDeliveryDirectives(s,r.deliveryDirectives,d,c);var T=(0,a.computeReloadInterval)(s,o);void 0!==d&&s.canBlockReload&&(T-=s.partTarget||1),this.log("reload live playlist "+e+" in "+Math.round(T)+" ms"),this.timer=self.setTimeout(function(){return n.loadPlaylist(u)},T)}else this.clearTimer()},e.getDeliveryDirectives=function t(e,r,i,a){var s=(0,n.getSkipValue)(e,i);return null!=r&&r.skip&&e.deltaUpdateFailed&&(i=r.msn,a=r.part,s=n.HlsSkip.No),new n.HlsUrlParameters(i,a,s)},e.retryLoadingOrFail=function t(e){var r,i=this,n=this.hls.config,a=this.retryCount<n.levelLoadingMaxRetry;if(a){if(this.retryCount++,e.details.indexOf("LoadTimeOut")>-1&&null!==(r=e.context)&&void 0!==r&&r.deliveryDirectives)this.warn("retry playlist loading #"+this.retryCount+' after "'+e.details+'"'),this.loadPlaylist();else{var s=Math.min(Math.pow(2,this.retryCount)*n.levelLoadingRetryDelay,n.levelLoadingMaxRetryTimeout);this.timer=self.setTimeout(function(){return i.loadPlaylist()},s),this.warn("retry playlist loading #"+this.retryCount+" in "+s+' ms after "'+e.details+'"')}}else this.warn('cannot recover from error "'+e.details+'"'),this.clearTimer(),e.fatal=!0;return a},t}()},"./src/controller/base-stream-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{State:()=>y,default:()=>S});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../task-loop */ "./src/task-loop.ts"),a=r(/*! ./fragment-tracker */ "./src/controller/fragment-tracker.ts"),s=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),o=r(/*! ../utils/logger */ "./src/utils/logger.ts"),l=r(/*! ../events */ "./src/events.ts"),u=r(/*! ../errors */ "./src/errors.ts"),d=r(/*! ../types/transmuxer */ "./src/types/transmuxer.ts"),c=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),f=r(/*! ../utils/discontinuities */ "./src/utils/discontinuities.ts"),h=r(/*! ./fragment-finders */ "./src/controller/fragment-finders.ts"),$=r(/*! ./level-helper */ "./src/controller/level-helper.ts"),g=r(/*! ../loader/fragment-loader */ "./src/loader/fragment-loader.ts"),v=r(/*! ../crypt/decrypter */ "./src/crypt/decrypter.ts"),p=r(/*! ../utils/time-ranges */ "./src/utils/time-ranges.ts"),m=r(/*! ../types/loader */ "./src/types/loader.ts");function x(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function T(t){if(void 0===t)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function E(t,e){return(E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var y={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},S=function(t){function e(e,r,i){var n;return(n=t.call(this)||this).hls=void 0,n.fragPrevious=null,n.fragCurrent=null,n.fragmentTracker=void 0,n.transmuxer=null,n._state=y.STOPPED,n.media=null,n.mediaBuffer=null,n.config=void 0,n.bitrateTest=!1,n.lastCurrentTime=0,n.nextLoadPosition=0,n.startPosition=0,n.loadedmetadata=!1,n.fragLoadError=0,n.retryDate=0,n.levels=null,n.fragmentLoader=void 0,n.levelLastLoaded=null,n.startFragRequested=!1,n.decrypter=void 0,n.initPTS=[],n.onvseeking=null,n.onvended=null,n.logPrefix="",n.log=void 0,n.warn=void 0,n.logPrefix=i,n.log=o.logger.log.bind(o.logger,i+":"),n.warn=o.logger.warn.bind(o.logger,i+":"),n.hls=e,n.fragmentLoader=new g.default(e.config),n.fragmentTracker=r,n.config=e.config,n.decrypter=new v.default(e,e.config),e.on(l.Events.KEY_LOADED,n.onKeyLoaded,T(n)),e.on(l.Events.LEVEL_SWITCHING,n.onLevelSwitching,T(n)),n}r=e,n=t,r.prototype=Object.create(n.prototype),r.prototype.constructor=r,E(r,n);var r,n,S,L,b,D=e.prototype;return D.doTick=function t(){this.onTickEnd()},D.onTickEnd=function t(){},D.startLoad=function t(e){},D.stopLoad=function t(){this.fragmentLoader.abort();var e=this.fragCurrent;e&&this.fragmentTracker.removeFragment(e),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=y.STOPPED},D._streamEnded=function t(e,r){var i=this.fragCurrent,n=this.fragmentTracker;if(!r.live&&i&&this.media&&i.sn>=r.endSN&&!e.nextStart){var o=r.partList;if(null!=o&&o.length){var l=o[o.length-1];return s.BufferHelper.isBuffered(this.media,l.start+l.duration/2)}var u=n.getState(i);return u===a.FragmentState.PARTIAL||u===a.FragmentState.OK}return!1},D.onMediaAttached=function t(e,r){var i=this.media=this.mediaBuffer=r.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);var n=this.config;this.levels&&n.autoStartLoad&&this.state===y.STOPPED&&this.startLoad(n.startPosition)},D.onMediaDetaching=function t(){var e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},D.onMediaSeeking=function t(){var e=this.config,r=this.fragCurrent,n=this.media,a=this.mediaBuffer,o=this.state,l=n?n.currentTime:0,u=s.BufferHelper.bufferInfo(a||n,l,e.maxBufferHole);if(this.log("media seeking to "+((0,i.isFiniteNumber)(l)?l.toFixed(3):l)+", state: "+o),o===y.ENDED)this.resetLoadingState();else if(r){var d=e.maxFragLookUpTolerance,c=r.start-d,f=r.start+r.duration+d;if(!u.len||f<u.start||c>u.end){var h=l>f;(l<c||h)&&(h&&r.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),r.loader.abort()),this.resetLoadingState())}}n&&(this.lastCurrentTime=l),this.loadedmetadata||u.len||(this.nextLoadPosition=this.startPosition=l),this.tickImmediate()},D.onMediaEnded=function t(){this.startPosition=this.lastCurrentTime=0},D.onKeyLoaded=function t(e,r){if(this.state===y.KEY_LOADING&&r.frag===this.fragCurrent&&this.levels){this.state=y.IDLE;var i=this.levels[r.frag.level].details;i&&this.loadFragment(r.frag,i,r.frag.start)}},D.onLevelSwitching=function t(e,r){this.fragLoadError=0},D.onHandlerDestroying=function e(){this.stopLoad(),t.prototype.onHandlerDestroying.call(this)},D.onHandlerDestroyed=function e(){this.state=y.STOPPED,this.hls.off(l.Events.KEY_LOADED,this.onKeyLoaded,this),this.hls.off(l.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),this.fragmentLoader&&this.fragmentLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.fragmentLoader=this.fragmentTracker=null,t.prototype.onHandlerDestroyed.call(this)},D.loadKey=function t(e,r){this.log("Loading key for "+e.sn+" of ["+r.startSN+"-"+r.endSN+"], "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+e.level),this.state=y.KEY_LOADING,this.fragCurrent=e,this.hls.trigger(l.Events.KEY_LOADING,{frag:e})},D.loadFragment=function t(e,r,i){this._loadFragForPlayback(e,r,i)},D._loadFragForPlayback=function t(e,r,i){var n=this,a=function t(r){if(n.fragContextChanged(e)){n.warn("Fragment "+e.sn+(r.part?" p: "+r.part.index:"")+" of level "+e.level+" was dropped during download."),n.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,n._handleFragmentLoadProgress(r)};this._doFragLoad(e,r,i,a).then(function(t){if(t){n.fragLoadError=0;var r=n.state;if(n.fragContextChanged(e)){r!==y.FRAG_LOADING&&(n.fragCurrent||r!==y.PARSING)||(n.fragmentTracker.removeFragment(e),n.state=y.IDLE);return}"payload"in t&&(n.log("Loaded fragment "+e.sn+" of level "+e.level),n.hls.trigger(l.Events.FRAG_LOADED,t)),n._handleFragmentLoadComplete(t)}}).catch(function(t){n.state!==y.STOPPED&&n.state!==y.ERROR&&(n.warn(t),n.resetFragmentLoading(e))})},D.flushMainBuffer=function t(e,r,i){if(void 0===i&&(i=null),e-r){var n={startOffset:e,endOffset:r,type:i};this.fragLoadError=0,this.hls.trigger(l.Events.BUFFER_FLUSHING,n)}},D._loadInitSegment=function t(e){var r=this;this._doFragLoad(e).then(function(t){if(!t||r.fragContextChanged(e)||!r.levels)throw Error("init load aborted");return t}).then(function(t){var i=r.hls,n=t.payload,a=e.decryptdata;if(n&&n.byteLength>0&&a&&a.key&&a.iv&&"AES-128"===a.method){var s=self.performance.now();return r.decrypter.webCryptoDecrypt(new Uint8Array(n),a.key.buffer,a.iv.buffer).then(function(r){var n=self.performance.now();return i.trigger(l.Events.FRAG_DECRYPTED,{frag:e,payload:r,stats:{tstart:s,tdecrypt:n}}),t.payload=r,t})}return t}).then(function(t){var i=r.fragCurrent,n=r.hls,a=r.levels;if(!a)throw Error("init load aborted, missing levels");var s=a[e.level].details;console.assert(s,"Level details are defined when init segment is loaded");var o=e.stats;r.state=y.IDLE,r.fragLoadError=0,e.data=new Uint8Array(t.payload),o.parsing.start=o.buffering.start=self.performance.now(),o.parsing.end=o.buffering.end=self.performance.now(),t.frag===i&&n.trigger(l.Events.FRAG_BUFFERED,{stats:o,frag:i,part:null,id:e.type}),r.tick()}).catch(function(t){r.state!==y.STOPPED&&r.state!==y.ERROR&&(r.warn(t),r.resetFragmentLoading(e))})},D.fragContextChanged=function t(e){var r=this.fragCurrent;return!e||!r||e.level!==r.level||e.sn!==r.sn||e.urlId!==r.urlId},D.fragBufferedComplete=function t(e,r){var i,n,a=this.mediaBuffer?this.mediaBuffer:this.media;this.log("Buffered "+e.type+" sn: "+e.sn+(r?" part: "+r.index:"")+" of "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+e.level+" "+(a?p.default.toString(s.BufferHelper.getBuffered(a)):"(detached)")),this.state=y.IDLE,a&&(!this.loadedmetadata&&e.type==m.PlaylistLevelType.MAIN&&a.buffered.length&&(null===(i=this.fragCurrent)||void 0===i?void 0:i.sn)===(null===(n=this.fragPrevious)||void 0===n?void 0:n.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},D.seekToStartPos=function t(){},D._handleFragmentLoadComplete=function t(e){var r=this.transmuxer;if(r){var i=e.frag,n=e.part,a=e.partsLoaded,s=!a||0===a.length||a.some(function(t){return!t}),o=new d.ChunkMetadata(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!s);r.flush(o)}},D._handleFragmentLoadProgress=function t(e){},D._doFragLoad=function t(e,r,n,a){var s=this;if(void 0===n&&(n=null),!this.levels)throw Error("frag load aborted, missing levels");if(n=Math.max(e.start,n||0),this.config.lowLatencyMode&&r){var o=r.partList;if(o&&a){n>e.end&&r.fragmentHint&&(e=r.fragmentHint);var u=this.getNextPart(o,e,n);if(u>-1){var d=o[u];return this.log("Loading part sn: "+e.sn+" p: "+d.index+" cc: "+e.cc+" of playlist ["+r.startSN+"-"+r.endSN+"] parts [0-"+u+"-"+(o.length-1)+"] "+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(n.toFixed(3))),this.nextLoadPosition=d.start+d.duration,this.state=y.FRAG_LOADING,this.hls.trigger(l.Events.FRAG_LOADING,{frag:e,part:o[u],targetBufferTime:n}),this.doFragPartsLoad(e,o,u,a).catch(function(t){return s.handleFragLoadError(t)})}if(!e.url||this.loadedEndOfParts(o,n))return Promise.resolve(null)}}return this.log("Loading fragment "+e.sn+" cc: "+e.cc+" "+(r?"of ["+r.startSN+"-"+r.endSN+"] ":"")+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(n.toFixed(3))),(0,i.isFiniteNumber)(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=y.FRAG_LOADING,this.hls.trigger(l.Events.FRAG_LOADING,{frag:e,targetBufferTime:n}),this.fragmentLoader.load(e,a).catch(function(t){return s.handleFragLoadError(t)})},D.doFragPartsLoad=function t(e,r,i,n){var a=this;return new Promise(function(t,s){var o=[];!function i(u){var d=r[u];a.fragmentLoader.loadPart(e,d,n).then(function(n){o[d.index]=n;var s=n.part;a.hls.trigger(l.Events.FRAG_LOADED,n);var c=r[u+1];if(!c||c.fragment!==e)return t({frag:e,part:s,partsLoaded:o});i(u+1)}).catch(s)}(i)})},D.handleFragLoadError=function t(e){var r=e.data;return r&&r.details===u.ErrorDetails.INTERNAL_ABORTED?this.handleFragLoadAborted(r.frag,r.part):this.hls.trigger(l.Events.ERROR,r),null},D._handleTransmuxerFlush=function t(e){var r=this.getCurrentContext(e);if(!r||this.state!==y.PARSING){this.fragCurrent||(this.state=y.IDLE);return}var i=r.frag,n=r.part,a=r.level,s=self.performance.now();i.stats.parsing.end=s,n&&(n.stats.parsing.end=s),this.updateLevelTiming(i,n,a,e.partial)},D.getCurrentContext=function t(e){var r=this.levels,i=e.level,n=e.sn,a=e.part;if(!r||!r[i])return this.warn("Levels object was unset while buffering fragment "+n+" of level "+i+". The current chunk will not be buffered."),null;var s=r[i],o=a>-1?(0,$.getPartWith)(s,n,a):null,l=o?o.fragment:(0,$.getFragmentWithSN)(s,n,this.fragCurrent);return l?{frag:l,part:o,level:s}:null},D.bufferFragmentData=function t(e,r,i,n){if(e&&this.state===y.PARSING){var a=e.data1,s=e.data2,o=a;if(a&&s&&(o=(0,c.appendUint8Array)(a,s)),o&&o.length){var u={type:e.type,frag:r,part:i,chunkMeta:n,parent:r.type,data:o};this.hls.trigger(l.Events.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i&&this.flushBufferGap(r)}}},D.flushBufferGap=function t(e){var r=this.media;if(r){if(!s.BufferHelper.isBuffered(r,r.currentTime)){this.flushMainBuffer(0,e.start);return}var i=r.currentTime,n=s.BufferHelper.bufferInfo(r,i,0),a=e.duration,o=Math.min(2*this.config.maxFragLookUpTolerance,.25*a),l=Math.max(Math.min(e.start-o,n.end-o),i+o);e.start-l>o&&this.flushMainBuffer(l,e.start)}},D.getFwdBufferInfo=function t(e,r){var n=this.config,a=this.getLoadPosition();if(!(0,i.isFiniteNumber)(a))return null;var o=s.BufferHelper.bufferInfo(e,a,n.maxBufferHole);if(0===o.len&&void 0!==o.nextStart){var l=this.fragmentTracker.getBufferedFrag(a,r);if(l&&o.nextStart<l.end)return s.BufferHelper.bufferInfo(e,a,Math.max(o.nextStart,n.maxBufferHole))}return o},D.getMaxBufferLength=function t(e){var r,i=this.config;return Math.min(r=e?Math.max(8*i.maxBufferSize/e,i.maxBufferLength):i.maxBufferLength,i.maxMaxBufferLength)},D.reduceMaxBufferLength=function t(e){var r=this.config,i=e||r.maxBufferLength;return r.maxMaxBufferLength>=i&&(r.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+r.maxMaxBufferLength+"s"),!0)},D.getNextFragment=function t(e,r){var i,n=r.fragments,a=n.length;if(!a)return null;var s=this.config,o=n[0].start;if(r.live){var l=s.initialLiveManifestSize;if(a<l)return this.warn("Not enough fragments to start playback (have: "+a+", need: "+l+")"),null;r.PTSKnown||this.startFragRequested||-1!==this.startPosition||(i=this.getInitialLiveFragment(r,n),this.startPosition=i?this.hls.liveSyncPosition||i.start:e)}else e<=o&&(i=n[0]);if(!i){var u=s.lowLatencyMode?r.partEnd:r.fragmentEnd;i=this.getFragmentAtPosition(e,u,r)}return this.mapToInitFragWhenRequired(i)},D.mapToInitFragWhenRequired=function t(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment},D.getNextPart=function t(e,r,i){for(var n=-1,a=!1,s=!0,o=0,l=e.length;o<l;o++){var u=e[o];if(s=s&&!u.independent,n>-1&&i<u.start)break;var d=u.loaded;!d&&(a||u.independent||s)&&u.fragment===r&&(n=o),a=d}return n},D.loadedEndOfParts=function t(e,r){var i=e[e.length-1];return i&&r>i.start&&i.loaded},D.getInitialLiveFragment=function t(e,r){var i=this.fragPrevious,n=null;if(i){if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+i.programDateTime),n=(0,h.findFragmentByPDT)(r,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){var a=i.sn+1;if(a>=e.startSN&&a<=e.endSN){var s=r[a-e.startSN];i.cc===s.cc&&(n=s,this.log("Live playlist, switching playlist, load frag with next SN: "+n.sn))}!n&&(n=(0,h.findFragWithCC)(r,i.cc))&&this.log("Live playlist, switching playlist, load frag with same CC: "+n.sn)}}else{var o=this.hls.liveSyncPosition;null!==o&&(n=this.getFragmentAtPosition(o,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n},D.getFragmentAtPosition=function t(e,r,i){var n,s=this.config,o=this.fragPrevious,l=i.fragments,u=i.endSN,d=i.fragmentHint,c=s.maxFragLookUpTolerance,f=!!(s.lowLatencyMode&&i.partList&&d);if(f&&d&&!this.bitrateTest&&(l=l.concat(d),u=d.sn),n=e<r?(0,h.findFragmentByPTS)(o,l,e,e>r-c?0:c):l[l.length-1]){var $=n.sn-i.startSN;if(this.fragmentTracker.getState(n)===a.FragmentState.OK&&(o=n),o&&n.sn===o.sn&&!f&&o&&n.level===o.level){var g=l[$+1];n.sn<u&&this.fragmentTracker.getState(g)!==a.FragmentState.OK?(this.log("SN "+n.sn+" just loaded, load next one: "+g.sn),n=g):n=null}}return n},D.synchronizeToLiveEdge=function t(e){var r=this.config,i=this.media;if(i){var n=this.hls.liveSyncPosition,a=i.currentTime,s=e.fragments[0].start,o=e.edge,l=a>=s-r.maxFragLookUpTolerance&&a<=o;if(null!==n&&i.duration>n&&(a<n||!l)){var u=void 0!==r.liveMaxLatencyDuration?r.liveMaxLatencyDuration:r.liveMaxLatencyDurationCount*e.targetduration;(!l&&i.readyState<4||a<o-u)&&(this.loadedmetadata||(this.nextLoadPosition=n),i.readyState&&(this.warn("Playback: "+a.toFixed(3)+" is located too far from the end of live sliding playlist: "+o+", reset currentTime to : "+n.toFixed(3)),i.currentTime=n))}}},D.alignPlaylists=function t(e,r){var n=this.levels,a=this.levelLastLoaded,s=this.fragPrevious,o=null!==a?n[a]:null,l=e.fragments.length;if(!l)return this.warn("No fragments in live playlist"),0;var u=e.fragments[0].start,d=e.alignedSliding&&(0,i.isFiniteNumber)(u);if(!r||!d&&!u){(0,f.alignStream)(s,o,e);var c=e.fragments[0].start;return this.log("Live playlist sliding: "+c.toFixed(2)+" start-sn: "+(r?r.startSN:"na")+"->"+e.startSN+" prev-sn: "+(s?s.sn:"na")+" fragments: "+l),c}return u},D.waitForCdnTuneIn=function t(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)},D.setStartPosition=function t(e,r){var n=this.startPosition;if(n<r&&(n=-1),-1===n||-1===this.lastCurrentTime){var a=e.startTimeOffset;(0,i.isFiniteNumber)(a)?(n=r+a,a<0&&(n+=e.totalduration),n=Math.min(Math.max(r,n),r+e.totalduration),this.log("Start time offset "+a+" found in playlist, adjust startPosition to "+n),this.startPosition=n):e.live?n=this.hls.liveSyncPosition||r:this.startPosition=n=0,this.lastCurrentTime=n}this.nextLoadPosition=n},D.getLoadPosition=function t(){var e=this.media,r=0;return this.loadedmetadata&&e?r=e.currentTime:this.nextLoadPosition&&(r=this.nextLoadPosition),r},D.handleFragLoadAborted=function t(e,r){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn("Fragment "+e.sn+(r?" part"+r.index:"")+" of level "+e.level+" was aborted"),this.resetFragmentLoading(e))},D.resetFragmentLoading=function t(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===y.FRAG_LOADING_WAITING_RETRY)||(this.state=y.IDLE)},D.onFragmentOrKeyLoadError=function t(e,r){if(!r.fatal){var i=r.frag;if(i&&i.type===e){var n=this.fragCurrent;console.assert(n&&i.sn===n.sn&&i.level===n.level&&i.urlId===n.urlId,"Frag load error must match current frag to retry");var a=this.config;if(this.fragLoadError+1<=a.fragLoadingMaxRetry){this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition);var s=Math.min(Math.pow(2,this.fragLoadError)*a.fragLoadingRetryDelay,a.fragLoadingMaxRetryTimeout);this.warn("Fragment "+i.sn+" of "+e+" "+i.level+" failed to load, retrying in "+s+"ms"),this.retryDate=self.performance.now()+s,this.fragLoadError++,this.state=y.FRAG_LOADING_WAITING_RETRY}else r.levelRetry?(e===m.PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.fragLoadError=0,this.state=y.IDLE):(o.logger.error(r.details+" reaches max retry, redispatch as fatal ..."),r.fatal=!0,this.hls.stopLoad(),this.state=y.ERROR)}}},D.afterBufferFlushed=function t(e,r,i){if(e){var n=s.BufferHelper.getBuffered(e);this.fragmentTracker.detectEvictedFragments(r,n,i),this.state===y.ENDED&&this.resetLoadingState()}},D.resetLoadingState=function t(){this.fragCurrent=null,this.fragPrevious=null,this.state=y.IDLE},D.resetStartWhenNotLoaded=function t(e){if(!this.loadedmetadata){this.startFragRequested=!1;var r=this.levels?this.levels[e].details:null;null!=r&&r.live?(this.startPosition=-1,this.setStartPosition(r,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},D.updateLevelTiming=function t(e,r,i,n){var a=this,s=i.details;console.assert(!!s,"level.details must be defined"),Object.keys(e.elementaryStreams).reduce(function(t,r){var o=e.elementaryStreams[r];if(o){var u=o.endPTS-o.startPTS;if(u<=0)return a.warn("Could not parse fragment "+e.sn+" "+r+" duration reliably ("+u+")"),t||!1;var d=n?0:(0,$.updateFragPTSDTS)(s,e,o.startPTS,o.endPTS,o.startDTS,o.endDTS);return a.hls.trigger(l.Events.LEVEL_PTS_UPDATED,{details:s,level:i,drift:d,type:r,frag:e,start:o.startPTS,end:o.endPTS}),!0}return t},!1)||(this.warn("Found no media in fragment "+e.sn+" of level "+i.id+" resetting transmuxer to fallback to playlist timing"),this.resetTransmuxer()),this.state=y.PARSED,this.hls.trigger(l.Events.FRAG_PARSED,{frag:e,part:r})},D.resetTransmuxer=function t(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},S=e,L=[{key:"state",get:function t(){return this._state},set:function t(e){var r=this._state;r!==e&&(this._state=e,this.log(r+"->"+e))}}],x(S.prototype,L),b&&x(S,b),Object.defineProperty(S,"prototype",{writable:!1}),e}(n.default)},"./src/controller/buffer-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>h});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../utils/logger */ "./src/utils/logger.ts"),s=r(/*! ../errors */ "./src/errors.ts"),o=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),l=r(/*! ../utils/mediasource-helper */ "./src/utils/mediasource-helper.ts"),u=r(/*! ../loader/fragment */ "./src/loader/fragment.ts"),d=r(/*! ./buffer-operation-queue */ "./src/controller/buffer-operation-queue.ts"),c=(0,l.getMediaSource)(),f=/([ha]vc.)(?:\.[^.,]+)+/,h=function(){function t(t){var e=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var t=e.hls,r=e.media,i=e.mediaSource;a.logger.log("[buffer-controller]: Media source opened"),r&&(e.updateMediaElementDuration(),t.trigger(n.Events.MEDIA_ATTACHED,{media:r})),i&&i.removeEventListener("sourceopen",e._onMediaSourceOpen),e.checkPendingTracks()},this._onMediaSourceClose=function(){a.logger.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){a.logger.log("[buffer-controller]: Media source ended")},this.hls=t,this._initSourceBuffer(),this.registerListeners()}var e=t.prototype;return e.hasSourceTypes=function t(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0},e.destroy=function t(){this.unregisterListeners(),this.details=null},e.registerListeners=function t(){var e=this.hls;e.on(n.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(n.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(n.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(n.Events.BUFFER_RESET,this.onBufferReset,this),e.on(n.Events.BUFFER_APPENDING,this.onBufferAppending,this),e.on(n.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(n.Events.BUFFER_EOS,this.onBufferEos,this),e.on(n.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(n.Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(n.Events.FRAG_PARSED,this.onFragParsed,this),e.on(n.Events.FRAG_CHANGED,this.onFragChanged,this)},e.unregisterListeners=function t(){var e=this.hls;e.off(n.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(n.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(n.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(n.Events.BUFFER_RESET,this.onBufferReset,this),e.off(n.Events.BUFFER_APPENDING,this.onBufferAppending,this),e.off(n.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(n.Events.BUFFER_EOS,this.onBufferEos,this),e.off(n.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(n.Events.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(n.Events.FRAG_PARSED,this.onFragParsed,this),e.off(n.Events.FRAG_CHANGED,this.onFragChanged,this)},e._initSourceBuffer=function t(){this.sourceBuffer={},this.operationQueue=new d.default(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]}},e.onManifestParsed=function t(e,r){var i=2;(!r.audio||r.video)&&r.altAudio||(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.details=null,a.logger.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},e.onMediaAttaching=function t(e,r){var i=this.media=r.media;if(i&&c){var n=this.mediaSource=new c;n.addEventListener("sourceopen",this._onMediaSourceOpen),n.addEventListener("sourceended",this._onMediaSourceEnded),n.addEventListener("sourceclose",this._onMediaSourceClose),i.src=self.URL.createObjectURL(n),this._objectUrl=i.src}},e.onMediaDetaching=function t(){var e=this.media,r=this.mediaSource,i=this._objectUrl;if(r){if(a.logger.log("[buffer-controller]: media source detaching"),"open"===r.readyState)try{r.endOfStream()}catch(s){a.logger.warn("[buffer-controller]: onMediaDetaching: "+s.message+" while calling endOfStream")}this.onBufferReset(),r.removeEventListener("sourceopen",this._onMediaSourceOpen),r.removeEventListener("sourceended",this._onMediaSourceEnded),r.removeEventListener("sourceclose",this._onMediaSourceClose),e&&(i&&self.URL.revokeObjectURL(i),e.src===i?(e.removeAttribute("src"),e.load()):a.logger.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(n.Events.MEDIA_DETACHED,void 0)},e.onBufferReset=function t(){var e=this;this.getSourceBufferTypes().forEach(function(t){var r=e.sourceBuffer[t];try{r&&(e.removeBufferListeners(t),e.mediaSource&&e.mediaSource.removeSourceBuffer(r),e.sourceBuffer[t]=void 0)}catch(i){a.logger.warn("[buffer-controller]: Failed to reset the "+t+" buffer",i)}}),this._initSourceBuffer()},e.onBufferCodecs=function t(e,r){var i=this,n=this.getSourceBufferTypes().length;Object.keys(r).forEach(function(t){if(n){var e=i.tracks[t];if(e&&"function"==typeof e.buffer.changeType){var s=r[t],o=s.id,l=s.codec,u=s.levelCodec,d=s.container,c=s.metadata,h=(e.levelCodec||e.codec).replace(f,"$1"),$=(u||l).replace(f,"$1");h!==$&&(i.appendChangeType(t,d+";codecs="+(u||l)),a.logger.log("[buffer-controller]: switching codec "+h+" to "+$),i.tracks[t]={buffer:e.buffer,codec:l,container:d,levelCodec:u,metadata:c,id:o})}}else i.pendingTracks[t]=r[t]}),!n&&(this.bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())},e.appendChangeType=function t(e,r){var i=this,n=this.operationQueue;n.append({execute:function t(){var s=i.sourceBuffer[e];s&&(a.logger.log("[buffer-controller]: changing "+e+" sourceBuffer type to "+r),s.changeType(r)),n.shiftAndExecuteNext(e)},onStart:function t(){},onComplete:function t(){},onError:function t(r){a.logger.warn("[buffer-controller]: Failed to change "+e+" SourceBuffer type",r)}},e)},e.onBufferAppending=function t(e,r){var i=this,l=this.hls,u=this.operationQueue,d=this.tracks,c=r.data,f=r.type,h=r.frag,$=r.part,g=r.chunkMeta,v=g.buffering[f],p=self.performance.now();v.start=p;var m=h.stats.buffering,x=$?$.stats.buffering:null;0===m.start&&(m.start=p),x&&0===x.start&&(x.start=p);var T=d.audio,E="audio"===f&&1===g.id&&(null==T?void 0:T.container)==="audio/mpeg";u.append({execute:function t(){if(v.executeStart=self.performance.now(),E){var e=i.sourceBuffer[f];if(e){var r=h.start-e.timestampOffset;Math.abs(r)>=.1&&(a.logger.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+h.start+" (delta: "+r+") sn: "+h.sn+")"),e.timestampOffset=h.start)}}i.appendExecutor(c,f)},onStart:function t(){},onComplete:function t(){var e=self.performance.now();v.executeEnd=v.end=e,0===m.first&&(m.first=e),x&&0===x.first&&(x.first=e);var r=i.sourceBuffer,a={};for(var s in r)a[s]=o.BufferHelper.getBuffered(r[s]);i.appendError=0,i.hls.trigger(n.Events.BUFFER_APPENDED,{type:f,frag:h,part:$,chunkMeta:g,parent:h.type,timeRanges:a})},onError:function t(e){a.logger.error("[buffer-controller]: Error encountered while trying to append to the "+f+" SourceBuffer",e);var r={type:s.ErrorTypes.MEDIA_ERROR,parent:h.type,details:s.ErrorDetails.BUFFER_APPEND_ERROR,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?r.details=s.ErrorDetails.BUFFER_FULL_ERROR:(i.appendError++,r.details=s.ErrorDetails.BUFFER_APPEND_ERROR,i.appendError>l.config.appendErrorMaxRetry&&(a.logger.error("[buffer-controller]: Failed "+l.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),r.fatal=!0,l.stopLoad())),l.trigger(n.Events.ERROR,r)}},f)},e.onBufferFlushing=function t(e,r){var i=this,s=this.operationQueue,o=function t(e){return{execute:i.removeExecutor.bind(i,e,r.startOffset,r.endOffset),onStart:function t(){},onComplete:function t(){i.hls.trigger(n.Events.BUFFER_FLUSHED,{type:e})},onError:function t(r){a.logger.warn("[buffer-controller]: Failed to remove from "+e+" SourceBuffer",r)}}};r.type?s.append(o(r.type),r.type):this.getSourceBufferTypes().forEach(function(t){s.append(o(t),t)})},e.onFragParsed=function t(e,r){var i=this,s=r.frag,o=r.part,l=[],d=o?o.elementaryStreams:s.elementaryStreams;d[u.ElementaryStreamTypes.AUDIOVIDEO]?l.push("audiovideo"):(d[u.ElementaryStreamTypes.AUDIO]&&l.push("audio"),d[u.ElementaryStreamTypes.VIDEO]&&l.push("video"));var c=function t(){var e=self.performance.now();s.stats.buffering.end=e,o&&(o.stats.buffering.end=e);var r=o?o.stats:s.stats;i.hls.trigger(n.Events.FRAG_BUFFERED,{frag:s,part:o,stats:r,id:s.type})};0===l.length&&a.logger.warn("Fragments must have at least one ElementaryStreamType set. type: "+s.type+" level: "+s.level+" sn: "+s.sn),this.blockBuffers(c,l)},e.onFragChanged=function t(e,r){this.flushBackBuffer()},e.onBufferEos=function t(e,r){var i=this;this.getSourceBufferTypes().reduce(function(t,e){var n=i.sourceBuffer[e];return r.type&&r.type!==e||!n||n.ended||(n.ended=!0,a.logger.log("[buffer-controller]: "+e+" sourceBuffer now EOS")),t&&!!(!n||n.ended)},!0)&&this.blockBuffers(function(){var t=i.mediaSource;t&&"open"===t.readyState&&t.endOfStream()})},e.onLevelUpdated=function t(e,r){var i=r.details;i.fragments.length&&(this.details=i,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},e.flushBackBuffer=function t(){var e=this.hls,r=this.details,a=this.media,s=this.sourceBuffer;if(a&&null!==r){var l=this.getSourceBufferTypes();if(l.length){var u=r.live&&null!==e.config.liveBackBufferLength?e.config.liveBackBufferLength:e.config.backBufferLength;if((0,i.isFiniteNumber)(u)&&!(u<0)){var d=a.currentTime,c=r.levelTargetDuration,f=Math.floor(d/c)*c-Math.max(u,c);l.forEach(function(t){var i=s[t];if(i){var a=o.BufferHelper.getBuffered(i);a.length>0&&f>a.start(0)&&(e.trigger(n.Events.BACK_BUFFER_REACHED,{bufferEnd:f}),r.live&&e.trigger(n.Events.LIVE_BACK_BUFFER_REACHED,{bufferEnd:f}),e.trigger(n.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:f,type:t}))}})}}}},e.updateMediaElementDuration=function t(){if(this.details&&this.media&&this.mediaSource&&"open"===this.mediaSource.readyState){var e=this.details,r=this.hls,n=this.media,s=this.mediaSource,o=e.fragments[0].start+e.totalduration,l=n.duration,u=(0,i.isFiniteNumber)(s.duration)?s.duration:0;e.live&&r.config.liveDurationInfinity?(a.logger.log("[buffer-controller]: Media Source duration is set to Infinity"),s.duration=1/0,this.updateSeekableRange(e)):(o>u&&o>l||!(0,i.isFiniteNumber)(l))&&(a.logger.log("[buffer-controller]: Updating Media Source duration to "+o.toFixed(3)),s.duration=o)}},e.updateSeekableRange=function t(e){var r=this.mediaSource,i=e.fragments;if(i.length&&e.live&&null!=r&&r.setLiveSeekableRange){var n=Math.max(0,i[0].start),a=Math.max(n,n+e.totalduration);r.setLiveSeekableRange(n,a)}},e.checkPendingTracks=function t(){var e=this.bufferCodecEventsExpected,r=this.operationQueue,i=this.pendingTracks,a=Object.keys(i).length;if(a&&!e||2===a){this.createSourceBuffers(i),this.pendingTracks={};var o=this.getSourceBufferTypes();if(0===o.length){this.hls.trigger(n.Events.ERROR,{type:s.ErrorTypes.MEDIA_ERROR,details:s.ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,reason:"could not create source buffer for media codec(s)"});return}o.forEach(function(t){r.executeNext(t)})}},e.createSourceBuffers=function t(e){var r=this.sourceBuffer,i=this.mediaSource;if(!i)throw Error("createSourceBuffers called when mediaSource was null");var o=0;for(var l in e)if(!r[l]){var u=e[l];if(!u)throw Error("source buffer exists for track "+l+", however track does not");var d=u.levelCodec||u.codec,c=u.container+";codecs="+d;a.logger.log("[buffer-controller]: creating sourceBuffer("+c+")");try{var f=r[l]=i.addSourceBuffer(c),h=l;this.addBufferListener(h,"updatestart",this._onSBUpdateStart),this.addBufferListener(h,"updateend",this._onSBUpdateEnd),this.addBufferListener(h,"error",this._onSBUpdateError),this.tracks[l]={buffer:f,codec:d,container:u.container,levelCodec:u.levelCodec,metadata:u.metadata,id:u.id},o++}catch($){a.logger.error("[buffer-controller]: error while trying to add sourceBuffer: "+$.message),this.hls.trigger(n.Events.ERROR,{type:s.ErrorTypes.MEDIA_ERROR,details:s.ErrorDetails.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:$,mimeType:c})}}o&&this.hls.trigger(n.Events.BUFFER_CREATED,{tracks:this.tracks})},e._onSBUpdateStart=function t(e){this.operationQueue.current(e).onStart()},e._onSBUpdateEnd=function t(e){var r=this.operationQueue;r.current(e).onComplete(),r.shiftAndExecuteNext(e)},e._onSBUpdateError=function t(e,r){a.logger.error("[buffer-controller]: "+e+" SourceBuffer error",r),this.hls.trigger(n.Events.ERROR,{type:s.ErrorTypes.MEDIA_ERROR,details:s.ErrorDetails.BUFFER_APPENDING_ERROR,fatal:!1});var i=this.operationQueue.current(e);i&&i.onError(r)},e.removeExecutor=function t(e,r,n){var s=this.media,o=this.mediaSource,l=this.operationQueue,u=this.sourceBuffer[e];if(!s||!o||!u){a.logger.warn("[buffer-controller]: Attempting to remove from the "+e+" SourceBuffer, but it does not exist"),l.shiftAndExecuteNext(e);return}var d=(0,i.isFiniteNumber)(s.duration)?s.duration:1/0,c=(0,i.isFiniteNumber)(o.duration)?o.duration:1/0,f=Math.max(0,r),h=Math.min(n,d,c);h>f?(a.logger.log("[buffer-controller]: Removing ["+f+","+h+"] from the "+e+" SourceBuffer"),console.assert(!u.updating,e+" sourceBuffer must not be updating"),u.remove(f,h)):l.shiftAndExecuteNext(e)},e.appendExecutor=function t(e,r){var i=this.operationQueue,n=this.sourceBuffer[r];if(!n){a.logger.warn("[buffer-controller]: Attempting to append to the "+r+" SourceBuffer, but it does not exist"),i.shiftAndExecuteNext(r);return}n.ended=!1,console.assert(!n.updating,r+" sourceBuffer must not be updating"),n.appendBuffer(e)},e.blockBuffers=function t(e,r){var i=this;if(void 0===r&&(r=this.getSourceBufferTypes()),!r.length){a.logger.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}var n=this.operationQueue;Promise.all(r.map(function(t){return n.appendBlocker(t)})).then(function(){e(),r.forEach(function(t){var e=i.sourceBuffer[t];e&&e.updating||n.shiftAndExecuteNext(t)})})},e.getSourceBufferTypes=function t(){return Object.keys(this.sourceBuffer)},e.addBufferListener=function t(e,r,i){var n=this.sourceBuffer[e];if(n){var a=i.bind(this,e);this.listeners[e].push({event:r,listener:a}),n.addEventListener(r,a)}},e.removeBufferListeners=function t(e){var r=this.sourceBuffer[e];r&&this.listeners[e].forEach(function(t){r.removeEventListener(t.event,t.listener)})},t}()},"./src/controller/buffer-operation-queue.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>n});var i=r(/*! ../utils/logger */ "./src/utils/logger.ts"),n=function(){function t(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}var e=t.prototype;return e.append=function t(e,r){var i=this.queues[r];i.push(e),1===i.length&&this.buffers[r]&&this.executeNext(r)},e.insertAbort=function t(e,r){this.queues[r].unshift(e),this.executeNext(r)},e.appendBlocker=function t(e){var r,i=new Promise(function(t){r=t}),n={execute:r,onStart:function t(){},onComplete:function t(){},onError:function t(){}};return this.append(n,e),i},e.executeNext=function t(e){var r=this.buffers,n=this.queues,a=r[e],s=n[e];if(s.length){var o=s[0];try{o.execute()}catch(l){i.logger.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),o.onError(l),a&&a.updating||(s.shift(),this.executeNext(e))}}},e.shiftAndExecuteNext=function t(e){this.queues[e].shift(),this.executeNext(e)},e.current=function t(e){return this.queues[e][0]},t}()},"./src/controller/cap-level-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>s});var i=r(/*! ../events */ "./src/events.ts");function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=function(){function t(t){this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.hls=void 0,this.streamController=void 0,this.clientRect=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var e,r,a,s=t.prototype;return s.setStreamController=function t(e){this.streamController=e},s.destroy=function t(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},s.registerListeners=function t(){var e=this.hls;e.on(i.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(i.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},s.unregisterListener=function t(){var e=this.hls;e.off(i.Events.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(i.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(i.Events.BUFFER_CODECS,this.onBufferCodecs,this),e.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this)},s.onFpsDropLevelCapping=function e(r,i){t.isLevelAllowed(i.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(i.droppedLevel)},s.onMediaAttaching=function t(e,r){this.media=r.media instanceof HTMLVideoElement?r.media:null},s.onManifestParsed=function t(e,r){var i=this.hls;this.restrictedLevels=[],this.firstLevel=r.firstLevel,i.config.capLevelToPlayerSize&&r.video&&this.startCapping()},s.onBufferCodecs=function t(e,r){this.hls.config.capLevelToPlayerSize&&r.video&&this.startCapping()},s.onMediaDetaching=function t(){this.stopCapping()},s.detectPlayerSize=function t(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){var e=this.hls.levels;if(e.length){var r=this.hls;r.autoLevelCapping=this.getMaxLevel(e.length-1),r.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=r.autoLevelCapping}}},s.getMaxLevel=function e(r){var i=this,n=this.hls.levels;if(!n.length)return -1;var a=n.filter(function(e,n){return t.isLevelAllowed(n,i.restrictedLevels)&&n<=r});return this.clientRect=null,t.getMaxLevelByMediaSize(a,this.mediaWidth,this.mediaHeight)},s.startCapping=function t(){!this.timer&&(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},s.stopCapping=function t(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},s.getDimensions=function t(){if(this.clientRect)return this.clientRect;var e=this.media,r={width:0,height:0};if(e){var i=e.getBoundingClientRect();r.width=i.width,r.height=i.height,r.width||r.height||(r.width=i.right-i.left||e.width||0,r.height=i.bottom-i.top||e.height||0)}return this.clientRect=r,r},t.isLevelAllowed=function t(e,r){return void 0===r&&(r=[]),-1===r.indexOf(e)},t.getMaxLevelByMediaSize=function t(e,r,i){if(!e||!e.length)return -1;for(var n=e.length-1,a=0;a<e.length;a+=1){var s,o,l=e[a];if((l.width>=r||l.height>=i)&&(s=l,!(o=e[a+1])||s.width!==o.width||s.height!==o.height)){n=a;break}}return n},e=t,r=[{key:"mediaWidth",get:function t(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function t(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function t(){var e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(r){}return e}}],n(e.prototype,r),a&&n(e,a),Object.defineProperty(e,"prototype",{writable:!1}),t}();let s=a},"./src/controller/fragment-finders.ts"(t,e,r){"use strict";r.r(e),r.d(e,{findFragWithCC:()=>u,findFragmentByPDT:()=>a,findFragmentByPTS:()=>s,fragmentWithinToleranceTest:()=>o,pdtWithinToleranceTest:()=>l});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../utils/binary-search */ "./src/utils/binary-search.ts");function a(t,e,r){if(null===e||!Array.isArray(t)||!t.length||!(0,i.isFiniteNumber)(e)||e<(t[0].programDateTime||0)||e>=(t[t.length-1].endProgramDateTime||0))return null;r=r||0;for(var n=0;n<t.length;++n){var a=t[n];if(l(e,r,a))return a}return null}function s(t,e,r,i){void 0===r&&(r=0),void 0===i&&(i=0);var a=null;if(t?a=e[t.sn-e[0].sn+1]||null:0===r&&0===e[0].start&&(a=e[0]),a&&0===o(r,i,a))return a;var s=n.default.search(e,o.bind(null,r,i));return s||a}function o(t,e,r){void 0===t&&(t=0),void 0===e&&(e=0);var i=Math.min(e,r.duration+(r.deltaPTS?r.deltaPTS:0));return r.start+r.duration-i<=t?1:r.start-i>t&&r.start?-1:0}function l(t,e,r){var i=1e3*Math.min(e,r.duration+(r.deltaPTS?r.deltaPTS:0));return(r.endProgramDateTime||0)-i>t}function u(t,e){return n.default.search(t,function(t){return t.cc<e?1:t.cc>e?-1:0})}},"./src/controller/fragment-tracker.ts"(t,e,r){"use strict";r.r(e),r.d(e,{FragmentState:()=>i,FragmentTracker:()=>o});var i,n,a=r(/*! ../events */ "./src/events.ts"),s=r(/*! ../types/loader */ "./src/types/loader.ts");(n=i||(i={})).NOT_LOADED="NOT_LOADED",n.APPENDING="APPENDING",n.PARTIAL="PARTIAL",n.OK="OK";var o=function(){function t(t){this.activeFragment=null,this.activeParts=null,this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hls=t,this._registerListeners()}var e=t.prototype;return e._registerListeners=function t(){var e=this.hls;e.on(a.Events.BUFFER_APPENDED,this.onBufferAppended,this),e.on(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.on(a.Events.FRAG_LOADED,this.onFragLoaded,this)},e._unregisterListeners=function t(){var e=this.hls;e.off(a.Events.BUFFER_APPENDED,this.onBufferAppended,this),e.off(a.Events.FRAG_BUFFERED,this.onFragBuffered,this),e.off(a.Events.FRAG_LOADED,this.onFragLoaded,this)},e.destroy=function t(){this._unregisterListeners(),this.fragments=this.timeRanges=null},e.getAppendedFrag=function t(e,r){if(r===s.PlaylistLevelType.MAIN){var i=this.activeFragment,n=this.activeParts;if(!i)return null;if(n)for(var a=n.length;a--;){var o=n[a],l=o?o.end:i.appendedPTS;if(o.start<=e&&void 0!==l&&e<=l)return a>9&&(this.activeParts=n.slice(a-9)),o}else if(i.start<=e&&void 0!==i.appendedPTS&&e<=i.appendedPTS)return i}return this.getBufferedFrag(e,r)},e.getBufferedFrag=function t(e,r){for(var i=this.fragments,n=Object.keys(i),a=n.length;a--;){var s=i[n[a]];if((null==s?void 0:s.body.type)===r&&s.buffered){var o=s.body;if(o.start<=e&&e<=o.end)return o}}return null},e.detectEvictedFragments=function t(e,r,i){var n=this;Object.keys(this.fragments).forEach(function(t){var a=n.fragments[t];if(a){if(!a.buffered){a.body.type===i&&n.removeFragment(a.body);return}var s=a.range[e];s&&s.time.some(function(t){var e=!n.isTimeBuffered(t.startPTS,t.endPTS,r);return e&&n.removeFragment(a.body),e})}})},e.detectPartialFragments=function t(e){var r=this,i=this.timeRanges,n=e.frag,a=e.part;if(i&&"initSegment"!==n.sn){var s=u(n),o=this.fragments[s];o&&(Object.keys(i).forEach(function(t){var e=n.elementaryStreams[t];if(e){var s=i[t],l=null!==a||!0===e.partial;o.range[t]=r.getBufferedTimes(n,a,l,s)}}),o.loaded=null,Object.keys(o.range).length?o.buffered=!0:this.removeFragment(o.body))}},e.fragBuffered=function t(e){var r=u(e),i=this.fragments[r];i&&(i.loaded=null,i.buffered=!0)},e.getBufferedTimes=function t(e,r,i,n){for(var a={time:[],partial:i},s=r?r.start:e.start,o=r?r.end:e.end,l=e.minEndPTS||o,u=e.maxStartPTS||s,d=0;d<n.length;d++){var c=n.start(d)-this.bufferPadding,f=n.end(d)+this.bufferPadding;if(u>=c&&l<=f){a.time.push({startPTS:Math.max(s,n.start(d)),endPTS:Math.min(o,n.end(d))});break}if(s<f&&o>c)a.partial=!0,a.time.push({startPTS:Math.max(s,n.start(d)),endPTS:Math.min(o,n.end(d))});else if(o<=c)break}return a},e.getPartialFragment=function t(e){var r,i,n,a=null,s=0,o=this.bufferPadding,u=this.fragments;return Object.keys(u).forEach(function(t){var d=u[t];d&&l(d)&&(i=d.body.start-o,n=d.body.end+o,e>=i&&e<=n&&s<=(r=Math.min(e-i,n-e))&&(a=d.body,s=r))}),a},e.getState=function t(e){var r=u(e),n=this.fragments[r];return n?n.buffered?l(n)?i.PARTIAL:i.OK:i.APPENDING:(0,i.NOT_LOADED)},e.isTimeBuffered=function t(e,r,i){for(var n,a,s=0;s<i.length;s++){if(n=i.start(s)-this.bufferPadding,a=i.end(s)+this.bufferPadding,e>=n&&r<=a)return!0;if(r<=n)break}return!1},e.onFragLoaded=function t(e,r){var i=r.frag,n=r.part;if("initSegment"!==i.sn&&!i.bitrateTest&&!n){var a=u(i);this.fragments[a]={body:i,loaded:r,buffered:!1,range:Object.create(null)}}},e.onBufferAppended=function t(e,r){var i=this,n=r.frag,a=r.part,o=r.timeRanges;if(n.type===s.PlaylistLevelType.MAIN){if(this.activeFragment=n,a){var l=this.activeParts;l||(this.activeParts=l=[]),l.push(a)}else this.activeParts=null}this.timeRanges=o,Object.keys(o).forEach(function(t){var e=o[t];if(i.detectEvictedFragments(t,e),!a)for(var r=0;r<e.length;r++)n.appendedPTS=Math.max(e.end(r),n.appendedPTS||0)})},e.onFragBuffered=function t(e,r){this.detectPartialFragments(r)},e.hasFragment=function t(e){var r=u(e);return!!this.fragments[r]},e.removeFragmentsInRange=function t(e,r,i){var n=this;Object.keys(this.fragments).forEach(function(t){var a=n.fragments[t];if(a&&a.buffered){var s=a.body;s.type===i&&s.start<r&&s.end>e&&n.removeFragment(s)}})},e.removeFragment=function t(e){var r=u(e);e.stats.loaded=0,e.clearElementaryStreamInfo(),delete this.fragments[r]},e.removeAllFragments=function t(){this.fragments=Object.create(null),this.activeFragment=null,this.activeParts=null},t}();function l(t){var e,r;return t.buffered&&((null===(e=t.range.video)||void 0===e?void 0:e.partial)||(null===(r=t.range.audio)||void 0===r?void 0:r.partial))}function u(t){return t.type+"_"+t.level+"_"+t.urlId+"_"+t.sn}},"./src/controller/gap-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{MAX_START_GAP_JUMP:()=>l,SKIP_BUFFER_HOLE_STEP_SECONDS:()=>u,SKIP_BUFFER_RANGE_START:()=>d,STALL_MINIMUM_DURATION_MS:()=>o,default:()=>c});var i=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),n=r(/*! ../errors */ "./src/errors.ts"),a=r(/*! ../events */ "./src/events.ts"),s=r(/*! ../utils/logger */ "./src/utils/logger.ts"),o=250,l=2,u=.1,d=.05,c=function(){function t(t,e,r,i){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=r,this.hls=i}var e=t.prototype;return e.destroy=function t(){this.media=null,this.hls=this.fragmentTracker=null},e.poll=function t(e,r){var n=this.config,a=this.media,u=this.stalled;if(null!==a){var d=a.currentTime,c=a.seeking,f=this.seeking&&!c,h=!this.seeking&&c;if(this.seeking=c,d!==e){if(this.moved=!0,null!==u){if(this.stallReported){var $=self.performance.now()-u;s.logger.warn("playback not stuck anymore @"+d+", after "+Math.round($)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if((h||f)&&(this.stalled=null),(!a.paused||c)&&!a.ended&&0!==a.playbackRate&&i.BufferHelper.getBuffered(a).length){var g=i.BufferHelper.bufferInfo(a,d,0),v=g.len>0,p=g.nextStart||0;if(v||p){if(c){var m=g.len>l,x=!p||r&&r.start<=d||p-d>l&&!this.fragmentTracker.getPartialFragment(d);if(m||x)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var T,E=Math.max(p,g.start||0)-d,y=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,S=(null==y?void 0:null===(T=y.details)||void 0===T?void 0:T.live)?2*y.details.targetduration:l;if(E>0&&E<=S){this._trySkipBufferHole(null);return}}var L=self.performance.now();if(null===u){this.stalled=L;return}var b=L-u;if(c||!(b>=o)||(this._reportStall(g),this.media)){var D=i.BufferHelper.bufferInfo(a,d,n.maxBufferHole);this._tryFixBufferStall(D,b)}}}}},e._tryFixBufferStall=function t(e,r){var i=this.config,n=this.fragmentTracker,a=this.media;if(null!==a){var o=a.currentTime,l=n.getPartialFragment(o);if(l&&(this._trySkipBufferHole(l)||!this.media))return;e.len>i.maxBufferHole&&r>1e3*i.highBufferWatchdogPeriod&&(s.logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},e._reportStall=function t(e){var r=this.hls,i=this.media;!this.stallReported&&i&&(this.stallReported=!0,s.logger.warn("Playback stalling at @"+i.currentTime+" due to low buffer ("+JSON.stringify(e)+")"),r.trigger(a.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!1,buffer:e.len}))},e._trySkipBufferHole=function t(e){var r=this.config,o=this.hls,l=this.media;if(null===l)return 0;for(var c=l.currentTime,f=0,h=i.BufferHelper.getBuffered(l),$=0;$<h.length;$++){var g=h.start($);if(c+r.maxBufferHole>=f&&c<g){var v=Math.max(g+d,l.currentTime+u);return s.logger.warn("skipping hole, adjusting currentTime from "+c+" to "+v),this.moved=!0,this.stalled=null,l.currentTime=v,e&&o.trigger(a.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.BUFFER_SEEK_OVER_HOLE,fatal:!1,reason:"fragment loaded with buffer holes, seeking from "+c+" to "+v,frag:e}),v}f=h.end($)}return 0},e._tryNudgeBuffer=function t(){var e=this.config,r=this.hls,i=this.media,o=this.nudgeRetry;if(null!==i){var l=i.currentTime;if(this.nudgeRetry++,o<e.nudgeMaxRetry){var u=l+(o+1)*e.nudgeOffset;s.logger.warn("Nudging 'currentTime' from "+l+" to "+u),i.currentTime=u,r.trigger(a.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.BUFFER_NUDGE_ON_STALL,fatal:!1})}else s.logger.error("Playhead still not moving while enough data buffered @"+l+" after "+e.nudgeMaxRetry+" nudges"),r.trigger(a.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.BUFFER_STALLED_ERROR,fatal:!0})}},t}()},"./src/controller/latency-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>o});var i=r(/*! ../errors */ "./src/errors.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../utils/logger */ "./src/utils/logger.ts");function s(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var o=function(){function t(t){var e=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return e.timeupdate()},this.hls=t,this.config=t.config,this.registerListeners()}var e,r,o,l=t.prototype;return l.destroy=function t(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},l.registerListeners=function t(){this.hls.on(n.Events.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(n.Events.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(n.Events.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(n.Events.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(n.Events.ERROR,this.onError,this)},l.unregisterListeners=function t(){this.hls.off(n.Events.MEDIA_ATTACHED,this.onMediaAttached),this.hls.off(n.Events.MEDIA_DETACHING,this.onMediaDetaching),this.hls.off(n.Events.MANIFEST_LOADING,this.onManifestLoading),this.hls.off(n.Events.LEVEL_UPDATED,this.onLevelUpdated),this.hls.off(n.Events.ERROR,this.onError)},l.onMediaAttached=function t(e,r){this.media=r.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},l.onMediaDetaching=function t(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},l.onManifestLoading=function t(){this.levelDetails=null,this._latency=null,this.stallCount=0},l.onLevelUpdated=function t(e,r){var i=r.details;this.levelDetails=i,i.advanced&&this.timeupdate(),!i.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},l.onError=function t(e,r){r.details===i.ErrorDetails.BUFFER_STALLED_ERROR&&(this.stallCount++,a.logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},l.timeupdate=function t(){var e=this.media,r=this.levelDetails;if(e&&r){this.currentTime=e.currentTime;var i=this.computeLatency();if(null!==i){this._latency=i;var n=this.config,a=n.lowLatencyMode,s=n.maxLiveSyncPlaybackRate;if(a&&1!==s){var o=this.targetLatency;if(null!==o){var l=i-o,u=Math.min(this.maxLatency,o+r.targetduration);if(r.live&&l<u&&l>.05&&this.forwardBufferLength>1){var d=Math.round(2/(1+Math.exp(-.75*l-this.edgeStalled))*20)/20;e.playbackRate=Math.min(Math.min(2,Math.max(1,s)),Math.max(1,d))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}}}}},l.estimateLiveEdge=function t(){var e=this.levelDetails;return null===e?null:e.edge+e.age},l.computeLatency=function t(){var e=this.estimateLiveEdge();return null===e?null:e-this.currentTime},e=t,r=[{key:"latency",get:function t(){return this._latency||0}},{key:"maxLatency",get:function t(){var e=this.config,r=this.levelDetails;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:r?e.liveMaxLatencyDurationCount*r.targetduration:0}},{key:"targetLatency",get:function t(){var e=this.levelDetails;if(null===e)return null;var r=e.holdBack,i=e.partHoldBack,n=e.targetduration,a=this.config,s=a.liveSyncDuration,o=a.liveSyncDurationCount,l=a.lowLatencyMode,u=this.hls.userConfig,d=l&&i||r;return(u.liveSyncDuration||u.liveSyncDurationCount||0===d)&&(d=void 0!==s?s:o*n),d+Math.min(1*this.stallCount,n)}},{key:"liveSyncPosition",get:function t(){var e=this.estimateLiveEdge(),r=this.targetLatency,i=this.levelDetails;if(null===e||null===r||null===i)return null;var n,a=i.edge,s=e-r-this.edgeStalled;return Math.min(Math.max(a-i.totalduration,s),a-(this.config.lowLatencyMode&&i.partTarget||i.targetduration))}},{key:"drift",get:function t(){var e=this.levelDetails;return null===e?1:e.drift}},{key:"edgeStalled",get:function t(){var e=this.levelDetails;if(null===e)return 0;var r=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-r,0)}},{key:"forwardBufferLength",get:function t(){var e=this.media,r=this.levelDetails;if(!e||!r)return 0;var i=e.buffered.length;return(i?e.buffered.end(i-1):r.edge)-this.currentTime}}],s(e.prototype,r),o&&s(e,o),Object.defineProperty(e,"prototype",{writable:!1}),t}()},"./src/controller/level-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>$});var i=r(/*! ../types/level */ "./src/types/level.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../errors */ "./src/errors.ts"),s=r(/*! ../utils/codecs */ "./src/utils/codecs.ts"),o=r(/*! ./level-helper */ "./src/controller/level-helper.ts"),l=r(/*! ./base-playlist-controller */ "./src/controller/base-playlist-controller.ts"),u=r(/*! ../types/loader */ "./src/types/loader.ts");function d(){return(d=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function c(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function f(t,e){return(f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var h=/chrome|firefox/.test(navigator.userAgent.toLowerCase()),$=function(t){function e(e){var r;return(r=t.call(this,e,"[level-controller]")||this)._levels=[],r._firstLevel=-1,r._startLevel=void 0,r.currentLevelIndex=-1,r.manualLevelIndex=-1,r.onParsedComplete=void 0,r._registerListeners(),r}r=e,l=t,r.prototype=Object.create(l.prototype),r.prototype.constructor=r,f(r,l);var r,l,$,g,v,p=e.prototype;return p._registerListeners=function t(){var e=this.hls;e.on(n.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(n.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(n.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(n.Events.FRAG_LOADED,this.onFragLoaded,this),e.on(n.Events.ERROR,this.onError,this)},p._unregisterListeners=function t(){var e=this.hls;e.off(n.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(n.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(n.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(n.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(n.Events.ERROR,this.onError,this)},p.destroy=function e(){this._unregisterListeners(),this.manualLevelIndex=-1,this._levels.length=0,t.prototype.destroy.call(this)},p.startLoad=function e(){this._levels.forEach(function(t){t.loadError=0}),t.prototype.startLoad.call(this)},p.onManifestLoaded=function t(e,r){var l,u,d=[],c=[],f=[],$={},g=!1,v=!1,p=!1;if(r.levels.forEach(function(t){var e=t.attrs;g=g||!!(t.width&&t.height),v=v||!!t.videoCodec,p=p||!!t.audioCodec,h&&t.audioCodec&&-1!==t.audioCodec.indexOf("mp4a.40.34")&&(t.audioCodec=void 0);var r=t.bitrate+"-"+t.attrs.RESOLUTION+"-"+t.attrs.CODECS;(u=$[r])?u.url.push(t.url):(u=new i.Level(t),$[r]=u,d.push(u)),e&&(e.AUDIO&&(0,o.addGroupId)(u,"audio",e.AUDIO),e.SUBTITLES&&(0,o.addGroupId)(u,"text",e.SUBTITLES))}),(g||v)&&p&&(d=d.filter(function(t){var e=t.videoCodec,r=t.width,i=t.height;return!!e||!!(r&&i)})),d=d.filter(function(t){var e=t.audioCodec,r=t.videoCodec;return(!e||(0,s.isCodecSupportedInMp4)(e,"audio"))&&(!r||(0,s.isCodecSupportedInMp4)(r,"video"))}),r.audioTracks&&(c=r.audioTracks.filter(function(t){return!t.audioCodec||(0,s.isCodecSupportedInMp4)(t.audioCodec,"audio")}),(0,o.assignTrackIdsByGroup)(c)),r.subtitles&&(f=r.subtitles,(0,o.assignTrackIdsByGroup)(f)),d.length>0){l=d[0].bitrate,d.sort(function(t,e){return t.bitrate-e.bitrate}),this._levels=d;for(var m=0;m<d.length;m++)if(d[m].bitrate===l){this._firstLevel=m,this.log("manifest loaded, "+d.length+" level(s) found, first bitrate: "+l);break}var x=p&&!v,T={levels:d,audioTracks:c,subtitleTracks:f,firstLevel:this._firstLevel,stats:r.stats,audio:p,video:v,altAudio:!x&&c.some(function(t){return!!t.url})};this.hls.trigger(n.Events.MANIFEST_PARSED,T),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}else this.hls.trigger(n.Events.ERROR,{type:a.ErrorTypes.MEDIA_ERROR,details:a.ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:r.url,reason:"no level with compatible codecs found in manifest"})},p.onError=function e(r,i){if(t.prototype.onError.call(this,r,i),!i.fatal){var n,s,o=i.context,l=this._levels[this.currentLevelIndex];if(o&&(o.type===u.PlaylistContextType.AUDIO_TRACK&&l.audioGroupIds&&o.groupId===l.audioGroupIds[l.urlId]||o.type===u.PlaylistContextType.SUBTITLE_TRACK&&l.textGroupIds&&o.groupId===l.textGroupIds[l.urlId])){this.redundantFailover(this.currentLevelIndex);return}var d=!1,c=!0;switch(i.details){case a.ErrorDetails.FRAG_LOAD_ERROR:case a.ErrorDetails.FRAG_LOAD_TIMEOUT:case a.ErrorDetails.KEY_LOAD_ERROR:case a.ErrorDetails.KEY_LOAD_TIMEOUT:if(i.frag){var f=i.frag.type===u.PlaylistLevelType.MAIN?i.frag.level:this.currentLevelIndex,h=this._levels[f];h?(h.fragmentError++,h.fragmentError>this.hls.config.fragLoadingMaxRetry&&(s=f)):s=f}break;case a.ErrorDetails.LEVEL_LOAD_ERROR:case a.ErrorDetails.LEVEL_LOAD_TIMEOUT:o&&(o.deliveryDirectives&&(c=!1),s=o.level),d=!0;break;case a.ErrorDetails.REMUX_ALLOC_ERROR:s=null!=(n=i.level)?n:this.currentLevelIndex,d=!0}void 0!==s&&this.recoverLevel(i,s,d,c)}},p.recoverLevel=function t(e,r,i,n){var a=e.details,s=this._levels[r];if(s.loadError++,i){if(this.retryLoadingOrFail(e))e.levelRetry=!0;else{this.currentLevelIndex=-1;return}}if(n){var o=s.url.length;if(o>1&&s.loadError<o)e.levelRetry=!0,this.redundantFailover(r);else if(-1===this.manualLevelIndex){for(var l=-1,u=this._levels,d=u.length;d--;){var c=(d+this.currentLevelIndex)%u.length;if(c!==this.currentLevelIndex&&0===u[c].loadError){l=c;break}}l>-1&&this.currentLevelIndex!==l&&(this.warn(a+": switch to "+l),e.levelRetry=!0,this.hls.nextAutoLevel=l)}}},p.redundantFailover=function t(e){var r=this._levels[e],i=r.url.length;if(i>1){var n=(r.urlId+1)%i;this.warn("Switching to redundant URL-id "+n),this._levels.forEach(function(t){t.urlId=n}),this.level=e}},p.onFragLoaded=function t(e,r){var i=r.frag;if(void 0!==i&&i.type===u.PlaylistLevelType.MAIN){var n=this._levels[i.level];void 0!==n&&(n.fragmentError=0,n.loadError=0)}},p.onLevelLoaded=function t(e,r){var i,n,a=r.level,s=r.details,o=this._levels[a];if(!o){this.warn("Invalid level index "+a),null!==(n=r.deliveryDirectives)&&void 0!==n&&n.skip&&(s.deltaUpdateFailed=!0);return}a===this.currentLevelIndex?(0===o.fragmentError&&(o.loadError=0,this.retryCount=0),this.playlistLoaded(a,r,o.details)):null!==(i=r.deliveryDirectives)&&void 0!==i&&i.skip&&(s.deltaUpdateFailed=!0)},p.onAudioTrackSwitched=function t(e,r){var i=this.hls.levels[this.currentLevelIndex];if(i&&i.audioGroupIds){for(var n=-1,a=this.hls.audioTracks[r.id].groupId,s=0;s<i.audioGroupIds.length;s++)if(i.audioGroupIds[s]===a){n=s;break}n!==i.urlId&&(i.urlId=n,this.startLoad())}},p.loadPlaylist=function t(e){var r=this.currentLevelIndex,i=this._levels[r];if(this.canLoad&&i&&i.url.length>0){var a=i.urlId,s=i.url[a];if(e)try{s=e.addDirectives(s)}catch(o){this.warn("Could not construct new URL with HLS Delivery Directives: "+o)}this.log("Attempt loading level index "+r+(e?" at sn "+e.msn+" part "+e.part:"")+" with URL-id "+a+" "+s),this.clearTimer(),this.hls.trigger(n.Events.LEVEL_LOADING,{url:s,level:r,id:a,deliveryDirectives:e||null})}},p.removeLevel=function t(e,r){var i=function t(e,i){return i!==r},a=this._levels.filter(function(t,n){return n!==e||t.url.length>1&&void 0!==r&&(t.url=t.url.filter(i),t.audioGroupIds&&(t.audioGroupIds=t.audioGroupIds.filter(i)),t.textGroupIds&&(t.textGroupIds=t.textGroupIds.filter(i)),t.urlId=0,!0)}).map(function(t,e){var r=t.details;return null!=r&&r.fragments&&r.fragments.forEach(function(t){t.level=e}),t});this._levels=a,this.hls.trigger(n.Events.LEVELS_UPDATED,{levels:a})},$=e,g=[{key:"levels",get:function t(){return 0===this._levels.length?null:this._levels}},{key:"level",get:function t(){return this.currentLevelIndex},set:function t(e){var r,i=this._levels;if(0!==i.length&&(this.currentLevelIndex!==e||null===(r=i[e])||void 0===r||!r.details)){if(e<0||e>=i.length){var s=e<0;if(this.hls.trigger(n.Events.ERROR,{type:a.ErrorTypes.OTHER_ERROR,details:a.ErrorDetails.LEVEL_SWITCH_ERROR,level:e,fatal:s,reason:"invalid level idx"}),s)return;e=Math.min(e,i.length-1)}this.clearTimer();var o=this.currentLevelIndex,l=i[o],u=i[e];this.log("switching to level "+e+" from "+o),this.currentLevelIndex=e;var c=d({},u,{level:e,maxBitrate:u.maxBitrate,uri:u.uri,urlId:u.urlId});delete c._urlId,this.hls.trigger(n.Events.LEVEL_SWITCHING,c);var f=u.details;if(!f||f.live){var h=this.switchParams(u.uri,null==l?void 0:l.details);this.loadPlaylist(h)}}}},{key:"manualLevel",get:function t(){return this.manualLevelIndex},set:function t(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}},{key:"firstLevel",get:function t(){return this._firstLevel},set:function t(e){this._firstLevel=e}},{key:"startLevel",get:function t(){if(void 0!==this._startLevel)return this._startLevel;var e=this.hls.config.startLevel;return void 0!==e?e:this._firstLevel},set:function t(e){this._startLevel=e}},{key:"nextLoadLevel",get:function t(){return -1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel},set:function t(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}}],c($.prototype,g),v&&c($,v),Object.defineProperty($,"prototype",{writable:!1}),e}(l.default)},"./src/controller/level-helper.ts"(t,e,r){"use strict";r.r(e),r.d(e,{addGroupId:()=>o,addSliding:()=>v,adjustSliding:()=>g,assignTrackIdsByGroup:()=>l,computeReloadInterval:()=>p,getFragmentWithSN:()=>m,getPartWith:()=>x,mapFragmentIntersection:()=>$,mapPartIntersection:()=>h,mergeDetails:()=>f,updateFragPTSDTS:()=>c,updatePTS:()=>u});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../utils/logger */ "./src/utils/logger.ts"),a=r(/*! ../loader/date-range */ "./src/loader/date-range.ts");function s(){return(s=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function o(t,e,r){switch(e){case"audio":t.audioGroupIds||(t.audioGroupIds=[]),t.audioGroupIds.push(r);break;case"text":t.textGroupIds||(t.textGroupIds=[]),t.textGroupIds.push(r)}}function l(t){var e={};t.forEach(function(t){var r=t.groupId||"";t.id=e[r]=e[r]||0,e[r]++})}function u(t,e,r){var i;d(t[e],t[r])}function d(t,e){var r=e.startPTS;if((0,i.isFiniteNumber)(r)){var n,a=0;e.sn>t.sn?(a=r-t.start,n=t):(a=t.start-r,n=e),n.duration!==a&&(n.duration=a)}else e.sn>t.sn?t.cc===e.cc&&t.minEndPTS?e.start=t.start+(t.minEndPTS-t.start):e.start=t.start+t.duration:e.start=Math.max(t.start-e.duration,0)}function c(t,e,r,a,s,o){a-r<=0&&(n.logger.warn("Fragment should have a positive duration",e),a=r+e.duration,o=s+e.duration);var l,u=r,c=a,f=e.startPTS,h=e.endPTS;if((0,i.isFiniteNumber)(f)){var $=Math.abs(f-r);(0,i.isFiniteNumber)(e.deltaPTS)?e.deltaPTS=Math.max($,e.deltaPTS):e.deltaPTS=$,u=Math.max(r,f),r=Math.min(r,f),s=Math.min(s,e.startDTS),c=Math.min(a,h),a=Math.max(a,h),o=Math.max(o,e.endDTS)}e.duration=a-r;var g=r-e.start;e.appendedPTS=a,e.start=e.startPTS=r,e.maxStartPTS=u,e.startDTS=s,e.endPTS=a,e.minEndPTS=c,e.endDTS=o;var v=e.sn;if(!t||v<t.startSN||v>t.endSN)return 0;var p=v-t.startSN,m=t.fragments;for(m[p]=e,l=p;l>0;l--)d(m[l],m[l-1]);for(l=p;l<m.length-1;l++)d(m[l],m[l+1]);return t.fragmentHint&&d(m[m.length-1],t.fragmentHint),t.PTSKnown=t.alignedSliding=!0,g}function f(t,e){for(var r,o=null,l=t.fragments,u=l.length-1;u>=0;u--){var d=l[u].initSegment;if(d){o=d;break}}t.fragmentHint&&delete t.fragmentHint.endPTS;var f=0;if($(t,e,function(t,n){t.relurl&&(f=t.cc-n.cc),(0,i.isFiniteNumber)(t.startPTS)&&(0,i.isFiniteNumber)(t.endPTS)&&(n.start=n.startPTS=t.startPTS,n.startDTS=t.startDTS,n.appendedPTS=t.appendedPTS,n.maxStartPTS=t.maxStartPTS,n.endPTS=t.endPTS,n.endDTS=t.endDTS,n.minEndPTS=t.minEndPTS,n.duration=t.endPTS-t.startPTS,n.duration&&(r=n),e.PTSKnown=e.alignedSliding=!0),n.elementaryStreams=t.elementaryStreams,n.loader=t.loader,n.stats=t.stats,n.urlId=t.urlId,t.initSegment&&(n.initSegment=t.initSegment,o=t.initSegment)}),o&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(function(t){var e;t.initSegment&&t.initSegment.relurl!==(null===(e=o)||void 0===e?void 0:e.relurl)||(t.initSegment=o)}),e.skippedSegments){if(e.deltaUpdateFailed=e.fragments.some(function(t){return!t}),e.deltaUpdateFailed){n.logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var v,p,m,x,T=e.skippedSegments;T--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else{e.canSkipDateRanges&&(e.dateRanges=(v=t.dateRanges,p=e.dateRanges,m=e.recentlyRemovedDateranges,x=s({},v),m&&m.forEach(function(t){delete x[t]}),Object.keys(p).forEach(function(t){var e=new a.DateRange(p[t].attr,x[t]);e.isValid?x[t]=e:n.logger.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+JSON.stringify(p[t].attr)+'"')}),x))}}var E=e.fragments;if(f){n.logger.warn("discontinuity sliding from playlist, take drift into account");for(var y=0;y<E.length;y++)E[y].cc+=f}e.skippedSegments&&(e.startCC=e.fragments[0].cc),h(t.partList,e.partList,function(t,e){e.elementaryStreams=t.elementaryStreams,e.stats=t.stats}),r?c(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):g(t,e),E.length&&(e.totalduration=e.edge-E[0].start),e.driftStartTime=t.driftStartTime,e.driftStart=t.driftStart;var S=e.advancedDateTime;if(e.advanced&&S){var L=e.edge;e.driftStart||(e.driftStartTime=S,e.driftStart=L),e.driftEndTime=S,e.driftEnd=L}else e.driftEndTime=t.driftEndTime,e.driftEnd=t.driftEnd,e.advancedDateTime=t.advancedDateTime}function h(t,e,r){if(t&&e)for(var i=0,n=0,a=t.length;n<=a;n++){var s=t[n],o=e[n+i];s&&o&&s.index===o.index&&s.fragment.sn===o.fragment.sn?r(s,o):i--}}function $(t,e,r){for(var i=e.skippedSegments,n=Math.max(t.startSN,e.startSN)-e.startSN,a=(t.fragmentHint?1:0)+(i?e.endSN:Math.min(t.endSN,e.endSN))-e.startSN,s=e.startSN-t.startSN,o=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,u=n;u<=a;u++){var d=l[s+u],c=o[u];i&&!c&&u<i&&(c=e.fragments[u]=d),d&&c&&r(d,c)}}function g(t,e){var r=e.startSN+e.skippedSegments-t.startSN,i=t.fragments;!(r<0)&&!(r>=i.length)&&v(e,i[r].start)}function v(t,e){if(e){for(var r=t.fragments,i=t.skippedSegments;i<r.length;i++)r[i].start+=e;t.fragmentHint&&(t.fragmentHint.start+=e)}}function p(t,e){var r,i=1e3*t.levelTargetDuration,n=i/2,a=t.age,s=a>0&&a<3*i,o=e.loading.end-e.loading.start,l=t.availabilityDelay;return!1===t.updated?s?(r=Math.max(Math.min(n,2*o),333*t.misses),t.availabilityDelay=(t.availabilityDelay||0)+r):r=n:s?(l=Math.min(l||i/2,a),t.availabilityDelay=l,r=l+i-a):r=i-o,Math.round(r)}function m(t,e,r){if(!t||!t.details)return null;var i=t.details,n=i.fragments[e-i.startSN];return n||(n=i.fragmentHint)&&n.sn===e?n:e<i.startSN&&r&&r.sn===e?r:null}function x(t,e,r){if(!t||!t.details)return null;var i=t.details.partList;if(i)for(var n=i.length;n--;){var a=i[n];if(a.index===r&&a.fragment.sn===e)return a}return null}},"./src/controller/stream-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>p});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./base-stream-controller */ "./src/controller/base-stream-controller.ts"),a=r(/*! ../is-supported */ "./src/is-supported.ts"),s=r(/*! ../events */ "./src/events.ts"),o=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),l=r(/*! ./fragment-tracker */ "./src/controller/fragment-tracker.ts"),u=r(/*! ../types/loader */ "./src/types/loader.ts"),d=r(/*! ../loader/fragment */ "./src/loader/fragment.ts"),c=r(/*! ../demux/transmuxer-interface */ "./src/demux/transmuxer-interface.ts"),f=r(/*! ../types/transmuxer */ "./src/types/transmuxer.ts"),h=r(/*! ./gap-controller */ "./src/controller/gap-controller.ts"),$=r(/*! ../errors */ "./src/errors.ts");function g(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function v(t,e){return(v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var p=function(t){function e(e,r){var i;return(i=t.call(this,e,r,"[stream-controller]")||this).audioCodecSwap=!1,i.gapController=null,i.level=-1,i._forceStartLoad=!1,i.altAudio=!1,i.audioOnly=!1,i.fragPlaying=null,i.onvplaying=null,i.onvseeked=null,i.fragLastKbps=0,i.couldBacktrack=!1,i.backtrackFragment=null,i.audioCodecSwitch=!1,i.videoBuffer=null,i._registerListeners(),i}r=e,p=t,r.prototype=Object.create(p.prototype),r.prototype.constructor=r,v(r,p);var r,p,m,x,T,E=e.prototype;return E._registerListeners=function t(){var e=this.hls;e.on(s.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(s.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(s.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(s.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(s.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(s.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(s.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(s.Events.ERROR,this.onError,this),e.on(s.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(s.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(s.Events.BUFFER_CREATED,this.onBufferCreated,this),e.on(s.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(s.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(s.Events.FRAG_BUFFERED,this.onFragBuffered,this)},E._unregisterListeners=function t(){var e=this.hls;e.off(s.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(s.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(s.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(s.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(s.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(s.Events.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(s.Events.ERROR,this.onError,this),e.off(s.Events.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(s.Events.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(s.Events.BUFFER_CREATED,this.onBufferCreated,this),e.off(s.Events.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(s.Events.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(s.Events.FRAG_BUFFERED,this.onFragBuffered,this)},E.onHandlerDestroying=function t(){this._unregisterListeners(),this.onMediaDetaching()},E.startLoad=function t(e){if(this.levels){var r=this.lastCurrentTime,i=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,this.fragLoadError=0,!this.startFragRequested){var a=i.startLevel;-1===a&&(i.config.testBandwidth&&this.levels.length>1?(a=0,this.bitrateTest=!0):a=i.nextAutoLevel),this.level=i.nextLoadLevel=a,this.loadedmetadata=!1}r>0&&-1===e&&(this.log("Override startPosition with lastCurrentTime @"+r.toFixed(3)),e=r),this.state=n.State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=n.State.STOPPED},E.stopLoad=function e(){this._forceStartLoad=!1,t.prototype.stopLoad.call(this)},E.doTick=function t(){switch(this.state){case n.State.IDLE:this.doTickIdle();break;case n.State.WAITING_LEVEL:var e,r=this.levels,i=this.level,a=null==r?void 0:null===(e=r[i])||void 0===e?void 0:e.details;if(a&&(!a.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(a))break;this.state=n.State.IDLE}break;case n.State.FRAG_LOADING_WAITING_RETRY:var s,o=self.performance.now(),l=this.retryDate;(!l||o>=l||null!==(s=this.media)&&void 0!==s&&s.seeking)&&(this.log("retryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.level),this.state=n.State.IDLE)}this.onTickEnd()},E.onTickEnd=function e(){t.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},E.doTickIdle=function t(){var e=this.hls,r=this.levelLastLoaded,i=this.levels,a=this.media,o=e.config,c=e.nextLoadLevel;if(null!==r&&(a||!this.startFragRequested&&o.startFragPrefetch)&&(!this.altAudio||!this.audioOnly)&&i&&i[c]){var f=i[c];this.level=e.nextLoadLevel=c;var h=f.details;if(!h||this.state===n.State.WAITING_LEVEL||h.live&&this.levelLastLoaded!==c){this.state=n.State.WAITING_LEVEL;return}var $=this.getMainFwdBufferInfo();if(null!==$){if(!($.len>=this.getMaxBufferLength(f.maxBitrate))){if(this._streamEnded($,h)){var g={};this.altAudio&&(g.type="video"),this.hls.trigger(s.Events.BUFFER_EOS,g),this.state=n.State.ENDED;return}this.backtrackFragment&&this.backtrackFragment.start>$.end&&(this.backtrackFragment=null);var v=this.backtrackFragment?this.backtrackFragment.start:$.end,p=this.getNextFragment(v,h);if(this.couldBacktrack&&!this.fragPrevious&&p&&"initSegment"!==p.sn&&this.fragmentTracker.getState(p)!==l.FragmentState.OK){var m,x,T,E,y=(null!=(E=this.backtrackFragment)?E:p).sn-h.startSN,S=h.fragments[y-1];S&&p.cc===S.cc&&(p=S,this.fragmentTracker.removeFragment(S))}else this.backtrackFragment&&$.len&&(this.backtrackFragment=null);if(p&&this.fragmentTracker.getState(p)===l.FragmentState.OK&&this.nextLoadPosition>v){var L=this.audioOnly&&!this.altAudio?d.ElementaryStreamTypes.AUDIO:d.ElementaryStreamTypes.VIDEO;a&&this.afterBufferFlushed(a,L,u.PlaylistLevelType.MAIN),p=this.getNextFragment(this.nextLoadPosition,h)}p&&(!p.initSegment||p.initSegment.data||this.bitrateTest||(p=p.initSegment),(null===(x=p.decryptdata)||void 0===x?void 0:x.keyFormat)!=="identity"||null!==(T=p.decryptdata)&&void 0!==T&&T.key?this.loadFragment(p,h,v):this.loadKey(p,h))}}}},E.loadFragment=function e(r,i,n){var a,s=this.fragmentTracker.getState(r);this.fragCurrent=r,s===l.FragmentState.NOT_LOADED?"initSegment"===r.sn?this._loadInitSegment(r):this.bitrateTest?(this.log("Fragment "+r.sn+" of level "+r.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(r)):(this.startFragRequested=!0,t.prototype.loadFragment.call(this,r,i,n)):s===l.FragmentState.APPENDING?this.reduceMaxBufferLength(r.duration)&&this.fragmentTracker.removeFragment(r):(null===(a=this.media)||void 0===a?void 0:a.buffered.length)===0&&this.fragmentTracker.removeAllFragments()},E.getAppendedFrag=function t(e){var r=this.fragmentTracker.getAppendedFrag(e,u.PlaylistLevelType.MAIN);return r&&"fragment"in r?r.fragment:r},E.getBufferedFrag=function t(e){return this.fragmentTracker.getBufferedFrag(e,u.PlaylistLevelType.MAIN)},E.followingBufferedFrag=function t(e){return e?this.getBufferedFrag(e.end+.5):null},E.immediateLevelSwitch=function t(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},E.nextLevelSwitch=function t(){var e=this.levels,r=this.media;if(null!=r&&r.readyState){var i,n=this.getAppendedFrag(r.currentTime);if(n&&n.start>1&&this.flushMainBuffer(0,n.start-1),!r.paused&&e){var a=e[this.hls.nextLoadLevel],s=this.fragLastKbps;i=s&&this.fragCurrent?this.fragCurrent.duration*a.maxBitrate/(1e3*s)+1:0}else i=0;var o=this.getBufferedFrag(r.currentTime+i);if(o){var l=this.followingBufferedFrag(o);if(l){this.abortCurrentFrag();var u=l.maxStartPTS?l.maxStartPTS:l.start,d=l.duration,c=Math.max(o.end,u+Math.min(Math.max(d-this.config.maxFragLookUpTolerance,.5*d),.75*d));this.flushMainBuffer(c,Number.POSITIVE_INFINITY)}}}},E.abortCurrentFrag=function t(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,null!=e&&e.loader&&e.loader.abort(),this.state){case n.State.KEY_LOADING:case n.State.FRAG_LOADING:case n.State.FRAG_LOADING_WAITING_RETRY:case n.State.PARSING:case n.State.PARSED:this.state=n.State.IDLE}this.nextLoadPosition=this.getLoadPosition()},E.flushMainBuffer=function e(r,i){t.prototype.flushMainBuffer.call(this,r,i,this.altAudio?"video":null)},E.onMediaAttached=function e(r,i){t.prototype.onMediaAttached.call(this,r,i);var n=i.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new h.default(this.config,n,this.fragmentTracker,this.hls)},E.onMediaDetaching=function e(){var r=this.media;r&&this.onvplaying&&this.onvseeked&&(r.removeEventListener("playing",this.onvplaying),r.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),t.prototype.onMediaDetaching.call(this)},E.onMediaPlaying=function t(){this.tick()},E.onMediaSeeked=function t(){var e=this.media,r=e?e.currentTime:null;(0,i.isFiniteNumber)(r)&&this.log("Media seeked to "+r.toFixed(3)),this.tick()},E.onManifestLoading=function t(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(s.Events.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.fragPlaying=null,this.backtrackFragment=null},E.onManifestParsed=function t(e,r){var i,n=!1,s=!1;r.levels.forEach(function(t){(i=t.audioCodec)&&(-1!==i.indexOf("mp4a.40.2")&&(n=!0),-1!==i.indexOf("mp4a.40.5")&&(s=!0))}),this.audioCodecSwitch=n&&s&&!(0,a.changeTypeSupported)(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=r.levels,this.startFragRequested=!1},E.onLevelLoading=function t(e,r){var i=this.levels;if(i&&this.state===n.State.IDLE){var a=i[r.level];(!a.details||a.details.live&&this.levelLastLoaded!==r.level||this.waitForCdnTuneIn(a.details))&&(this.state=n.State.WAITING_LEVEL)}},E.onLevelLoaded=function t(e,r){var i,a=this.levels,o=r.level,l=r.details,u=l.totalduration;if(!a){this.warn("Levels were reset while loading level "+o);return}this.log("Level "+o+" loaded ["+l.startSN+","+l.endSN+"], cc ["+l.startCC+", "+l.endCC+"] duration:"+u);var d=this.fragCurrent;d&&(this.state===n.State.FRAG_LOADING||this.state===n.State.FRAG_LOADING_WAITING_RETRY)&&d.level!==r.level&&d.loader&&(this.state=n.State.IDLE,this.backtrackFragment=null,d.loader.abort());var c=a[o],f=0;if(l.live||null!==(i=c.details)&&void 0!==i&&i.live){if(l.fragments[0]||(l.deltaUpdateFailed=!0),l.deltaUpdateFailed)return;f=this.alignPlaylists(l,c.details)}if(c.details=l,this.levelLastLoaded=o,this.hls.trigger(s.Events.LEVEL_UPDATED,{details:l,level:o}),this.state===n.State.WAITING_LEVEL){if(this.waitForCdnTuneIn(l))return;this.state=n.State.IDLE}this.startFragRequested?l.live&&this.synchronizeToLiveEdge(l):this.setStartPosition(l,f),this.tick()},E._handleFragmentLoadProgress=function t(e){var r,i=e.frag,n=e.part,a=e.payload,s=this.levels;if(!s){this.warn("Levels were reset while fragment load was in progress. Fragment "+i.sn+" of level "+i.level+" will not be buffered");return}var o=s[i.level],l=o.details;if(!l){this.warn("Dropping fragment "+i.sn+" of level "+i.level+" after level details were reset");return}var d=o.videoCodec,h=l.PTSKnown||!l.live,$=null===(r=i.initSegment)||void 0===r?void 0:r.data,g=this._getAudioCodec(o),v=this.transmuxer=this.transmuxer||new c.default(this.hls,u.PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),p=n?n.index:-1,m=new f.ChunkMetadata(i.level,i.sn,i.stats.chunkCount,a.byteLength,p,-1!==p),x=this.initPTS[i.cc];v.push(a,$,g,d,i,n,l.totalduration,h,m,x)},E.onAudioTrackSwitching=function t(e,r){var i=this.altAudio,n=!!r.url,a=r.id;if(!n){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var o=this.fragCurrent;null!=o&&o.loader&&(this.log("Switching to main audio track, cancel main fragment load"),o.loader.abort()),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var l=this.hls;i&&l.trigger(s.Events.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:"audio"}),l.trigger(s.Events.AUDIO_TRACK_SWITCHED,{id:a})}},E.onAudioTrackSwitched=function t(e,r){var i=r.id,n=!!this.hls.audioTracks[i].url;if(n){var a=this.videoBuffer;a&&this.mediaBuffer!==a&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=a)}this.altAudio=n,this.tick()},E.onBufferCreated=function t(e,r){var i,n,a=r.tracks,s=!1;for(var o in a){var l=a[o];if("main"===l.id){if(n=o,i=l,"video"===o){var u=a[o];u&&(this.videoBuffer=u.buffer)}}else s=!0}s&&i?(this.log("Alternate track found, use "+n+".buffered to schedule main fragment loading"),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media},E.onFragBuffered=function t(e,r){var i=r.frag,a=r.part;if(!i||i.type===u.PlaylistLevelType.MAIN){if(this.fragContextChanged(i)){this.warn("Fragment "+i.sn+(a?" p: "+a.index:"")+" of level "+i.level+" finished buffering, but was aborted. state: "+this.state),this.state===n.State.PARSED&&(this.state=n.State.IDLE);return}var s=a?a.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,a)}},E.onError=function t(e,r){switch(r.details){case $.ErrorDetails.FRAG_LOAD_ERROR:case $.ErrorDetails.FRAG_LOAD_TIMEOUT:case $.ErrorDetails.KEY_LOAD_ERROR:case $.ErrorDetails.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(u.PlaylistLevelType.MAIN,r);break;case $.ErrorDetails.LEVEL_LOAD_ERROR:case $.ErrorDetails.LEVEL_LOAD_TIMEOUT:this.state===n.State.ERROR||(r.fatal?(this.warn(""+r.details),this.state=n.State.ERROR):r.levelRetry||this.state!==n.State.WAITING_LEVEL||(this.state=n.State.IDLE));break;case $.ErrorDetails.BUFFER_FULL_ERROR:if("main"===r.parent&&(this.state===n.State.PARSING||this.state===n.State.PARSED)){var i=!0,a=this.getFwdBufferInfo(this.media,u.PlaylistLevelType.MAIN);a&&a.len>.5&&(i=!this.reduceMaxBufferLength(a.len)),i&&(this.warn("buffer full error also media.currentTime is not buffered, flush main"),this.immediateLevelSwitch()),this.resetLoadingState()}}},E.checkBuffer=function t(){var e=this.media,r=this.gapController;if(e&&r&&e.readyState){if(this.loadedmetadata||!o.BufferHelper.getBuffered(e).length){var i=this.state!==n.State.IDLE?this.fragCurrent:null;r.poll(this.lastCurrentTime,i)}this.lastCurrentTime=e.currentTime}},E.onFragLoadEmergencyAborted=function t(){this.state=n.State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},E.onBufferFlushed=function t(e,r){var i=r.type;if(i!==d.ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){var n=(i===d.ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(n,i,u.PlaylistLevelType.MAIN)}},E.onLevelsUpdated=function t(e,r){this.levels=r.levels},E.swapAudioCodec=function t(){this.audioCodecSwap=!this.audioCodecSwap},E.seekToStartPos=function t(){var e=this.media;if(e){var r=e.currentTime,i=this.startPosition;if(i>=0&&r<i){if(e.seeking){this.log("could not seek to "+i+", already seeking at "+r);return}var n=o.BufferHelper.getBuffered(e),a=(n.length?n.start(0):0)-i;a>0&&(a<this.config.maxBufferHole||a<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+a+" to match buffer start"),i+=a,this.startPosition=i),this.log("seek to target start position "+i+" from current time "+r),e.currentTime=i}}},E._getAudioCodec=function t(e){var r=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&r&&(this.log("Swapping audio codec"),r=-1!==r.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),r},E._loadBitrateTestFrag=function t(e){var r=this;e.bitrateTest=!0,this._doFragLoad(e).then(function(t){var i=r.hls;if(!(!t||i.nextLoadLevel||r.fragContextChanged(e))){r.fragLoadError=0,r.state=n.State.IDLE,r.startFragRequested=!1,r.bitrateTest=!1;var a=e.stats;a.parsing.start=a.parsing.end=a.buffering.start=a.buffering.end=self.performance.now(),i.trigger(s.Events.FRAG_LOADED,t),e.bitrateTest=!1}})},E._handleTransmuxComplete=function t(e){var r,a="main",o=this.hls,l=e.remuxResult,u=e.chunkMeta,c=this.getCurrentContext(u);if(!c){this.warn("The loading context changed while buffering fragment "+u.sn+" of level "+u.level+". This chunk will not be buffered."),this.resetStartWhenNotLoaded(u.level);return}var f=c.frag,h=c.part,$=c.level,g=l.video,v=l.text,p=l.id3,m=l.initSegment,x=$.details,T=this.altAudio?void 0:l.audio;if(!this.fragContextChanged(f)){if(this.state=n.State.PARSING,m){m.tracks&&(this._bufferInitSegment($,m.tracks,f,u),o.trigger(s.Events.FRAG_PARSING_INIT_SEGMENT,{frag:f,id:a,tracks:m.tracks}));var E=m.initPTS,y=m.timescale;(0,i.isFiniteNumber)(E)&&(this.initPTS[f.cc]=E,o.trigger(s.Events.INIT_PTS_FOUND,{frag:f,id:a,initPTS:E,timescale:y}))}if(g&&!1!==l.independent){if(x){var S=g.startPTS,L=g.endPTS,b=g.startDTS,D=g.endDTS;if(h)h.elementaryStreams[g.type]={startPTS:S,endPTS:L,startDTS:b,endDTS:D};else if(g.firstKeyFrame&&g.independent&&(this.couldBacktrack=!0),g.dropped&&g.independent){var _,k=this.getMainFwdBufferInfo();if((k?k.end:this.getLoadPosition())+this.config.maxBufferHole<(g.firstKeyFramePTS?g.firstKeyFramePTS:S)-this.config.maxBufferHole){this.backtrack(f);return}f.setElementaryStreamInfo(g.type,f.start,L,f.start,D,!0)}f.setElementaryStreamInfo(g.type,S,L,b,D),this.backtrackFragment&&(this.backtrackFragment=f),this.bufferFragmentData(g,f,h,u)}}else if(!1===l.independent){this.backtrack(f);return}if(T){var A=T.startPTS,I=T.endPTS,R=T.startDTS,C=T.endDTS;h&&(h.elementaryStreams[d.ElementaryStreamTypes.AUDIO]={startPTS:A,endPTS:I,startDTS:R,endDTS:C}),f.setElementaryStreamInfo(d.ElementaryStreamTypes.AUDIO,A,I,R,C),this.bufferFragmentData(T,f,h,u)}if(x&&null!=p&&null!==(r=p.samples)&&void 0!==r&&r.length){var w={id:a,frag:f,details:x,samples:p.samples};o.trigger(s.Events.FRAG_PARSING_METADATA,w)}if(x&&v){var P={id:a,frag:f,details:x,samples:v.samples};o.trigger(s.Events.FRAG_PARSING_USERDATA,P)}}},E._bufferInitSegment=function t(e,r,i,a){var o=this;if(this.state===n.State.PARSING){this.audioOnly=!!r.audio&&!r.video,this.altAudio&&!this.audioOnly&&delete r.audio;var l=r.audio,u=r.video,d=r.audiovideo;if(l){var c=e.audioCodec,f=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(c&&(c=-1!==c.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==l.metadata.channelCount&&-1===f.indexOf("firefox")&&(c="mp4a.40.5")),-1!==f.indexOf("android")&&"audio/mpeg"!==l.container&&(c="mp4a.40.2",this.log("Android: force audio codec to "+c)),e.audioCodec&&e.audioCodec!==c&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+c+'"'),l.levelCodec=c,l.id="main",this.log("Init audio buffer, container:"+l.container+", codecs[selected/level/parsed]=["+(c||"")+"/"+(e.audioCodec||"")+"/"+l.codec+"]")}u&&(u.levelCodec=e.videoCodec,u.id="main",this.log("Init video buffer, container:"+u.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+u.codec+"]")),d&&this.log("Init audiovideo buffer, container:"+d.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+d.codec+"]"),this.hls.trigger(s.Events.BUFFER_CODECS,r),Object.keys(r).forEach(function(t){var e=r[t].initSegment;null!=e&&e.byteLength&&o.hls.trigger(s.Events.BUFFER_APPENDING,{type:t,data:e,frag:i,part:null,chunkMeta:a,parent:i.type})}),this.tick()}},E.getMainFwdBufferInfo=function t(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,u.PlaylistLevelType.MAIN)},E.backtrack=function t(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=n.State.IDLE},E.checkFragmentChanged=function t(){var e=this.media,r=null;if(e&&e.readyState>1&&!1===e.seeking){var i=e.currentTime;if(o.BufferHelper.isBuffered(e,i)?r=this.getAppendedFrag(i):o.BufferHelper.isBuffered(e,i+.1)&&(r=this.getAppendedFrag(i+.1)),r){this.backtrackFragment=null;var n=this.fragPlaying,a=r.level;n&&r.sn===n.sn&&n.level===a&&r.urlId===n.urlId||(this.hls.trigger(s.Events.FRAG_CHANGED,{frag:r}),n&&n.level===a||this.hls.trigger(s.Events.LEVEL_SWITCHED,{level:a}),this.fragPlaying=r)}}},m=e,x=[{key:"nextLevel",get:function t(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function t(){var e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}},{key:"currentProgramDateTime",get:function t(){var e=this.media;if(e){var r=e.currentTime,n=this.currentFrag;if(n&&(0,i.isFiniteNumber)(r)&&(0,i.isFiniteNumber)(n.programDateTime)){var a=n.programDateTime+(r-n.start)*1e3;return new Date(a)}}return null}},{key:"currentLevel",get:function t(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function t(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function t(){return this._forceStartLoad}}],g(m.prototype,x),T&&g(m,T),Object.defineProperty(m,"prototype",{writable:!1}),e}(n.default)},"./src/controller/subtitle-stream-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{SubtitleStreamController:()=>$});var i=r(/*! ../events */ "./src/events.ts"),n=r(/*! ../utils/buffer-helper */ "./src/utils/buffer-helper.ts"),a=r(/*! ./fragment-finders */ "./src/controller/fragment-finders.ts"),s=r(/*! ../utils/discontinuities */ "./src/utils/discontinuities.ts"),o=r(/*! ./level-helper */ "./src/controller/level-helper.ts"),l=r(/*! ./fragment-tracker */ "./src/controller/fragment-tracker.ts"),u=r(/*! ./base-stream-controller */ "./src/controller/base-stream-controller.ts"),d=r(/*! ../types/loader */ "./src/types/loader.ts"),c=r(/*! ../types/level */ "./src/types/level.ts");function f(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function h(t,e){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var $=function(t){function e(e,r){var i;return(i=t.call(this,e,r,"[subtitle-stream-controller]")||this).levels=[],i.currentTrackId=-1,i.tracksBuffered=[],i.mainDetails=null,i._registerListeners(),i}r=e,$=t,r.prototype=Object.create($.prototype),r.prototype.constructor=r,h(r,$);var r,$,v,p,m,x=e.prototype;return x.onHandlerDestroying=function t(){this._unregisterListeners(),this.mainDetails=null},x._registerListeners=function t(){var e=this.hls;e.on(i.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(i.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.on(i.Events.ERROR,this.onError,this),e.on(i.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(i.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(i.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(i.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(i.Events.FRAG_BUFFERED,this.onFragBuffered,this)},x._unregisterListeners=function t(){var e=this.hls;e.off(i.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(i.Events.LEVEL_LOADED,this.onLevelLoaded,this),e.off(i.Events.ERROR,this.onError,this),e.off(i.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(i.Events.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(i.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(i.Events.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(i.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(i.Events.FRAG_BUFFERED,this.onFragBuffered,this)},x.startLoad=function t(e){this.stopLoad(),this.state=u.State.IDLE,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},x.onManifestLoading=function t(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},x.onLevelLoaded=function t(e,r){this.mainDetails=r.details},x.onSubtitleFragProcessed=function t(e,r){var i,n=r.frag,a=r.success;if(this.fragPrevious=n,this.state=u.State.IDLE,a){var s=this.tracksBuffered[this.currentTrackId];if(s){for(var o=n.start,l=0;l<s.length;l++)if(o>=s[l].start&&o<=s[l].end){i=s[l];break}var d=n.start+n.duration;i?i.end=d:(i={start:o,end:d},s.push(i)),this.fragmentTracker.fragBuffered(n)}}},x.onBufferFlushing=function t(e,r){var i=r.startOffset,n=r.endOffset;if(0===i&&n!==Number.POSITIVE_INFINITY){var a=this.currentTrackId,s=this.levels;if(!s.length||!s[a]||!s[a].details)return;var o=n-s[a].details.targetduration;if(o<=0)return;r.endOffsetSubtitles=Math.max(0,o),this.tracksBuffered.forEach(function(t){for(var e=0;e<t.length;){if(t[e].end<=o){t.shift();continue}if(t[e].start<o)t[e].start=o;else break;e++}}),this.fragmentTracker.removeFragmentsInRange(i,o,d.PlaylistLevelType.SUBTITLE)}},x.onFragBuffered=function t(e,r){if(!this.loadedmetadata&&r.frag.type===d.PlaylistLevelType.MAIN){var i;null!==(i=this.media)&&void 0!==i&&i.buffered.length&&(this.loadedmetadata=!0)}},x.onError=function t(e,r){var i,n=r.frag;n&&n.type===d.PlaylistLevelType.SUBTITLE&&(null!==(i=this.fragCurrent)&&void 0!==i&&i.loader&&this.fragCurrent.loader.abort(),this.state=u.State.IDLE)},x.onSubtitleTracksUpdated=function t(e,r){var i=this,n=r.subtitleTracks;this.tracksBuffered=[],this.levels=n.map(function(t){return new c.Level(t)}),this.fragmentTracker.removeAllFragments(),this.fragPrevious=null,this.levels.forEach(function(t){i.tracksBuffered[t.id]=[]}),this.mediaBuffer=null},x.onSubtitleTrackSwitch=function t(e,r){if(this.currentTrackId=r.id,!this.levels.length||-1===this.currentTrackId){this.clearInterval();return}var i=this.levels[this.currentTrackId];null!=i&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.setInterval(500)},x.onSubtitleTrackLoaded=function t(e,r){var i,n=r.details,l=r.id,d=this.currentTrackId,c=this.levels;if(c.length){var f=c[d];if(!(l>=c.length)&&l===d&&f){this.mediaBuffer=this.mediaBufferTimeRanges;var h=0;if(n.live||null!==(i=f.details)&&void 0!==i&&i.live){var $=this.mainDetails;if(n.deltaUpdateFailed||!$)return;var g=$.fragments[0];f.details?0===(h=this.alignPlaylists(n,f.details))&&g&&(h=g.start,(0,o.addSliding)(n,h)):n.hasProgramDateTime&&$.hasProgramDateTime?((0,s.alignMediaPlaylistByPDT)(n,$),h=n.fragments[0].start):g&&(h=g.start,(0,o.addSliding)(n,h))}f.details=n,this.levelLastLoaded=l,this.startFragRequested||!this.mainDetails&&n.live||this.setStartPosition(f.details,h),this.tick(),n.live&&!this.fragCurrent&&this.media&&this.state===u.State.IDLE&&((0,a.findFragmentByPTS)(null,n.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),f.details=void 0))}}},x._handleFragmentLoadComplete=function t(e){var r=e.frag,n=e.payload,a=r.decryptdata,s=this.hls;if(!this.fragContextChanged(r)&&n&&n.byteLength>0&&a&&a.key&&a.iv&&"AES-128"===a.method){var o=performance.now();this.decrypter.webCryptoDecrypt(new Uint8Array(n),a.key.buffer,a.iv.buffer).then(function(t){var e=performance.now();s.trigger(i.Events.FRAG_DECRYPTED,{frag:r,payload:t,stats:{tstart:o,tdecrypt:e}})})}},x.doTick=function t(){if(!this.media){this.state=u.State.IDLE;return}if(this.state===u.State.IDLE){var e,r=this.currentTrackId,i=this.levels;if(!i.length||!i[r]||!i[r].details)return;var s=i[r].details,o=s.targetduration,c=this.config,f=this.getLoadPosition(),h=n.BufferHelper.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],f-o,c.maxBufferHole),$=h.end,g=h.len,v=this.getFwdBufferInfo(this.media,d.PlaylistLevelType.MAIN);if(g>this.getMaxBufferLength(null==v?void 0:v.len)+o)return;console.assert(s,"Subtitle track details are defined on idle subtitle stream controller tick");var p=s.fragments,m=p.length,x=s.edge,T=this.fragPrevious;if($<x){var E=c.maxFragLookUpTolerance;(e=(0,a.findFragmentByPTS)(T,p,Math.max(p[0].start,$),E))||!T||!(T.start<p[0].start)||(e=p[0])}else e=p[m-1];if(!(e=this.mapToInitFragWhenRequired(e))||this.fragmentTracker.getState(e)!==l.FragmentState.NOT_LOADED)return;e.encrypted?this.loadKey(e,s):this.loadFragment(e,s,$)}},x.getMaxBufferLength=function e(r){var i=t.prototype.getMaxBufferLength.call(this);return r?Math.max(i,r):i},x.loadFragment=function e(r,i,n){this.fragCurrent=r,"initSegment"===r.sn?this._loadInitSegment(r):(this.startFragRequested=!0,t.prototype.loadFragment.call(this,r,i,n))},v=e,p=[{key:"mediaBufferTimeRanges",get:function t(){return new g(this.tracksBuffered[this.currentTrackId]||[])}}],f(v.prototype,p),m&&f(v,m),Object.defineProperty(v,"prototype",{writable:!1}),e}(u.default),g=function t(e){this.buffered=void 0;var r=function t(r,i,n){if((i>>>=0)>n-1)throw new DOMException("Failed to execute '"+r+"' on 'TimeRanges': The index provided ("+i+") is greater than the maximum bound ("+n+")");return e[i][r]};this.buffered={get length(){return e.length},end:function t(i){return r("end",i,e.length)},start:function t(i){return r("start",i,e.length)}}}},"./src/controller/subtitle-track-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>c});var i=r(/*! ../events */ "./src/events.ts"),n=r(/*! ../utils/texttrack-utils */ "./src/utils/texttrack-utils.ts"),a=r(/*! ./base-playlist-controller */ "./src/controller/base-playlist-controller.ts"),s=r(/*! ../types/loader */ "./src/types/loader.ts");function o(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function l(t,e){return(l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var u=function(t){function e(e){var r;return(r=t.call(this,e,"[subtitle-track-controller]")||this).media=null,r.tracks=[],r.groupId=null,r.tracksInGroup=[],r.trackId=-1,r.selectDefaultTrack=!0,r.queuedDefaultTrack=-1,r.trackChangeListener=function(){return r.onTextTracksChanged()},r.asyncPollTrackChange=function(){return r.pollTrackChange(0)},r.useTextTrackPolling=!1,r.subtitlePollingInterval=-1,r._subtitleDisplay=!0,r.registerListeners(),r}r=e,a=t,r.prototype=Object.create(a.prototype),r.prototype.constructor=r,l(r,a);var r,a,u,c,f,h=e.prototype;return h.destroy=function e(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,t.prototype.destroy.call(this)},h.registerListeners=function t(){var e=this.hls;e.on(i.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.on(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(i.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(i.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(i.Events.ERROR,this.onError,this)},h.unregisterListeners=function t(){var e=this.hls;e.off(i.Events.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(i.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(i.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(i.Events.MANIFEST_PARSED,this.onManifestParsed,this),e.off(i.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(i.Events.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(i.Events.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(i.Events.ERROR,this.onError,this)},h.onMediaAttached=function t(e,r){this.media=r.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},h.pollTrackChange=function t(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)},h.onMediaDetaching=function t(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),d(this.media.textTracks).forEach(function(t){(0,n.clearCurrentCues)(t)}),this.subtitleTrack=-1,this.media=null)},h.onManifestLoading=function t(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},h.onManifestParsed=function t(e,r){this.tracks=r.subtitleTracks},h.onSubtitleTrackLoaded=function t(e,r){var i=r.id,n=r.details,a=this.trackId,s=this.tracksInGroup[a];if(!s){this.warn("Invalid subtitle track id "+i);return}var o=s.details;s.details=r.details,this.log("subtitle track "+i+" loaded ["+n.startSN+"-"+n.endSN+"]"),i===this.trackId&&(this.retryCount=0,this.playlistLoaded(i,r,o))},h.onLevelLoading=function t(e,r){this.switchLevel(r.level)},h.onLevelSwitching=function t(e,r){this.switchLevel(r.level)},h.switchLevel=function t(e){var r=this.hls.levels[e];if(null!=r&&r.textGroupIds){var n=r.textGroupIds[r.urlId];if(this.groupId!==n){var a=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0,s=this.tracks.filter(function(t){return!n||t.groupId===n});this.tracksInGroup=s;var o=this.findTrackId(null==a?void 0:a.name)||this.findTrackId();this.groupId=n,this.log("Updating subtitle tracks, "+s.length+' track(s) found in "'+n+'" group-id'),this.hls.trigger(i.Events.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:s}),-1!==o&&this.setSubtitleTrack(o,a)}}},h.findTrackId=function t(e){for(var r=this.tracksInGroup,i=0;i<r.length;i++){var n=r[i];if((!this.selectDefaultTrack||n.default)&&(!e||e===n.name))return n.id}return -1},h.onError=function e(r,i){t.prototype.onError.call(this,r,i),!i.fatal&&i.context&&i.context.type===s.PlaylistContextType.SUBTITLE_TRACK&&i.context.id===this.trackId&&i.context.groupId===this.groupId&&this.retryLoadingOrFail(i)},h.loadPlaylist=function t(e){var r=this.tracksInGroup[this.trackId];if(this.shouldLoadTrack(r)){var n=r.id,a=r.groupId,s=r.url;if(e)try{s=e.addDirectives(s)}catch(o){this.warn("Could not construct new URL with HLS Delivery Directives: "+o)}this.log("Loading subtitle playlist for id "+n),this.hls.trigger(i.Events.SUBTITLE_TRACK_LOADING,{url:s,id:n,groupId:a,deliveryDirectives:e||null})}},h.toggleTrackModes=function t(e){var r=this,i=this.media,n=this.trackId;if(i){var a=d(i.textTracks),s=a.filter(function(t){return t.groupId===r.groupId});if(-1===e)[].slice.call(a).forEach(function(t){t.mode="disabled"});else{var o=s[n];o&&(o.mode="disabled")}var l=s[e];l&&(l.mode=this.subtitleDisplay?"showing":"hidden")}},h.setSubtitleTrack=function t(e,r){var n,a=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(this.trackId!==e&&this.toggleTrackModes(e),(this.trackId!==e||-1!==e&&(null===(n=a[e])||void 0===n||!n.details))&&!(e<-1)&&!(e>=a.length)){this.clearTimer();var s=a[e];if(this.log("Switching to subtitle track "+e),this.trackId=e,s){var o=s.id,l=s.groupId,u=s.name,d=s.type,c=s.url;this.hls.trigger(i.Events.SUBTITLE_TRACK_SWITCH,{id:o,groupId:void 0===l?"":l,name:u,type:d,url:c});var f=this.switchParams(s.url,null==r?void 0:r.details);this.loadPlaylist(f)}else this.hls.trigger(i.Events.SUBTITLE_TRACK_SWITCH,{id:e})}},h.onTextTracksChanged=function t(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),this.media&&this.hls.config.renderTextTracksNatively){for(var e=-1,r=d(this.media.textTracks),i=0;i<r.length;i++)if("hidden"===r[i].mode)e=i;else if("showing"===r[i].mode){e=i;break}this.subtitleTrack!==e&&(this.subtitleTrack=e)}},u=e,c=[{key:"subtitleDisplay",get:function t(){return this._subtitleDisplay},set:function t(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function t(){return this.tracksInGroup}},{key:"subtitleTrack",get:function t(){return this.trackId},set:function t(e){this.selectDefaultTrack=!1;var r=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,r)}}],o(u.prototype,c),f&&o(u,f),Object.defineProperty(u,"prototype",{writable:!1}),e}(a.default);function d(t){for(var e=[],r=0;r<t.length;r++){var i=t[r];"subtitles"===i.kind&&i.label&&e.push(t[r])}return e}let c=u},"./src/controller/timeline-controller.ts"(t,e,r){"use strict";r.r(e),r.d(e,{TimelineController:()=>h});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../utils/cea-608-parser */ "./src/utils/cea-608-parser.ts"),s=r(/*! ../utils/output-filter */ "./src/utils/output-filter.ts"),o=r(/*! ../utils/webvtt-parser */ "./src/utils/webvtt-parser.ts"),l=r(/*! ../utils/texttrack-utils */ "./src/utils/texttrack-utils.ts"),u=r(/*! ../utils/imsc1-ttml-parser */ "./src/utils/imsc1-ttml-parser.ts"),d=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),c=r(/*! ../types/loader */ "./src/types/loader.ts"),f=r(/*! ../utils/logger */ "./src/utils/logger.ts"),h=function(){function t(t){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.timescale=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=v(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var e=new s.default(this,"textTrack1"),r=new s.default(this,"textTrack2"),i=new s.default(this,"textTrack3"),o=new s.default(this,"textTrack4");this.cea608Parser1=new a.default(1,e,r),this.cea608Parser2=new a.default(3,i,o)}t.on(n.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(n.Events.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(n.Events.MANIFEST_LOADING,this.onManifestLoading,this),t.on(n.Events.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(n.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(n.Events.FRAG_LOADING,this.onFragLoading,this),t.on(n.Events.FRAG_LOADED,this.onFragLoaded,this),t.on(n.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(n.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(n.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(n.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(n.Events.BUFFER_FLUSHING,this.onBufferFlushing,this)}var e=t.prototype;return e.destroy=function t(){var e=this.hls;e.off(n.Events.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(n.Events.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(n.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(n.Events.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(n.Events.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(n.Events.FRAG_LOADING,this.onFragLoading,this),e.off(n.Events.FRAG_LOADED,this.onFragLoaded,this),e.off(n.Events.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(n.Events.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(n.Events.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(n.Events.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(n.Events.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},e.addCues=function t(e,r,i,a,s){for(var o=!1,l=s.length;l--;){var u=s[l],d=g(u[0],u[1],r,i);if(d>=0&&(u[0]=Math.min(u[0],r),u[1]=Math.max(u[1],i),o=!0,d/(i-r)>.5))return}if(o||s.push([r,i]),this.config.renderTextTracksNatively){var c=this.captionsTracks[e];this.Cues.newCue(c,r,i,a)}else{var f=this.Cues.newCue(null,r,i,a);this.hls.trigger(n.Events.CUES_PARSED,{type:"captions",cues:f,track:e})}},e.onInitPtsFound=function t(e,r){var i=this,a=r.frag,s=r.id,o=r.initPTS,l=r.timescale,u=this.unparsedVttFrags;"main"===s&&(this.initPTS[a.cc]=o,this.timescale[a.cc]=l),u.length&&(this.unparsedVttFrags=[],u.forEach(function(t){i.onFragLoaded(n.Events.FRAG_LOADED,t)}))},e.getExistingTrack=function t(e){var r=this.media;if(r)for(var i=0;i<r.textTracks.length;i++){var n=r.textTracks[i];if(n[e])return n}return null},e.createCaptionsTrack=function t(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)},e.createNativeTrack=function t(e){if(!this.captionsTracks[e]){var r=this.captionsProperties,i=this.captionsTracks,n=this.media,a=r[e],s=a.label,o=a.languageCode,u=this.getExistingTrack(e);if(u)i[e]=u,(0,l.clearCurrentCues)(i[e]),(0,l.sendAddTrackEvent)(i[e],n);else{var d=this.createTextTrack("captions",s,o);d&&(d[e]=!0,i[e]=d)}}},e.createNonNativeTrack=function t(e){if(!this.nonNativeCaptionsTracks[e]){var r=this.captionsProperties[e];if(r){var i={_id:e,label:r.label,kind:"captions",default:!!r.media&&!!r.media.default,closedCaptions:r.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(n.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}}},e.createTextTrack=function t(e,r,i){var n=this.media;if(n)return n.addTextTrack(e,r,i)},e.onMediaAttaching=function t(e,r){this.media=r.media,this._cleanTracks()},e.onMediaDetaching=function t(){var e=this.captionsTracks;Object.keys(e).forEach(function(t){(0,l.clearCurrentCues)(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}},e.onManifestLoading=function t(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=v(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=this.unparsedVttFrags||[],this.initPTS=[],this.timescale=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},e._cleanTracks=function t(){var e=this.media;if(e){var r=e.textTracks;if(r)for(var i=0;i<r.length;i++)(0,l.clearCurrentCues)(r[i])}},e.onSubtitleTracksUpdated=function t(e,r){var i=this;this.textTracks=[];var a=r.subtitleTracks||[],s=a.some(function(t){return t.textCodec===u.IMSC1_CODEC});if(this.config.enableWebVTT||s&&this.config.enableIMSC1){var o=this.tracks&&a&&this.tracks.length===a.length;if(this.tracks=a||[],this.config.renderTextTracksNatively){var d=this.media?this.media.textTracks:[];this.tracks.forEach(function(t,e){var r;if(e<d.length){for(var n=null,a=0;a<d.length;a++)if($(d[a],t)){n=d[a];break}n&&(r=n)}if(r)(0,l.clearCurrentCues)(r);else{var s=i._captionsOrSubtitlesFromCharacteristics(t);(r=i.createTextTrack(s,t.name,t.lang))&&(r.mode="disabled")}r&&(r.groupId=t.groupId,i.textTracks.push(r))})}else if(!o&&this.tracks&&this.tracks.length){var c=this.tracks.map(function(t){return{label:t.name,kind:t.type.toLowerCase(),default:t.default,subtitleTrack:t}});this.hls.trigger(n.Events.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:c})}}},e._captionsOrSubtitlesFromCharacteristics=function t(e){var r;if(null!==(r=e.attrs)&&void 0!==r&&r.CHARACTERISTICS){var i=/transcribes-spoken-dialog/gi.test(e.attrs.CHARACTERISTICS),n=/describes-music-and-sound/gi.test(e.attrs.CHARACTERISTICS);if(i&&n)return"captions"}return"subtitles"},e.onManifestLoaded=function t(e,r){var i=this;this.config.enableCEA708Captions&&r.captions&&r.captions.forEach(function(t){var e=/(?:CC|SERVICE)([1-4])/.exec(t.instreamId);if(e){var r="textTrack"+e[1],n=i.captionsProperties[r];n&&(n.label=t.name,t.lang&&(n.languageCode=t.lang),n.media=t)}})},e.closedCaptionsForLevel=function t(e){var r=this.hls.levels[e.level];return null==r?void 0:r.attrs["CLOSED-CAPTIONS"]},e.onFragLoading=function t(e,r){var i=this.cea608Parser1,n=this.cea608Parser2,a=this.lastSn,s=this.lastPartIndex;if(this.enabled&&i&&n&&r.frag.type===c.PlaylistLevelType.MAIN){var o,l,u=r.frag.sn,d=null!=(o=null==r?void 0:null===(l=r.part)||void 0===l?void 0:l.index)?o:-1;u===a+1||u===a&&d===s+1||(i.reset(),n.reset()),this.lastSn=u,this.lastPartIndex=d}},e.onFragLoaded=function t(e,r){var a=r.frag,s=r.payload,o=this.initPTS,l=this.unparsedVttFrags;if(a.type===c.PlaylistLevelType.SUBTITLE){if(s.byteLength){if(!(0,i.isFiniteNumber)(o[a.cc])){l.push(r),o.length&&this.hls.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:Error("Missing initial subtitle PTS")});return}var d=a.decryptdata;if(null==d||null==d.key||"AES-128"!==d.method||"stats"in r){var f=this.tracks[a.level],h=this.vttCCs;h[a.cc]||(h[a.cc]={start:a.start,prevCC:this.prevCC,new:!0},this.prevCC=a.cc),f&&f.textCodec===u.IMSC1_CODEC?this._parseIMSC1(a,s):this._parseVTTs(a,s,h)}}else this.hls.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:a,error:Error("Empty subtitle payload")})}},e._parseIMSC1=function t(e,r){var i=this,a=this.hls;(0,u.parseIMSC1)(r,this.initPTS[e.cc],this.timescale[e.cc],function(t){i._appendCues(t,e.level),a.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(t){f.logger.log("Failed to parse IMSC1: "+t),a.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})},e._parseVTTs=function t(e,r,i){var a,s=this,l=this.hls,u=null!==(a=e.initSegment)&&void 0!==a&&a.data?(0,d.appendUint8Array)(e.initSegment.data,new Uint8Array(r)):r;(0,o.parseWebVTT)(u,this.initPTS[e.cc],this.timescale[e.cc],i,e.cc,e.start,function(t){s._appendCues(t,e.level),l.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(t){s._fallbackToIMSC1(e,r),f.logger.log("Failed to parse VTT cue: "+t),l.trigger(n.Events.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})},e._fallbackToIMSC1=function t(e,r){var i=this,n=this.tracks[e.level];n.textCodec||(0,u.parseIMSC1)(r,this.initPTS[e.cc],this.timescale[e.cc],function(){n.textCodec=u.IMSC1_CODEC,i._parseIMSC1(e,r)},function(){n.textCodec="wvtt"})},e._appendCues=function t(e,r){var i=this.hls;if(this.config.renderTextTracksNatively){var a=this.textTracks[r];if(!a||"disabled"===a.mode)return;e.forEach(function(t){return(0,l.addCueToTrack)(a,t)})}else{var s=this.tracks[r];if(!s)return;var o=s.default?"default":"subtitles"+r;i.trigger(n.Events.CUES_PARSED,{type:"subtitles",cues:e,track:o})}},e.onFragDecrypted=function t(e,r){var a=r.frag;if(a.type===c.PlaylistLevelType.SUBTITLE){if(!(0,i.isFiniteNumber)(this.initPTS[a.cc])){this.unparsedVttFrags.push(r);return}this.onFragLoaded(n.Events.FRAG_LOADED,r)}},e.onSubtitleTracksCleared=function t(){this.tracks=[],this.captionsTracks={}},e.onFragParsingUserdata=function t(e,r){var i=this.cea608Parser1,n=this.cea608Parser2;if(this.enabled&&i&&n){var a=r.frag,s=r.samples;if(a.type!==c.PlaylistLevelType.MAIN||"NONE"!==this.closedCaptionsForLevel(a))for(var o=0;o<s.length;o++){var l=s[o].bytes;if(l){var u=this.extractCea608Data(l);i.addData(s[o].pts,u[0]),n.addData(s[o].pts,u[1])}}}},e.onBufferFlushing=function t(e,r){var i=r.startOffset,n=r.endOffset,a=r.endOffsetSubtitles,s=r.type,o=this.media;if(o&&!(o.currentTime<n)){if(!s||"video"===s){var u=this.captionsTracks;Object.keys(u).forEach(function(t){return(0,l.removeCuesInRange)(u[t],i,n)})}if(this.config.renderTextTracksNatively&&0===i&&void 0!==a){var d=this.textTracks;Object.keys(d).forEach(function(t){return(0,l.removeCuesInRange)(d[t],i,a)})}}},e.extractCea608Data=function t(e){for(var r=[[],[]],i=31&e[0],n=2,a=0;a<i;a++){var s=e[n++],o=127&e[n++],l=127&e[n++];if((0!==o||0!==l)&&(4&s)!=0){var u=3&s;(0===u||1===u)&&(r[u].push(o),r[u].push(l))}}return r},t}();function $(t,e){return t&&t.label===e.name&&!(t.textTrack1||t.textTrack2)}function g(t,e,r,i){return Math.min(e,i)-Math.max(t,r)}function v(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}},"./src/crypt/aes-crypto.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});var i=function(){function t(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}return t.prototype.decrypt=function t(e,r){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},r,e)},t}()},"./src/crypt/aes-decryptor.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>a,removePadding:()=>n});var i=r(/*! ../utils/typed-array */ "./src/utils/typed-array.ts");function n(t){var e=t.byteLength,r=e&&new DataView(t.buffer).getUint8(e-1);return r?(0,i.sliceUint8)(t,0,e-r):t}var a=function(){function t(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var e=t.prototype;return e.uint8ArrayToUint32Array_=function t(e){for(var r=new DataView(e),i=new Uint32Array(4),n=0;n<4;n++)i[n]=r.getUint32(4*n);return i},e.initTable=function t(){var e=this.sBox,r=this.invSBox,i=this.subMix,n=i[0],a=i[1],s=i[2],o=i[3],l=this.invSubMix,u=l[0],d=l[1],c=l[2],f=l[3],h=new Uint32Array(256),$=0,g=0,v=0;for(v=0;v<256;v++)v<128?h[v]=v<<1:h[v]=v<<1^283;for(v=0;v<256;v++){var p=g^g<<1^g<<2^g<<3^g<<4;p=p>>>8^255&p^99,e[$]=p,r[p]=$;var m=h[$],x=h[m],T=h[x],E=257*h[p]^16843008*p;n[$]=E<<24|E>>>8,a[$]=E<<16|E>>>16,s[$]=E<<8|E>>>24,o[$]=E,E=16843009*T^65537*x^257*m^16843008*$,u[p]=E<<24|E>>>8,d[p]=E<<16|E>>>16,c[p]=E<<8|E>>>24,f[p]=E,$?($=m^h[h[h[T^m]]],g^=h[h[g]]):$=g=1}},e.expandKey=function t(e){for(var r,i,n,a,s=this.uint8ArrayToUint32Array_(e),o=!0,l=0;l<s.length&&o;)o=s[l]===this.key[l],l++;if(!o){this.key=s;var u=this.keySize=s.length;if(4!==u&&6!==u&&8!==u)throw Error("Invalid aes key size="+u);var d=this.ksRows=(u+6+1)*4,c=this.keySchedule=new Uint32Array(d),f=this.invKeySchedule=new Uint32Array(d),h=this.sBox,$=this.rcon,g=this.invSubMix,v=g[0],p=g[1],m=g[2],x=g[3];for(r=0;r<d;r++){if(r<u){n=c[r]=s[r];continue}a=n,r%u==0?(a=h[(a=a<<8|a>>>24)>>>24]<<24|h[a>>>16&255]<<16|h[a>>>8&255]<<8|h[255&a],a^=$[r/u|0]<<24):u>6&&r%u==4&&(a=h[a>>>24]<<24|h[a>>>16&255]<<16|h[a>>>8&255]<<8|h[255&a]),c[r]=n=(c[r-u]^a)>>>0}for(i=0;i<d;i++)r=d-i,a=3&i?c[r]:c[r-4],i<4||r<=4?f[i]=a:f[i]=v[h[a>>>24]]^p[h[a>>>16&255]]^m[h[a>>>8&255]]^x[h[255&a]],f[i]=f[i]>>>0}},e.networkToHostOrderSwap=function t(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24},e.decrypt=function t(e,r,i){for(var n,a,s,o,l,u,d,c,f,h,$,g,v,p,m=this.keySize+6,x=this.invKeySchedule,T=this.invSBox,E=this.invSubMix,y=E[0],S=E[1],L=E[2],b=E[3],D=this.uint8ArrayToUint32Array_(i),_=D[0],k=D[1],A=D[2],I=D[3],R=new Int32Array(e),C=new Int32Array(R.length),w=this.networkToHostOrderSwap;r<R.length;){for(p=1,f=w(R[r]),h=w(R[r+1]),$=w(R[r+2]),g=w(R[r+3]),l=f^x[0],u=g^x[1],d=$^x[2],c=h^x[3],v=4;p<m;p++)n=y[l>>>24]^S[u>>16&255]^L[d>>8&255]^b[255&c]^x[v],a=y[u>>>24]^S[d>>16&255]^L[c>>8&255]^b[255&l]^x[v+1],s=y[d>>>24]^S[c>>16&255]^L[l>>8&255]^b[255&u]^x[v+2],o=y[c>>>24]^S[l>>16&255]^L[u>>8&255]^b[255&d]^x[v+3],l=n,u=a,d=s,c=o,v+=4;n=T[l>>>24]<<24^T[u>>16&255]<<16^T[d>>8&255]<<8^T[255&c]^x[v],a=T[u>>>24]<<24^T[d>>16&255]<<16^T[c>>8&255]<<8^T[255&l]^x[v+1],s=T[d>>>24]<<24^T[c>>16&255]<<16^T[l>>8&255]<<8^T[255&u]^x[v+2],o=T[c>>>24]<<24^T[l>>16&255]<<16^T[u>>8&255]<<8^T[255&d]^x[v+3],C[r]=w(n^_),C[r+1]=w(o^k),C[r+2]=w(s^A),C[r+3]=w(a^I),_=f,k=h,A=$,I=g,r+=4}return C.buffer},t}()},"./src/crypt/decrypter.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>u});var i=r(/*! ./aes-crypto */ "./src/crypt/aes-crypto.ts"),n=r(/*! ./fast-aes-key */ "./src/crypt/fast-aes-key.ts"),a=r(/*! ./aes-decryptor */ "./src/crypt/aes-decryptor.ts"),s=r(/*! ../utils/logger */ "./src/utils/logger.ts"),o=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),l=r(/*! ../utils/typed-array */ "./src/utils/typed-array.ts"),u=function(){function t(t,e,r){var i=(void 0===r?{}:r).removePKCS7Padding,n=void 0===i||i;if(this.logEnabled=!0,this.observer=void 0,this.config=void 0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.observer=t,this.config=e,this.removePKCS7Padding=n,n)try{var a=self.crypto;a&&(this.subtle=a.subtle||a.webkitSubtle)}catch(s){}null===this.subtle&&(this.config.enableSoftwareAES=!0)}var e=t.prototype;return e.destroy=function t(){this.observer=null},e.isSync=function t(){return this.config.enableSoftwareAES},e.flush=function t(){var e=this.currentResult;if(!e){this.reset();return}var r=new Uint8Array(e);return(this.reset(),this.removePKCS7Padding)?(0,a.removePadding)(r):r},e.reset=function t(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},e.decrypt=function t(e,r,i,n){if(this.config.enableSoftwareAES){this.softwareDecrypt(new Uint8Array(e),r,i);var a=this.flush();a&&n(a.buffer)}else this.webCryptoDecrypt(new Uint8Array(e),r,i).then(n)},e.softwareDecrypt=function t(e,r,i){var n=this.currentIV,s=this.currentResult,u=this.remainderData;this.logOnce("JS AES decrypt"),u&&(e=(0,o.appendUint8Array)(u,e),this.remainderData=null);var d=this.getValidChunk(e);if(!d.length)return null;n&&(i=n);var c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new a.default),c.expandKey(r);var f=s;return(this.currentResult=c.decrypt(d.buffer,0,i),this.currentIV=(0,l.sliceUint8)(d,-16).buffer,f)?f:null},e.webCryptoDecrypt=function t(e,r,a){var s=this,o=this.subtle;return this.key===r&&this.fastAesKey||(this.key=r,this.fastAesKey=new n.default(o,r)),this.fastAesKey.expandKey().then(function(t){return o?new i.default(o,a).decrypt(e.buffer,t):Promise.reject(Error("web crypto not initialized"))}).catch(function(t){return s.onWebCryptoError(t,e,r,a)})},e.onWebCryptoError=function t(e,r,i,n){return s.logger.warn("[decrypter.ts]: WebCrypto Error, disable WebCrypto API:",e),this.config.enableSoftwareAES=!0,this.logEnabled=!0,this.softwareDecrypt(r,i,n)},e.getValidChunk=function t(e){var r=e,i=e.length-e.length%16;return i!==e.length&&(r=(0,l.sliceUint8)(e,0,i),this.remainderData=(0,l.sliceUint8)(e,i)),r},e.logOnce=function t(e){this.logEnabled&&(s.logger.log("[decrypter.ts]: "+e),this.logEnabled=!1)},t}()},"./src/crypt/fast-aes-key.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});var i=function(){function t(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}return t.prototype.expandKey=function t(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},t}()},"./src/demux/aacdemuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>u});var i=r(/*! ./base-audio-demuxer */ "./src/demux/base-audio-demuxer.ts"),n=r(/*! ./adts */ "./src/demux/adts.ts"),a=r(/*! ../utils/logger */ "./src/utils/logger.ts"),s=r(/*! ../demux/id3 */ "./src/demux/id3.ts");function o(t,e){return(o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var l=function(t){function e(e,r){var i;return(i=t.call(this)||this).observer=void 0,i.config=void 0,i.observer=e,i.config=r,i}r=e,i=t,r.prototype=Object.create(i.prototype),r.prototype.constructor=r,o(r,i);var r,i,l=e.prototype;return l.resetInitSegment=function e(r,i,n,a){t.prototype.resetInitSegment.call(this,r,i,n,a),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:i,duration:a,inputTimeScale:9e4,dropped:0}},e.probe=function t(e){if(!e)return!1;for(var r=(s.getID3Data(e,0)||[]).length,i=e.length;r<i;r++)if(n.probe(e,r))return a.logger.log("ADTS sync word found !"),!0;return!1},l.canParse=function t(e,r){return n.canParse(e,r)},l.appendFrame=function t(e,r,i){n.initTrackConfig(e,this.observer,r,i,e.manifestCodec);var a=n.appendFrame(e,r,i,this.basePTS,this.frameIndex);if(a&&0===a.missing)return a},e}(i.default);let u=l},"./src/demux/adts.ts"(t,e,r){"use strict";r.r(e),r.d(e,{appendFrame:()=>p,canGetFrameLength:()=>d,canParse:()=>f,getAudioConfig:()=>s,getFrameDuration:()=>g,getFullFrameLength:()=>u,getHeaderLength:()=>l,initTrackConfig:()=>$,isHeader:()=>c,isHeaderPattern:()=>o,parseFrameHeader:()=>v,probe:()=>h});var i=r(/*! ../utils/logger */ "./src/utils/logger.ts"),n=r(/*! ../errors */ "./src/errors.ts"),a=r(/*! ../events */ "./src/events.ts");function s(t,e,r,s){var o,l,u,d,c=navigator.userAgent.toLowerCase(),f=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];o=((192&e[r+2])>>>6)+1;var h=(60&e[r+2])>>>2;if(h>f.length-1){t.trigger(a.Events.ERROR,{type:n.ErrorTypes.MEDIA_ERROR,details:n.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+h});return}return u=(1&e[r+2])<<2,u|=(192&e[r+3])>>>6,i.logger.log("manifest codec:"+s+", ADTS type:"+o+", samplingIndex:"+h),/firefox/i.test(c)?h>=6?(o=5,d=[,,,,],l=h-3):(o=2,d=[,,],l=h):-1!==c.indexOf("android")?(o=2,d=[,,],l=h):(o=5,d=[,,,,],s&&(-1!==s.indexOf("mp4a.40.29")||-1!==s.indexOf("mp4a.40.5"))||!s&&h>=6?l=h-3:((s&&-1!==s.indexOf("mp4a.40.2")&&(h>=6&&1===u||/vivaldi/i.test(c))||!s&&1===u)&&(o=2,d=[,,]),l=h)),d[0]=o<<3,d[0]|=(14&h)>>1,d[1]|=(1&h)<<7,d[1]|=u<<3,5===o&&(d[1]|=(14&l)>>1,d[2]=(1&l)<<7,d[2]|=8,d[3]=0),{config:d,samplerate:f[h],channelCount:u,codec:"mp4a.40."+o,manifestCodec:s}}function o(t,e){return 255===t[e]&&(246&t[e+1])==240}function l(t,e){return 1&t[e+1]?7:9}function u(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function d(t,e){return e+5<t.length}function c(t,e){return e+1<t.length&&o(t,e)}function f(t,e){return d(t,e)&&o(t,e)&&u(t,e)<=t.length-e}function h(t,e){if(c(t,e)){var r=l(t,e);if(e+r>=t.length)return!1;var i=u(t,e);if(i<=r)return!1;var n=e+i;return n===t.length||c(t,n)}return!1}function $(t,e,r,n,a){if(!t.samplerate){var o=s(e,r,n,a);o&&(t.config=o.config,t.samplerate=o.samplerate,t.channelCount=o.channelCount,t.codec=o.codec,t.manifestCodec=o.manifestCodec,i.logger.log("parsed codec:"+t.codec+", rate:"+o.samplerate+", channels:"+o.channelCount))}}function g(t){return 9216e4/t}function v(t,e){var r=l(t,e);if(e+r<=t.length){var i=u(t,e)-r;if(i>0)return{headerLength:r,frameLength:i}}}function p(t,e,r,i,n){var a,s=i+n*g(t.samplerate),o=v(e,r);if(o){var l=o.frameLength,u=o.headerLength,d=u+l,c=Math.max(0,r+d-e.length);c?(a=new Uint8Array(d-u)).set(e.subarray(r+u,e.length),0):a=e.subarray(r+u,r+d);var f={unit:a,pts:s};return c||t.samples.push(f),{sample:f,length:d,missing:c}}var h=e.length-r;return(a=new Uint8Array(h)).set(e.subarray(r,e.length),0),{sample:{unit:a,pts:s},length:h,missing:-1}}},"./src/demux/base-audio-demuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>c,initPTSFn:()=>d});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../demux/id3 */ "./src/demux/id3.ts"),a=r(/*! ../types/demuxer */ "./src/types/demuxer.ts"),s=r(/*! ./dummy-demuxed-track */ "./src/demux/dummy-demuxed-track.ts"),o=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),l=r(/*! ../utils/typed-array */ "./src/utils/typed-array.ts"),u=function(){function t(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var e=t.prototype;return e.resetInitSegment=function t(e,r,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},e.resetTimeStamp=function t(e){this.initPTS=e,this.resetContiguity()},e.resetContiguity=function t(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},e.canParse=function t(e,r){return!1},e.appendFrame=function t(e,r,i){},e.demux=function t(e,r){this.cachedData&&(e=(0,o.appendUint8Array)(this.cachedData,e),this.cachedData=null);var u,c=n.getID3Data(e,0),f=c?c.length:0,h=this._audioTrack,$=this._id3Track,g=c?n.getTimeStamp(c):void 0,v=e.length;for((null===this.basePTS||0===this.frameIndex&&(0,i.isFiniteNumber)(g))&&(this.basePTS=d(g,r,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),c&&c.length>0&&$.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:c,type:a.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});f<v;){if(this.canParse(e,f)){var p=this.appendFrame(h,e,f);p?(this.frameIndex++,this.lastPTS=p.sample.pts,f+=p.length,u=f):f=v}else n.canParse(e,f)?(c=n.getID3Data(e,f),$.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:c,type:a.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),f+=c.length,u=f):f++;if(f===v&&u!==v){var m=(0,l.sliceUint8)(e,u);this.cachedData?this.cachedData=(0,o.appendUint8Array)(this.cachedData,m):this.cachedData=m}}return{audioTrack:h,videoTrack:(0,s.dummyTrack)(),id3Track:$,textTrack:(0,s.dummyTrack)()}},e.demuxSampleAes=function t(e,r,i){return Promise.reject(Error("["+this+"] This demuxer does not support Sample-AES decryption"))},e.flush=function t(e){var r=this.cachedData;return r&&(this.cachedData=null,this.demux(r,0)),{audioTrack:this._audioTrack,videoTrack:(0,s.dummyTrack)(),id3Track:this._id3Track,textTrack:(0,s.dummyTrack)()}},e.destroy=function t(){},t}(),d=function t(e,r,n){return(0,i.isFiniteNumber)(e)?90*e:9e4*r+(n||0)};let c=u},"./src/demux/chunk-cache.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});var i=function(){function t(){this.chunks=[],this.dataLength=0}var e=t.prototype;return e.push=function t(e){this.chunks.push(e),this.dataLength+=e.length},e.flush=function t(){var e,r=this.chunks,i=this.dataLength;return r.length?(e=1===r.length?r[0]:function t(e,r){for(var i=new Uint8Array(r),n=0,a=0;a<e.length;a++){var s=e[a];i.set(s,n),n+=s.length}return i}(r,i),this.reset(),e):new Uint8Array(0)},e.reset=function t(){this.chunks.length=0,this.dataLength=0},t}()},"./src/demux/dummy-demuxed-track.ts"(t,e,r){"use strict";function i(t,e){return void 0===t&&(t=""),void 0===e&&(e=9e4),{type:t,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}r.r(e),r.d(e,{dummyTrack:()=>i})},"./src/demux/exp-golomb.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>a});var i=r(/*! ../utils/logger */ "./src/utils/logger.ts"),n=function(){function t(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}var e=t.prototype;return e.loadWord=function t(){var e=this.data,r=this.bytesAvailable,i=e.byteLength-r,n=new Uint8Array(4),a=Math.min(4,r);if(0===a)throw Error("no bytes available");n.set(e.subarray(i,i+a)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=8*a,this.bytesAvailable-=a},e.skipBits=function t(e){var r;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,r=e>>3,e-=r>>3,this.bytesAvailable-=r,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)},e.readBits=function t(e){var r=Math.min(this.bitsAvailable,e),n=this.word>>>32-r;return(e>32&&i.logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=r,this.bitsAvailable>0?this.word<<=r:this.bytesAvailable>0&&this.loadWord(),(r=e-r)>0&&this.bitsAvailable)?n<<r|this.readBits(r):n},e.skipLZ=function t(){var e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!=0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()},e.skipUEG=function t(){this.skipBits(1+this.skipLZ())},e.skipEG=function t(){this.skipBits(1+this.skipLZ())},e.readUEG=function t(){var e=this.skipLZ();return this.readBits(e+1)-1},e.readEG=function t(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)},e.readBoolean=function t(){return 1===this.readBits(1)},e.readUByte=function t(){return this.readBits(8)},e.readUShort=function t(){return this.readBits(16)},e.readUInt=function t(){return this.readBits(32)},e.skipScalingList=function t(e){for(var r,i=8,n=8,a=0;a<e;a++)0!==n&&(n=(i+(r=this.readEG())+256)%256),i=0===n?i:n},e.readSPS=function t(){var e,r,i,n=0,a=0,s=0,o=0,l=this.readUByte.bind(this),u=this.readBits.bind(this),d=this.readUEG.bind(this),c=this.readBoolean.bind(this),f=this.skipBits.bind(this),h=this.skipEG.bind(this),$=this.skipUEG.bind(this),g=this.skipScalingList.bind(this);l();var v=l();if(u(5),f(3),l(),$(),100===v||110===v||122===v||244===v||44===v||83===v||86===v||118===v||128===v){var p=d();if(3===p&&f(1),$(),$(),f(1),c())for(i=0,r=3!==p?8:12;i<r;i++)c()&&g(i<6?16:64)}$();var m=d();if(0===m)d();else if(1===m)for(f(1),h(),h(),e=d(),i=0;i<e;i++)h();$(),f(1);var x=d(),T=d(),E=u(1);0===E&&f(1),f(1),c()&&(n=d(),a=d(),s=d(),o=d());var y=[1,1];if(c()&&c()){var S=l();switch(S){case 1:y=[1,1];break;case 2:y=[12,11];break;case 3:y=[10,11];break;case 4:y=[16,11];break;case 5:y=[40,33];break;case 6:y=[24,11];break;case 7:y=[20,11];break;case 8:y=[32,11];break;case 9:y=[80,33];break;case 10:y=[18,11];break;case 11:y=[15,11];break;case 12:y=[64,33];break;case 13:y=[160,99];break;case 14:y=[4,3];break;case 15:y=[3,2];break;case 16:y=[2,1];break;case 255:y=[l()<<8|l(),l()<<8|l()]}}return{width:Math.ceil((x+1)*16-2*n-2*a),height:(2-E)*(T+1)*16-(E?2:4)*(s+o),pixelRatio:y}},e.readSliceType=function t(){return this.readUByte(),this.readUEG(),this.readUEG()},t}();let a=n},"./src/demux/id3.ts"(t,e,r){"use strict";r.r(e),r.d(e,{canParse:()=>l,decodeFrame:()=>h,getID3Data:()=>s,getID3Frames:()=>f,getTimeStamp:()=>u,isFooter:()=>a,isHeader:()=>n,isTimeStampFrame:()=>d,testables:()=>x,utf8ArrayToStr:()=>m});var i,n=function t(e,r){return!!(r+10<=e.length)&&73===e[r]&&68===e[r+1]&&51===e[r+2]&&!!(e[r+3]<255)&&!!(e[r+4]<255)&&!!(e[r+6]<128)&&!!(e[r+7]<128)&&!!(e[r+8]<128)&&!!(e[r+9]<128)},a=function t(e,r){return!!(r+10<=e.length)&&51===e[r]&&68===e[r+1]&&73===e[r+2]&&!!(e[r+3]<255)&&!!(e[r+4]<255)&&!!(e[r+6]<128)&&!!(e[r+7]<128)&&!!(e[r+8]<128)&&!!(e[r+9]<128)},s=function t(e,r){for(var i=r,s=0;n(e,r);){s+=10;var l=o(e,r+6);s+=l,a(e,r+10)&&(s+=10),r+=s}if(s>0)return e.subarray(i,i+s)},o=function t(e,r){var i=0;return i=(127&e[r])<<21,i|=(127&e[r+1])<<14,i|=(127&e[r+2])<<7,i|=127&e[r+3]},l=function t(e,r){return n(e,r)&&o(e,r+6)+10<=e.length-r},u=function t(e){for(var r=f(e),i=0;i<r.length;i++){var n=r[i];if(d(n))return p(n)}},d=function t(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info},c=function t(e){var r=String.fromCharCode(e[0],e[1],e[2],e[3]),i=o(e,4);return{type:r,size:i,data:e.subarray(10,10+i)}},f=function t(e){for(var r=0,i=[];n(e,r);){for(var s=o(e,r+6),l=(r+=10)+s;r+8<l;){var u=c(e.subarray(r)),d=h(u);d&&i.push(d),r+=u.size+10}a(e,r)&&(r+=10)}return i},h=function t(e){return"PRIV"===e.type?$(e):"W"===e.type[0]?v(e):g(e)},$=function t(e){if(!(e.size<2)){var r=m(e.data,!0),i=new Uint8Array(e.data.subarray(r.length+1));return{key:e.type,info:r,data:i.buffer}}},g=function t(e){if(!(e.size<2)){if("TXXX"===e.type){var r=1,i=m(e.data.subarray(r),!0);r+=i.length+1;var n=m(e.data.subarray(r));return{key:e.type,info:i,data:n}}var a=m(e.data.subarray(1));return{key:e.type,data:a}}},v=function t(e){if("WXXX"===e.type){if(e.size<2)return;var r=1,i=m(e.data.subarray(r),!0);r+=i.length+1;var n=m(e.data.subarray(r));return{key:e.type,info:i,data:n}}var a=m(e.data);return{key:e.type,data:a}},p=function t(e){if(8===e.data.byteLength){var r=new Uint8Array(e.data),i=1&r[3],n=(r[4]<<23)+(r[5]<<15)+(r[6]<<7)+r[7];return n/=45,i&&(n+=47721858.84),Math.round(n)}},m=function t(e,r){void 0===r&&(r=!1);var n,a,s,o=(i||void 0===self.TextDecoder||(i=new self.TextDecoder("utf-8")),i);if(o){var l=o.decode(e);if(r){var u=l.indexOf("\0");return -1!==u?l.substring(0,u):l}return l.replace(/\0/g,"")}for(var d=e.length,c="",f=0;f<d&&(0!==(n=e[f++])||!r);)if(0!==n&&3!==n)switch(n>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:c+=String.fromCharCode(n);break;case 12:case 13:c+=String.fromCharCode((31&n)<<6|63&(a=e[f++]));break;case 14:c+=String.fromCharCode((15&n)<<12|(63&(a=e[f++]))<<6|(63&(s=e[f++]))<<0)}return c},x={decodeTextFrame:g}},"./src/demux/mp3demuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>u});var i=r(/*! ./base-audio-demuxer */ "./src/demux/base-audio-demuxer.ts"),n=r(/*! ../demux/id3 */ "./src/demux/id3.ts"),a=r(/*! ../utils/logger */ "./src/utils/logger.ts"),s=r(/*! ./mpegaudio */ "./src/demux/mpegaudio.ts");function o(t,e){return(o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}var l=function(t){function e(){return t.apply(this,arguments)||this}r=e,i=t,r.prototype=Object.create(i.prototype),r.prototype.constructor=r,o(r,i);var r,i,l=e.prototype;return l.resetInitSegment=function e(r,i,n,a){t.prototype.resetInitSegment.call(this,r,i,n,a),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:i,duration:a,inputTimeScale:9e4,dropped:0}},e.probe=function t(e){if(!e)return!1;for(var r=(n.getID3Data(e,0)||[]).length,i=e.length;r<i;r++)if(s.probe(e,r))return a.logger.log("MPEG Audio sync word found !"),!0;return!1},l.canParse=function t(e,r){return s.canParse(e,r)},l.appendFrame=function t(e,r,i){if(null!==this.basePTS)return s.appendFrame(e,r,i,this.basePTS,this.frameIndex)},e}(i.default);let u=l},"./src/demux/mp4demuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>u});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../types/demuxer */ "./src/types/demuxer.ts"),a=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),s=r(/*! ./dummy-demuxed-track */ "./src/demux/dummy-demuxed-track.ts"),o=/\/emsg[-/]ID3/i,l=function(){function t(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}var e=t.prototype;return e.resetTimeStamp=function t(){},e.resetInitSegment=function t(e,r,i,n){var o=(0,a.parseInitSegment)(e),l=this.videoTrack=(0,s.dummyTrack)("video",1),u=this.audioTrack=(0,s.dummyTrack)("audio",1),d=this.txtTrack=(0,s.dummyTrack)("text",1);if(this.id3Track=(0,s.dummyTrack)("id3",1),this.timeOffset=0,o.video){var c=o.video,f=c.id,h=c.timescale,$=c.codec;l.id=f,l.timescale=d.timescale=h,l.codec=$}if(o.audio){var g=o.audio,v=g.id,p=g.timescale,m=g.codec;u.id=v,u.timescale=p,u.codec=m}d.id=a.RemuxerTrackIdConfig.text,l.sampleDuration=0,l.duration=u.duration=n},e.resetContiguity=function t(){},t.probe=function t(e){return e=e.length>16384?e.subarray(0,16384):e,(0,a.findBox)(e,["moof"]).length>0},e.demux=function t(e,r){this.timeOffset=r;var i=e,n=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=(0,a.appendUint8Array)(this.remainderData,e));var o=(0,a.segmentValidRange)(i);this.remainderData=o.remainder,n.samples=o.valid||new Uint8Array}else n.samples=i;var l=this.extractID3Track(n,r);return s.samples=(0,a.parseSamples)(r,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:l,textTrack:this.txtTrack}},e.flush=function t(){var e=this.timeOffset,r=this.videoTrack,i=this.txtTrack;r.samples=this.remainderData||new Uint8Array,this.remainderData=null;var n=this.extractID3Track(r,this.timeOffset);return i.samples=(0,a.parseSamples)(e,r),{videoTrack:r,audioTrack:(0,s.dummyTrack)(),id3Track:n,textTrack:(0,s.dummyTrack)()}},e.extractID3Track=function t(e,r){var s=this.id3Track;if(e.samples.length){var l=(0,a.findBox)(e.samples,["emsg"]);l&&l.forEach(function(t){var e=(0,a.parseEmsg)(t);if(o.test(e.schemeIdUri)){var l=(0,i.isFiniteNumber)(e.presentationTime)?e.presentationTime/e.timeScale:r+e.presentationTimeDelta/e.timeScale,u=4294967295===e.eventDuration?Number.POSITIVE_INFINITY:e.eventDuration/e.timeScale;u<=.001&&(u=Number.POSITIVE_INFINITY);var d=e.payload;s.samples.push({data:d,len:d.byteLength,dts:l,pts:l,type:n.MetadataSchema.emsg,duration:u})}})}return s},e.demuxSampleAes=function t(e,r,i){return Promise.reject(Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},e.destroy=function t(){},t}();let u=l},"./src/demux/mpegaudio.ts"(t,e,r){"use strict";r.r(e),r.d(e,{appendFrame:()=>l,canParse:()=>f,isHeader:()=>c,isHeaderPattern:()=>d,parseHeader:()=>u,probe:()=>h});var i=null,n=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],a=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],s=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],o=[0,1,1,4];function l(t,e,r,i,n){if(!(r+24>e.length)){var a=u(e,r);if(a&&r+a.frameLength<=e.length){var s=i+n*(9e4*a.samplesPerFrame/a.sampleRate),o={unit:e.subarray(r,r+a.frameLength),pts:s,dts:s};return t.config=[],t.channelCount=a.channelCount,t.samplerate=a.sampleRate,t.samples.push(o),{sample:o,length:a.frameLength,missing:0}}}}function u(t,e){var r=t[e+1]>>3&3,l=t[e+1]>>1&3,u=t[e+2]>>4&15,d=t[e+2]>>2&3;if(1!==r&&0!==u&&15!==u&&3!==d){var c=t[e+2]>>1&1,f=t[e+3]>>6,h=1e3*n[14*(3===r?3-l:3===l?3:4)+u-1],$=a[3*(3===r?0:2===r?1:2)+d],g=s[r][l],v=o[l];if(null===i){var p=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);i=p?parseInt(p[1]):0}return i&&i<=87&&2===l&&h>=224e3&&0===f&&(t[e+3]=128|t[e+3]),{sampleRate:$,channelCount:3===f?1:2,frameLength:Math.floor(g*h/$+c)*v,samplesPerFrame:8*g*v}}}function d(t,e){return 255===t[e]&&(224&t[e+1])==224&&(6&t[e+1])!=0}function c(t,e){return e+1<t.length&&d(t,e)}function f(t,e){return d(t,e)&&4<=t.length-e}function h(t,e){if(e+1<t.length&&d(t,e)){var r=u(t,e),i=4;null!=r&&r.frameLength&&(i=r.frameLength);var n=e+i;return n===t.length||c(t,n)}return!1}},"./src/demux/sample-aes.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>s});var i=r(/*! ../crypt/decrypter */ "./src/crypt/decrypter.ts"),n=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),a=function(){function t(t,e,r){this.keyData=void 0,this.decrypter=void 0,this.keyData=r,this.decrypter=new i.default(t,e,{removePKCS7Padding:!1})}var e=t.prototype;return e.decryptBuffer=function t(e,r){this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,r)},e.decryptAacSample=function t(e,r,i,n){var a=e[r].unit;if(!(a.length<=16)){var s=a.subarray(16,a.length-a.length%16),o=s.buffer.slice(s.byteOffset,s.byteOffset+s.length),l=this;this.decryptBuffer(o,function(t){var s=new Uint8Array(t);a.set(s,16),n||l.decryptAacSamples(e,r+1,i)})}},e.decryptAacSamples=function t(e,r,i){for(;;r++){if(r>=e.length){i();return}if(!(e[r].unit.length<32)){var n=this.decrypter.isSync();if(this.decryptAacSample(e,r,i,n),!n)return}}},e.getAvcEncryptedData=function t(e){for(var r=16*Math.floor((e.length-48)/160)+16,i=new Int8Array(r),n=0,a=32;a<e.length-16;a+=160,n+=16)i.set(e.subarray(a,a+16),n);return i},e.getAvcDecryptedUnit=function t(e,r){for(var i=new Uint8Array(r),n=0,a=32;a<e.length-16;a+=160,n+=16)e.set(i.subarray(n,n+16),a);return e},e.decryptAvcSample=function t(e,r,i,a,s,o){var l=(0,n.discardEPB)(s.data),u=this.getAvcEncryptedData(l),d=this;this.decryptBuffer(u.buffer,function(t){s.data=d.getAvcDecryptedUnit(l,t),o||d.decryptAvcSamples(e,r,i+1,a)})},e.decryptAvcSamples=function t(e,r,i,n){if(e instanceof Uint8Array)throw Error("Cannot decrypt samples of type Uint8Array");for(;;r++,i=0){if(r>=e.length){n();return}for(var a=e[r].units;!(i>=a.length);i++){var s=a[i];if(!(s.data.length<=48)&&(1===s.type||5===s.type)){var o=this.decrypter.isSync();if(this.decryptAvcSample(e,r,i,n,s,o),!o)return}}}},t}();let s=a},"./src/demux/transmuxer-interface.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>c});var i=r(/*! ./webworkify-webpack */ "./src/demux/webworkify-webpack.js"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../demux/transmuxer */ "./src/demux/transmuxer.ts"),s=r(/*! ../utils/logger */ "./src/utils/logger.ts"),o=r(/*! ../errors */ "./src/errors.ts"),l=r(/*! ../utils/mediasource-helper */ "./src/utils/mediasource-helper.ts"),u=r(/*! eventemitter3 */ "./node_modules/eventemitter3/index.js"),d=(0,l.getMediaSource)()||{isTypeSupported:function t(){return!1}},c=function(){function t(t,e,r,l){var c,f=this;this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.worker=void 0,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var h=t.config;this.hls=t,this.id=e,this.useWorker=!!h.enableWorker,this.onTransmuxComplete=r,this.onFlush=l;var $=function t(e,r){(r=r||{}).frag=f.frag,r.id=f.id,f.hls.trigger(e,r)};this.observer=new u.EventEmitter,this.observer.on(n.Events.FRAG_DECRYPTED,$),this.observer.on(n.Events.ERROR,$);var g={mp4:d.isTypeSupported("video/mp4"),mpeg:d.isTypeSupported("audio/mpeg"),mp3:d.isTypeSupported('audio/mp4; codecs="mp3"')},v=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){s.logger.log("demuxing in webworker");try{c=this.worker=(0,i.default)(/*! ../demux/transmuxer-worker.ts */ "./src/demux/transmuxer-worker.ts"),this.onwmsg=this.onWorkerMessage.bind(this),c.addEventListener("message",this.onwmsg),c.onerror=function(t){f.useWorker=!1,s.logger.warn("Exception in webworker, fallback to inline"),f.hls.trigger(n.Events.ERROR,{type:o.ErrorTypes.OTHER_ERROR,details:o.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:Error(t.message+"  ("+t.filename+":"+t.lineno+")")})},c.postMessage({cmd:"init",typeSupported:g,vendor:v,id:e,config:JSON.stringify(h)})}catch(p){s.logger.warn("Error in worker:",p),s.logger.error("Error while initializing DemuxerWorker, fallback to inline"),c&&self.URL.revokeObjectURL(c.objectURL),this.transmuxer=new a.default(this.observer,g,h,v,e),this.worker=null}}else this.transmuxer=new a.default(this.observer,g,h,v,e)}var e=t.prototype;return e.destroy=function t(){var e=this.worker;if(e)e.removeEventListener("message",this.onwmsg),e.terminate(),this.worker=null,this.onwmsg=void 0;else{var r=this.transmuxer;r&&(r.destroy(),this.transmuxer=null)}var i=this.observer;i&&i.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},e.push=function t(e,r,i,n,o,l,u,d,c,f){var h,$,g=this;c.transmuxing.start=self.performance.now();var v=this.transmuxer,p=this.worker,m=l?l.start:o.start,x=o.decryptdata,T=this.frag,E=!(T&&o.cc===T.cc),y=!(T&&c.level===T.level),S=T?c.sn-T.sn:-1,L=this.part?c.part-this.part.index:-1,b=0===S&&c.id>1&&c.id===(null==T?void 0:T.stats.chunkCount),D=!y&&(1===S||0===S&&(1===L||b&&L<=0)),_=self.performance.now();(y||S||0===o.stats.parsing.start)&&(o.stats.parsing.start=_),l&&(L||!D)&&(l.stats.parsing.start=_);var k=!(T&&(null===(h=o.initSegment)||void 0===h?void 0:h.url)===(null===($=T.initSegment)||void 0===$?void 0:$.url)),A=new a.TransmuxState(E,D,d,y,m,k);if(!D||E||k){s.logger.log("[transmuxer-interface, "+o.type+"]: Starting new transmux session for sn: "+c.sn+" p: "+c.part+" level: "+c.level+" id: "+c.id+"\n        discontinuity: "+E+"\n        trackSwitch: "+y+"\n        contiguous: "+D+"\n        accurateTimeOffset: "+d+"\n        timeOffset: "+m+"\n        initSegmentChange: "+k);var I=new a.TransmuxConfig(i,n,r,u,f);this.configureTransmuxer(I)}if(this.frag=o,this.part=l,p)p.postMessage({cmd:"demux",data:e,decryptdata:x,chunkMeta:c,state:A},e instanceof ArrayBuffer?[e]:[]);else if(v){var R=v.push(e,x,c,A);(0,a.isPromise)(R)?R.then(function(t){g.handleTransmuxComplete(t)}):this.handleTransmuxComplete(R)}},e.flush=function t(e){var r=this;e.transmuxing.start=self.performance.now();var i=this.transmuxer,n=this.worker;if(n)n.postMessage({cmd:"flush",chunkMeta:e});else if(i){var s=i.flush(e);(0,a.isPromise)(s)?s.then(function(t){r.handleFlushResult(t,e)}):this.handleFlushResult(s,e)}},e.handleFlushResult=function t(e,r){var i=this;e.forEach(function(t){i.handleTransmuxComplete(t)}),this.onFlush(r)},e.onWorkerMessage=function t(e){var r=e.data,i=this.hls;switch(r.event){case"init":self.URL.revokeObjectURL(this.worker.objectURL);break;case"transmuxComplete":this.handleTransmuxComplete(r.data);break;case"flush":this.onFlush(r.data);break;case"workerLog":s.logger[r.data.logType]&&s.logger[r.data.logType](r.data.message);break;default:r.data=r.data||{},r.data.frag=this.frag,r.data.id=this.id,i.trigger(r.event,r.data)}},e.configureTransmuxer=function t(e){var r=this.worker,i=this.transmuxer;r?r.postMessage({cmd:"configure",config:e}):i&&i.configure(e)},e.handleTransmuxComplete=function t(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)},t}()},"./src/demux/transmuxer-worker.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>o});var i=r(/*! ../demux/transmuxer */ "./src/demux/transmuxer.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../utils/logger */ "./src/utils/logger.ts"),s=r(/*! eventemitter3 */ "./node_modules/eventemitter3/index.js");function o(t){var e=new s.EventEmitter,r=function e(r,i){t.postMessage({event:r,data:i})};e.on(n.Events.FRAG_DECRYPTED,r),e.on(n.Events.ERROR,r);var o=function t(){var e=function t(e){var i=function t(i){r("workerLog",{logType:e,message:i})};a.logger[e]=i};for(var i in a.logger)e(i)};t.addEventListener("message",function(n){var s=n.data;switch(s.cmd){case"init":var u=JSON.parse(s.config);t.transmuxer=new i.default(e,s.typeSupported,u,s.vendor,s.id),(0,a.enableLogs)(u.debug,s.id),o(),r("init",null);break;case"configure":t.transmuxer.configure(s.config);break;case"demux":var c=t.transmuxer.push(s.data,s.decryptdata,s.chunkMeta,s.state);(0,i.isPromise)(c)?c.then(function(e){l(t,e)}):l(t,c);break;case"flush":var f=s.chunkMeta,h=t.transmuxer.flush(f);(0,i.isPromise)(h)?h.then(function(e){d(t,e,f)}):d(t,h,f)}})}function l(t,e){if(r=e.remuxResult,!r.audio&&!r.video&&!r.text&&!r.id3&&!r.initSegment)return!1;var r,i=[],n=e.remuxResult,a=n.audio,s=n.video;return a&&u(i,a),s&&u(i,s),t.postMessage({event:"transmuxComplete",data:e},i),!0}function u(t,e){e.data1&&t.push(e.data1.buffer),e.data2&&t.push(e.data2.buffer)}function d(t,e,r){e.reduce(function(e,r){return l(t,r)||e},!1)||t.postMessage({event:"transmuxComplete",data:e[0]}),t.postMessage({event:"flush",data:r})}},"./src/demux/transmuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{TransmuxConfig:()=>x,TransmuxState:()=>T,default:()=>v,isPromise:()=>m});var i,n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../errors */ "./src/errors.ts"),s=r(/*! ../crypt/decrypter */ "./src/crypt/decrypter.ts"),o=r(/*! ../demux/aacdemuxer */ "./src/demux/aacdemuxer.ts"),l=r(/*! ../demux/mp4demuxer */ "./src/demux/mp4demuxer.ts"),u=r(/*! ../demux/tsdemuxer */ "./src/demux/tsdemuxer.ts"),d=r(/*! ../demux/mp3demuxer */ "./src/demux/mp3demuxer.ts"),c=r(/*! ../remux/mp4-remuxer */ "./src/remux/mp4-remuxer.ts"),f=r(/*! ../remux/passthrough-remuxer */ "./src/remux/passthrough-remuxer.ts"),h=r(/*! ../utils/logger */ "./src/utils/logger.ts");try{i=self.performance.now.bind(self.performance)}catch($){h.logger.debug("Unable to use Performance API on this environment"),i=self.Date.now}var g=[{demux:u.default,remux:c.default},{demux:l.default,remux:f.default},{demux:o.default,remux:c.default},{demux:d.default,remux:c.default}],v=function(){function t(t,e,r,i,n){this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=r,this.vendor=i,this.id=n}var e=t.prototype;return e.configure=function t(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()},e.push=function t(e,r,n,a){var s=this,o=n.transmuxing;o.executeStart=i();var l=new Uint8Array(e),u=this.config,d=this.currentTransmuxState,c=this.transmuxConfig;a&&(this.currentTransmuxState=a);var f,h,$,g=a||d,v=g.contiguous,m=g.discontinuity,x=g.trackSwitch,T=g.accurateTimeOffset,E=g.timeOffset,y=g.initSegmentChange,S=c.audioCodec,L=c.videoCodec,b=c.defaultInitPts,D=c.duration,_=c.initSegmentData;(m||x||y)&&this.resetInitSegment(_,S,L,D),(m||y)&&this.resetInitialTimestamp(b),v||this.resetContiguity();var k=(f=l,h=r,$=null,f.byteLength>0&&null!=h&&null!=h.key&&null!==h.iv&&null!=h.method&&($=h),$);if(k&&"AES-128"===k.method){var A=this.getDecrypter();if(!u.enableSoftwareAES)return this.decryptionPromise=A.webCryptoDecrypt(l,k.key.buffer,k.iv.buffer).then(function(t){var e=s.push(t,null,n);return s.decryptionPromise=null,e}),this.decryptionPromise;var I=A.softwareDecrypt(l,k.key.buffer,k.iv.buffer);if(!I)return o.executeEnd=i(),p(n);l=new Uint8Array(I)}this.needsProbing(l,m,x)&&this.configureTransmuxer(l,c);var R=this.transmux(l,k,E,T,n),C=this.currentTransmuxState;return C.contiguous=!0,C.discontinuity=!1,C.trackSwitch=!1,o.executeEnd=i(),R},e.flush=function t(e){var r=this,s=e.transmuxing;s.executeStart=i();var o=this.decrypter,l=this.currentTransmuxState,u=this.decryptionPromise;if(u)return u.then(function(){return r.flush(e)});var d=[],c=l.timeOffset;if(o){var f=o.flush();f&&d.push(this.push(f,null,e))}var h=this.demuxer,$=this.remuxer;if(!h||!$)return this.observer.emit(n.Events.ERROR,n.Events.ERROR,{type:a.ErrorTypes.MEDIA_ERROR,details:a.ErrorDetails.FRAG_PARSING_ERROR,fatal:!0,reason:"no demux matching with content found"}),s.executeEnd=i(),[p(e)];var g=h.flush(c);return m(g)?g.then(function(t){return r.flushRemux(d,t,e),d}):(this.flushRemux(d,g,e),d)},e.flushRemux=function t(e,r,n){var a=r.audioTrack,s=r.videoTrack,o=r.id3Track,l=r.textTrack,u=this.currentTransmuxState,d=u.accurateTimeOffset,c=u.timeOffset;h.logger.log("[transmuxer.ts]: Flushed fragment "+n.sn+(n.part>-1?" p: "+n.part:"")+" of level "+n.level);var f=this.remuxer.remux(a,s,o,l,c,d,!0,this.id);e.push({remuxResult:f,chunkMeta:n}),n.transmuxing.executeEnd=i()},e.resetInitialTimestamp=function t(e){var r=this.demuxer,i=this.remuxer;r&&i&&(r.resetTimeStamp(e),i.resetTimeStamp(e))},e.resetContiguity=function t(){var e=this.demuxer,r=this.remuxer;e&&r&&(e.resetContiguity(),r.resetNextTimestamp())},e.resetInitSegment=function t(e,r,i,n){var a=this.demuxer,s=this.remuxer;a&&s&&(a.resetInitSegment(e,r,i,n),s.resetInitSegment(e,r,i))},e.destroy=function t(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},e.transmux=function t(e,r,i,n,a){var s;return r&&"SAMPLE-AES"===r.method?this.transmuxSampleAes(e,r,i,n,a):this.transmuxUnencrypted(e,i,n,a)},e.transmuxUnencrypted=function t(e,r,i,n){var a=this.demuxer.demux(e,r,!1,!this.config.progressive),s=a.audioTrack,o=a.videoTrack,l=a.id3Track,u=a.textTrack;return{remuxResult:this.remuxer.remux(s,o,l,u,r,i,!1,this.id),chunkMeta:n}},e.transmuxSampleAes=function t(e,r,i,n,a){var s=this;return this.demuxer.demuxSampleAes(e,r,i).then(function(t){return{remuxResult:s.remuxer.remux(t.audioTrack,t.videoTrack,t.id3Track,t.textTrack,i,n,!1,s.id),chunkMeta:a}})},e.configureTransmuxer=function t(e,r){for(var i,n=this.config,a=this.observer,s=this.typeSupported,o=this.vendor,u=r.audioCodec,d=r.defaultInitPts,c=r.duration,$=r.initSegmentData,v=r.videoCodec,p=0,m=g.length;p<m;p++)if(g[p].demux.probe(e)){i=g[p];break}i||(h.logger.warn("Failed to find demuxer by probing frag, treating as mp4 passthrough"),i={demux:l.default,remux:f.default});var x=this.demuxer,T=this.remuxer,E=i.remux,y=i.demux;T&&T instanceof E||(this.remuxer=new E(a,n,s,o)),x&&x instanceof y||(this.demuxer=new y(a,n,s),this.probe=y.probe),this.resetInitSegment($,u,v,c),this.resetInitialTimestamp(d)},e.needsProbing=function t(e,r,i){return!this.demuxer||!this.remuxer||r||i},e.getDecrypter=function t(){var e=this.decrypter;return e||(e=this.decrypter=new s.default(this.observer,this.config)),e},t}(),p=function t(e){return{remuxResult:{},chunkMeta:e}};function m(t){return"then"in t&&t.then instanceof Function}var x=function t(e,r,i,n,a){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=r,this.initSegmentData=i,this.duration=n,this.defaultInitPts=a},T=function t(e,r,i,n,a,s){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=r,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=a,this.initSegmentChange=s}},"./src/demux/tsdemuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>x});var i=r(/*! ./adts */ "./src/demux/adts.ts"),n=r(/*! ./mpegaudio */ "./src/demux/mpegaudio.ts"),a=r(/*! ./exp-golomb */ "./src/demux/exp-golomb.ts"),s=r(/*! ./sample-aes */ "./src/demux/sample-aes.ts"),o=r(/*! ../events */ "./src/events.ts"),l=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),u=r(/*! ../utils/logger */ "./src/utils/logger.ts"),d=r(/*! ../errors */ "./src/errors.ts"),c=r(/*! ../types/demuxer */ "./src/types/demuxer.ts");function f(){return(f=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}var h=function(){function t(t,e,r){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=t,this.config=e,this.typeSupported=r}t.probe=function e(r){var i=t.syncOffset(r);return i>0&&u.logger.warn("MPEG2-TS detected but first sync word found @ offset "+i),-1!==i},t.syncOffset=function t(e){for(var r=Math.min(940,e.length-376)+1,i=0;i<r;){if(71===e[i]&&71===e[i+188])return i;i++}return -1},t.createTrack=function t(e,r){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:l.RemuxerTrackIdConfig[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?r:void 0}};var e=t.prototype;return e.resetInitSegment=function e(r,i,n,a){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=t.createTrack("video"),this._audioTrack=t.createTrack("audio",a),this._id3Track=t.createTrack("id3"),this._txtTrack=t.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=i,this.videoCodec=n,this._duration=a},e.resetTimeStamp=function t(){},e.resetContiguity=function t(){var e=this._audioTrack,r=this._avcTrack,i=this._id3Track;e&&(e.pesData=null),r&&(r.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},e.demux=function e(r,i,n,a){void 0===n&&(n=!1),void 0===a&&(a=!1),n||(this.sampleAes=null);var s,c=this._avcTrack,f=this._audioTrack,h=this._id3Track,$=this._txtTrack,m=c.pid,x=c.pesData,T=f.pid,E=h.pid,y=f.pesData,S=h.pesData,L=null,b=this.pmtParsed,D=this._pmtId,_=r.length;if(this.remainderData&&(_=(r=(0,l.appendUint8Array)(this.remainderData,r)).length,this.remainderData=null),_<188&&!a)return this.remainderData=r,{audioTrack:f,videoTrack:c,id3Track:h,textTrack:$};var k=Math.max(0,t.syncOffset(r));(_-=(_-k)%188)<r.byteLength&&!a&&(this.remainderData=new Uint8Array(r.buffer,_,r.buffer.byteLength-_));for(var A=0,I=k;I<_;I+=188)if(71===r[I]){var R=!!(64&r[I+1]),C=((31&r[I+1])<<8)+r[I+2],w=(48&r[I+3])>>4,P=void 0;if(w>1){if((P=I+5+r[I+4])===I+188)continue}else P=I+4;switch(C){case m:R&&(x&&(s=p(x))&&this.parseAVCPES(c,$,s,!1),x={data:[],size:0}),x&&(x.data.push(r.subarray(P,I+188)),x.size+=I+188-P);break;case T:if(R){if(y&&(s=p(y)))switch(f.segmentCodec){case"aac":this.parseAACPES(f,s);break;case"mp3":this.parseMPEGPES(f,s)}y={data:[],size:0}}y&&(y.data.push(r.subarray(P,I+188)),y.size+=I+188-P);break;case E:R&&(S&&(s=p(S))&&this.parseID3PES(h,s),S={data:[],size:0}),S&&(S.data.push(r.subarray(P,I+188)),S.size+=I+188-P);break;case 0:R&&(P+=r[P]+1),D=this._pmtId=g(r,P);break;case D:R&&(P+=r[P]+1);var F=v(r,P,this.typeSupported,n);(m=F.avc)>0&&(c.pid=m),(T=F.audio)>0&&(f.pid=T,f.segmentCodec=F.segmentCodec),(E=F.id3)>0&&(h.pid=E),null===L||b||(u.logger.log("unknown PID '"+L+"' in TS found"),L=null,I=k-188),b=this.pmtParsed=!0;break;case 17:case 8191:break;default:L=C}}else A++;A>0&&this.observer.emit(o.Events.ERROR,o.Events.ERROR,{type:d.ErrorTypes.MEDIA_ERROR,details:d.ErrorDetails.FRAG_PARSING_ERROR,fatal:!1,reason:"Found "+A+" TS packet/s that do not start with 0x47"}),c.pesData=x,f.pesData=y,h.pesData=S;var O={audioTrack:f,videoTrack:c,id3Track:h,textTrack:$};return a&&this.extractRemainingSamples(O),O},e.flush=function t(){var e,r=this.remainderData;return(this.remainderData=null,e=r?this.demux(r,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes)?this.decrypt(e,this.sampleAes):e},e.extractRemainingSamples=function t(e){var r,i=e.audioTrack,n=e.videoTrack,a=e.id3Track,s=e.textTrack,o=n.pesData,l=i.pesData,d=a.pesData;if(o&&(r=p(o))?(this.parseAVCPES(n,s,r,!0),n.pesData=null):n.pesData=o,l&&(r=p(l))){switch(i.segmentCodec){case"aac":this.parseAACPES(i,r);break;case"mp3":this.parseMPEGPES(i,r)}i.pesData=null}else null!=l&&l.size&&u.logger.log("last AAC PES packet truncated,might overlap between fragments"),i.pesData=l;d&&(r=p(d))?(this.parseID3PES(a,r),a.pesData=null):a.pesData=d},e.demuxSampleAes=function t(e,r,i){var n=this.demux(e,i,!0,!this.config.progressive),a=this.sampleAes=new s.default(this.observer,this.config,r);return this.decrypt(n,a)},e.decrypt=function t(e,r){return new Promise(function(t){var i=e.audioTrack,n=e.videoTrack;i.samples&&"aac"===i.segmentCodec?r.decryptAacSamples(i.samples,0,function(){n.samples?r.decryptAvcSamples(n.samples,0,0,function(){t(e)}):t(e)}):n.samples&&r.decryptAvcSamples(n.samples,0,0,function(){t(e)})})},e.destroy=function t(){this._duration=0},e.parseAVCPES=function t(e,r,i,n){var s,o=this,u=this.parseAVCNALu(e,i.data),d=this.avcSample,c=!1;i.data=null,d&&u.length&&!e.audFound&&(m(d,e),d=this.avcSample=$(!1,i.pts,i.dts,"")),u.forEach(function(t){switch(t.type){case 1:s=!0,d||(d=o.avcSample=$(!0,i.pts,i.dts,"")),d.frame=!0;var n=t.data;if(c&&n.length>4){var u=new a.default(n).readSliceType();(2===u||4===u||7===u||9===u)&&(d.key=!0)}break;case 5:s=!0,d||(d=o.avcSample=$(!0,i.pts,i.dts,"")),d.key=!0,d.frame=!0;break;case 6:s=!0,(0,l.parseSEIMessageFromNALu)(t.data,1,i.pts,r.samples);break;case 7:if(s=!0,c=!0,!e.sps){var f=new a.default(t.data).readSPS();e.width=f.width,e.height=f.height,e.pixelRatio=f.pixelRatio,e.sps=[t.data],e.duration=o._duration;for(var h=t.data.subarray(1,4),g="avc1.",v=0;v<3;v++){var p=h[v].toString(16);p.length<2&&(p="0"+p),g+=p}e.codec=g}break;case 8:s=!0,e.pps||(e.pps=[t.data]);break;case 9:s=!1,e.audFound=!0,d&&m(d,e),d=o.avcSample=$(!1,i.pts,i.dts,"");break;case 12:s=!0;break;default:s=!1,d&&(d.debug+="unknown NAL "+t.type+" ")}d&&s&&d.units.push(t)}),n&&d&&(m(d,e),this.avcSample=null)},e.getLastNalUnit=function t(e){var r,i,n=this.avcSample;if(n&&0!==n.units.length||(n=e[e.length-1]),null!==(r=n)&&void 0!==r&&r.units){var a=n.units;i=a[a.length-1]}return i},e.parseAVCNALu=function t(e,r){var i,n,a,s=r.byteLength,o=e.naluState||0,l=o,u=[],d=0,c=-1,f=0;for(-1===o&&(c=0,f=31&r[0],o=0,d=1);d<s;){if(i=r[d++],!o){o=i?0:1;continue}if(1===o){o=i?0:2;continue}if(i){if(1===i){if(c>=0){var h={data:r.subarray(c,d-o-1),type:f};u.push(h)}else{var $=this.getLastNalUnit(e.samples);if($&&(l&&d<=4-l&&$.state&&($.data=$.data.subarray(0,$.data.byteLength-l)),(n=d-o-1)>0)){var g=new Uint8Array($.data.byteLength+n);g.set($.data,0),g.set(r.subarray(0,n),$.data.byteLength),$.data=g,$.state=0}}d<s?(a=31&r[d],c=d,f=a,o=0):o=-1}else o=0}else o=3}if(c>=0&&o>=0){var v={data:r.subarray(c,s),type:f,state:o};u.push(v)}if(0===u.length){var p=this.getLastNalUnit(e.samples);if(p){var m=new Uint8Array(p.data.byteLength+r.byteLength);m.set(p.data,0),m.set(r,p.data.byteLength),p.data=m}}return e.naluState=o,u},e.parseAACPES=function t(e,r){var n,a,s,l,c,f,h=0,$=this.aacOverFlow,g=r.data;if($){this.aacOverFlow=null;var v=$.missing,p=$.sample.unit.byteLength;if(-1===v){var m=new Uint8Array(p+g.byteLength);m.set($.sample.unit,0),m.set(g,p),g=m}else $.sample.unit.set(g.subarray(0,v),p-v),e.samples.push($.sample),h=$.missing}for(n=h,a=g.length;n<a-1&&!i.isHeader(g,n);n++);if(n===h||(n<a-1?(s="AAC PES did not start with ADTS header,offset:"+n,l=!1):(s="no ADTS header found in AAC PES",l=!0),u.logger.warn("parsing error:"+s),this.observer.emit(o.Events.ERROR,o.Events.ERROR,{type:d.ErrorTypes.MEDIA_ERROR,details:d.ErrorDetails.FRAG_PARSING_ERROR,fatal:l,reason:s}),!l)){if(i.initTrackConfig(e,this.observer,g,n,this.audioCodec),void 0!==r.pts)c=r.pts;else if($){var x=i.getFrameDuration(e.samplerate);c=$.sample.pts+x}else{u.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var T=0;n<a;){if(f=i.appendFrame(e,g,n,c,T),n+=f.length,f.missing){this.aacOverFlow=f;break}for(T++;n<a-1&&!i.isHeader(g,n);n++);}}},e.parseMPEGPES=function t(e,r){var i=r.data,a=i.length,s=0,o=0,l=r.pts;if(void 0===l){u.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<a;)if(n.isHeader(i,o)){var d=n.appendFrame(e,i,o,l,s);if(d)o+=d.length,s++;else break}else o++},e.parseID3PES=function t(e,r){if(void 0===r.pts){u.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var i=f({},r,{type:this._avcTrack?c.MetadataSchema.emsg:c.MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)},t}();function $(t,e,r,i){return{key:t,frame:!1,pts:e,dts:r,units:[],debug:i,length:0}}function g(t,e){return(31&t[e+10])<<8|t[e+11]}function v(t,e,r,i){var n={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},a=(15&t[e+1])<<8|t[e+2],s=e+3+a-4,o=(15&t[e+10])<<8|t[e+11];for(e+=12+o;e<s;){var l=(31&t[e+1])<<8|t[e+2];switch(t[e]){case 207:if(!i){u.logger.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===n.audio&&(n.audio=l);break;case 21:-1===n.id3&&(n.id3=l);break;case 219:if(!i){u.logger.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===n.avc&&(n.avc=l);break;case 3:case 4:!0!==r.mpeg&&!0!==r.mp3?u.logger.log("MPEG audio found, not supported in this browser"):-1===n.audio&&(n.audio=l,n.segmentCodec="mp3");break;case 36:u.logger.warn("Unsupported HEVC stream type found")}e+=((15&t[e+3])<<8|t[e+4])+5}return n}function p(t){var e,r,i,n,a,s=0,o=t.data;if(!t||0===t.size)return null;for(;o[0].length<19&&o.length>1;){var l=new Uint8Array(o[0].length+o[1].length);l.set(o[0]),l.set(o[1],o[0].length),o[0]=l,o.splice(1,1)}if(1===((e=o[0])[0]<<16)+(e[1]<<8)+e[2]){if((r=(e[4]<<8)+e[5])&&r>t.size-6)return null;var d=e[7];192&d&&(n=(14&e[9])*536870912+(255&e[10])*4194304+(254&e[11])*16384+(255&e[12])*128+(254&e[13])/2,64&d?n-(a=(14&e[14])*536870912+(255&e[15])*4194304+(254&e[16])*16384+(255&e[17])*128+(254&e[18])/2)>54e5&&(u.logger.warn(Math.round((n-a)/9e4)+"s delta between PTS and DTS, align them"),n=a):a=n);var c=(i=e[8])+9;if(t.size<=c)return null;t.size-=c;for(var f=new Uint8Array(t.size),h=0,$=o.length;h<$;h++){var g=(e=o[h]).byteLength;if(c){if(c>g){c-=g;continue}e=e.subarray(c),g-=c,c=0}f.set(e,s),s+=g}return r&&(r-=i+3),{data:f,pts:n,dts:a,len:r}}return null}function m(t,e){if(t.units.length&&t.frame){if(void 0===t.pts){var r=e.samples,i=r.length;if(i){var n=r[i-1];t.pts=n.pts,t.dts=n.dts}else{e.dropped++;return}}e.samples.push(t)}t.debug.length&&u.logger.log(t.pts+"/"+t.dts+":"+t.debug)}let x=h},"./src/demux/webworkify-webpack.js"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>c});var i=(function t(){var e=ENTRY_MODULE,r={},i=function t(i){var n=r[i];if(void 0!==n)return n.exports;var a=r[i]={exports:{}};return e[i].call(a.exports,a,a.exports,t),a.exports};i.m=e,i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,{a:e}),e},i.d=function(t,e){for(var r in e)i.o(e,r)&&!i.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n=i(ENTRY_MODULE);return n.default||n}).toString().split("ENTRY_MODULE"),n="[\\.|\\-|\\+|\\w|/|@]+",a="\\(\\s*(/\\*.*?\\*/)?\\s*.*?("+n+").*?\\)";function s(t){return(t+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(t){return!isNaN(1*t)}function l(t,e,i){var l,u={};u[i]=[];var d=e.toString().replace(/^"[^"]+"/,"function"),c=d.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/)||d.match(/^\(\w+,\s*\w+,\s*(\w+)\)\s?\=\s?\>/);if(!c)return u;for(var f=c[1],h=RegExp("(\\\\n|\\W)"+s(f)+a,"g");l=h.exec(d);)"dll-reference"!==l[3]&&u[i].push(l[3]);for(h=RegExp("\\("+s(f)+'\\("(dll-reference\\s('+n+'))"\\)\\)'+a,"g");l=h.exec(d);)t[l[2]]||(u[i].push(l[1]),t[l[2]]=r(l[1]).m),u[l[2]]=u[l[2]]||[],u[l[2]].push(l[4]);for(var $=Object.keys(u),g=0;g<$.length;g++)for(var v=0;v<u[$[g]].length;v++)o(u[$[g]][v])&&(u[$[g]][v]=1*u[$[g]][v]);return u}function u(t){return Object.keys(t).reduce(function(e,r){return e||t[r].length>0},!1)}function d(t,e,r,n){var a=t[n].map(function(t){return'"'+t+'": '+e[n][t].toString().replace(/^"[^"]+"/,"function")}).join(",");return i[0]+"{"+a+"}"+i[1]+'"'+r+'"'+i[2]}function c(t,e){e=e||{};var i={main:r.m},n=e.all?{main:Object.keys(i.main)}:function t(e,r){for(var i={main:[r]},n={main:[]},a={main:{}};u(i);)for(var s=Object.keys(i),o=0;o<s.length;o++){var d=s[o],c=i[d].pop();if(a[d]=a[d]||{},!a[d][c]&&e[d][c]){a[d][c]=!0,n[d]=n[d]||[],n[d].push(c);for(var f=l(e,e[d][c],d),h=Object.keys(f),$=0;$<h.length;$++)i[h[$]]=i[h[$]]||[],i[h[$]]=i[h[$]].concat(f[h[$]])}}return n}(i,t),a="";Object.keys(n).filter(function(t){return"main"!==t}).forEach(function(t){for(var e=0;n[t][e];)e++;n[t].push(e),i[t][e]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",a=a+("var "+t+" = (")+d(n,i,e,modules)+")();\n"}),a=a+"new (("+d(n,i,t,"main")+")())(self);";var s=new window.Blob([a],{type:"text/javascript"}),o=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(s),c=new window.Worker(o);return c.objectURL=o,c}},"./src/errors.ts"(t,e,r){"use strict";var i,n,a,s;r.r(e),r.d(e,{ErrorDetails:()=>n,ErrorTypes:()=>i}),(a=i||(i={})).NETWORK_ERROR="networkError",a.MEDIA_ERROR="mediaError",a.KEY_SYSTEM_ERROR="keySystemError",a.MUX_ERROR="muxError",a.OTHER_ERROR="otherError",(s=n||(n={})).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",s.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",s.KEY_SYSTEM_NO_SESSION="keySystemNoSession",s.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",s.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",s.MANIFEST_LOAD_ERROR="manifestLoadError",s.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",s.MANIFEST_PARSING_ERROR="manifestParsingError",s.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",s.LEVEL_EMPTY_ERROR="levelEmptyError",s.LEVEL_LOAD_ERROR="levelLoadError",s.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",s.LEVEL_SWITCH_ERROR="levelSwitchError",s.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",s.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",s.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",s.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",s.FRAG_LOAD_ERROR="fragLoadError",s.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",s.FRAG_DECRYPT_ERROR="fragDecryptError",s.FRAG_PARSING_ERROR="fragParsingError",s.REMUX_ALLOC_ERROR="remuxAllocError",s.KEY_LOAD_ERROR="keyLoadError",s.KEY_LOAD_TIMEOUT="keyLoadTimeOut",s.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",s.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",s.BUFFER_APPEND_ERROR="bufferAppendError",s.BUFFER_APPENDING_ERROR="bufferAppendingError",s.BUFFER_STALLED_ERROR="bufferStalledError",s.BUFFER_FULL_ERROR="bufferFullError",s.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",s.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",s.INTERNAL_EXCEPTION="internalException",s.INTERNAL_ABORTED="aborted",s.UNKNOWN="unknown"},"./src/events.ts"(t,e,r){"use strict";var i,n;r.r(e),r.d(e,{Events:()=>i}),(n=i||(i={})).MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached"},"./src/hls.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>v});var i=r(/*! url-toolkit */ "./node_modules/url-toolkit/src/url-toolkit.js"),n=r(/*! ./loader/playlist-loader */ "./src/loader/playlist-loader.ts"),a=r(/*! ./controller/latency-controller */ "./src/controller/latency-controller.ts"),s=r(/*! ./controller/level-controller */ "./src/controller/level-controller.ts"),o=r(/*! ./controller/fragment-tracker */ "./src/controller/fragment-tracker.ts"),l=r(/*! ./controller/stream-controller */ "./src/controller/stream-controller.ts"),u=r(/*! ./is-supported */ "./src/is-supported.ts"),d=r(/*! ./utils/logger */ "./src/utils/logger.ts"),c=r(/*! ./config */ "./src/config.ts"),f=r(/*! eventemitter3 */ "./node_modules/eventemitter3/index.js"),h=r(/*! ./events */ "./src/events.ts"),$=r(/*! ./errors */ "./src/errors.ts");function g(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var v=function(){function t(e){void 0===e&&(e={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new f.EventEmitter,this._autoLevelCapping=void 0,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null;var r=this.config=(0,c.mergeConfig)(t.DefaultConfig,e);this.userConfig=e,(0,d.enableLogs)(r.debug,"Hls instance"),this._autoLevelCapping=-1,r.progressive&&(0,c.enableStreamingMode)(r);var i=r.abrController,u=r.bufferController,h=r.capLevelController,$=this.abrController=new i(this),g=this.bufferController=new u(this),v=this.capLevelController=new h(this),p=new n.default(this),m=this.levelController=new s.default(this),x=new o.FragmentTracker(this),T=this.streamController=new l.default(this,x);v.setStreamController(T);var E=[p,m,T];this.networkControllers=E;var y=[$,g,v,x];this.audioTrackController=this.createController(r.audioTrackController,null,E),this.createController(r.audioStreamController,x,E),this.subtitleTrackController=this.createController(r.subtitleTrackController,null,E),this.createController(r.subtitleStreamController,x,E),this.createController(r.timelineController,null,y),this.emeController=this.createController(r.emeController,null,y),this.cmcdController=this.createController(r.cmcdController,null,y),this.latencyController=this.createController(a.default,null,y),this.coreComponents=y}t.isSupported=function t(){return(0,u.isSupported)()};var e,r,v,p=t.prototype;return p.createController=function t(e,r,i){if(e){var n=r?new e(this,r):new e(this);return i&&i.push(n),n}return null},p.on=function t(e,r,i){void 0===i&&(i=this),this._emitter.on(e,r,i)},p.once=function t(e,r,i){void 0===i&&(i=this),this._emitter.once(e,r,i)},p.removeAllListeners=function t(e){this._emitter.removeAllListeners(e)},p.off=function t(e,r,i,n){void 0===i&&(i=this),this._emitter.off(e,r,i,n)},p.listeners=function t(e){return this._emitter.listeners(e)},p.emit=function t(e,r,i){return this._emitter.emit(e,r,i)},p.trigger=function t(e,r){if(this.config.debug)return this.emit(e,e,r);try{return this.emit(e,e,r)}catch(i){d.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),this.trigger(h.Events.ERROR,{type:$.ErrorTypes.OTHER_ERROR,details:$.ErrorDetails.INTERNAL_EXCEPTION,fatal:!1,event:e,error:i})}return!1},p.listenerCount=function t(e){return this._emitter.listenerCount(e)},p.destroy=function t(){d.logger.log("destroy"),this.trigger(h.Events.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(t){return t.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(t){return t.destroy()}),this.coreComponents.length=0},p.attachMedia=function t(e){d.logger.log("attachMedia"),this._media=e,this.trigger(h.Events.MEDIA_ATTACHING,{media:e})},p.detachMedia=function t(){d.logger.log("detachMedia"),this.trigger(h.Events.MEDIA_DETACHING,void 0),this._media=null},p.loadSource=function t(e){this.stopLoad();var r=this.media,n=this.url,a=this.url=i.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});r&&n&&n!==a&&this.bufferController.hasSourceTypes()&&(this.detachMedia(),this.attachMedia(r)),this.trigger(h.Events.MANIFEST_LOADING,{url:e})},p.startLoad=function t(e){void 0===e&&(e=-1),d.logger.log("startLoad("+e+")"),this.networkControllers.forEach(function(t){t.startLoad(e)})},p.stopLoad=function t(){d.logger.log("stopLoad"),this.networkControllers.forEach(function(t){t.stopLoad()})},p.swapAudioCodec=function t(){d.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},p.recoverMediaError=function t(){d.logger.log("recoverMediaError");var e=this._media;this.detachMedia(),e&&this.attachMedia(e)},p.removeLevel=function t(e,r){void 0===r&&(r=0),this.levelController.removeLevel(e,r)},e=t,r=[{key:"levels",get:function t(){var e;return this.levelController.levels||[]}},{key:"currentLevel",get:function t(){return this.streamController.currentLevel},set:function t(e){d.logger.log("set currentLevel:"+e),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function t(){return this.streamController.nextLevel},set:function t(e){d.logger.log("set nextLevel:"+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function t(){return this.levelController.level},set:function t(e){d.logger.log("set loadLevel:"+e),this.levelController.manualLevel=e}},{key:"nextLoadLevel",get:function t(){return this.levelController.nextLoadLevel},set:function t(e){this.levelController.nextLoadLevel=e}},{key:"firstLevel",get:function t(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function t(e){d.logger.log("set firstLevel:"+e),this.levelController.firstLevel=e}},{key:"startLevel",get:function t(){return this.levelController.startLevel},set:function t(e){d.logger.log("set startLevel:"+e),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}},{key:"capLevelToPlayerSize",get:function t(){return this.config.capLevelToPlayerSize},set:function t(e){var r=!!e;r!==this.config.capLevelToPlayerSize&&(r?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=r)}},{key:"autoLevelCapping",get:function t(){return this._autoLevelCapping},set:function t(e){this._autoLevelCapping!==e&&(d.logger.log("set autoLevelCapping:"+e),this._autoLevelCapping=e)}},{key:"bandwidthEstimate",get:function t(){var e=this.abrController.bwEstimator;return e?e.getEstimate():NaN}},{key:"autoLevelEnabled",get:function t(){return -1===this.levelController.manualLevel}},{key:"manualLevel",get:function t(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function t(){var e=this.levels,r=this.config.minAutoBitrate;if(!e)return 0;for(var i=e.length,n=0;n<i;n++)if(e[n].maxBitrate>=r)return n;return 0}},{key:"maxAutoLevel",get:function t(){var e,r=this.levels,i=this.autoLevelCapping;return -1===i&&r&&r.length?r.length-1:i}},{key:"nextAutoLevel",get:function t(){return Math.min(Math.max(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function t(e){this.abrController.nextAutoLevel=Math.max(this.minAutoLevel,e)}},{key:"playingDate",get:function t(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function t(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function t(){var e=this.audioTrackController;return e?e.audioTracks:[]}},{key:"audioTrack",get:function t(){var e=this.audioTrackController;return e?e.audioTrack:-1},set:function t(e){var r=this.audioTrackController;r&&(r.audioTrack=e)}},{key:"subtitleTracks",get:function t(){var e=this.subtitleTrackController;return e?e.subtitleTracks:[]}},{key:"subtitleTrack",get:function t(){var e=this.subtitleTrackController;return e?e.subtitleTrack:-1},set:function t(e){var r=this.subtitleTrackController;r&&(r.subtitleTrack=e)}},{key:"media",get:function t(){return this._media}},{key:"subtitleDisplay",get:function t(){var e=this.subtitleTrackController;return!!e&&e.subtitleDisplay},set:function t(e){var r=this.subtitleTrackController;r&&(r.subtitleDisplay=e)}},{key:"lowLatencyMode",get:function t(){return this.config.lowLatencyMode},set:function t(e){this.config.lowLatencyMode=e}},{key:"liveSyncPosition",get:function t(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function t(){return this.latencyController.latency}},{key:"maxLatency",get:function t(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function t(){return this.latencyController.targetLatency}},{key:"drift",get:function t(){return this.latencyController.drift}},{key:"forceStartLoad",get:function t(){return this.streamController.forceStartLoad}}],v=[{key:"version",get:function t(){return"1.2.9"}},{key:"Events",get:function t(){return h.Events}},{key:"ErrorTypes",get:function t(){return $.ErrorTypes}},{key:"ErrorDetails",get:function t(){return $.ErrorDetails}},{key:"DefaultConfig",get:function e(){return t.defaultConfig?t.defaultConfig:c.hlsDefaultConfig},set:function e(r){t.defaultConfig=r}}],r&&g(e.prototype,r),v&&g(e,v),Object.defineProperty(e,"prototype",{writable:!1}),t}();v.defaultConfig=void 0},"./src/is-supported.ts"(t,e,r){"use strict";r.r(e),r.d(e,{changeTypeSupported:()=>s,isSupported:()=>a});var i=r(/*! ./utils/mediasource-helper */ "./src/utils/mediasource-helper.ts");function n(){return self.SourceBuffer||self.WebKitSourceBuffer}function a(){var t=(0,i.getMediaSource)();if(!t)return!1;var e=n(),r=t&&"function"==typeof t.isTypeSupported&&t.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),a=!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove;return!!r&&!!a}function s(){var t,e=n();return"function"==typeof(null==e?void 0:null===(t=e.prototype)||void 0===t?void 0:t.changeType)}},"./src/loader/date-range.ts"(t,e,r){"use strict";r.r(e),r.d(e,{DateRange:()=>d,DateRangeAttribute:()=>n});var i,n,a=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),s=r(/*! ../utils/attr-list */ "./src/utils/attr-list.ts"),o=r(/*! ../utils/logger */ "./src/utils/logger.ts");function l(){return(l=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function u(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}(i=n||(n={})).ID="ID",i.CLASS="CLASS",i.START_DATE="START-DATE",i.DURATION="DURATION",i.END_DATE="END-DATE",i.END_ON_NEXT="END-ON-NEXT",i.PLANNED_DURATION="PLANNED-DURATION",i.SCTE35_OUT="SCTE35-OUT",i.SCTE35_IN="SCTE35-IN";var d=function(){var t,e,r;function i(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){var r=e.attr;for(var i in r)if(Object.prototype.hasOwnProperty.call(t,i)&&t[i]!==r[i]){o.logger.warn('DATERANGE tag attribute: "'+i+'" does not match for tags with ID: "'+t.ID+'"'),this._badValueForSameId=i;break}t=l(new s.AttrList({}),r,t)}if(this.attr=t,this._startDate=new Date(t[n.START_DATE]),n.END_DATE in this.attr){var u=new Date(this.attr[n.END_DATE]);(0,a.isFiniteNumber)(u.getTime())&&(this._endDate=u)}}return t=i,e=[{key:"id",get:function t(){return this.attr.ID}},{key:"class",get:function t(){return this.attr.CLASS}},{key:"startDate",get:function t(){return this._startDate}},{key:"endDate",get:function t(){if(this._endDate)return this._endDate;var e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}},{key:"duration",get:function t(){if(n.DURATION in this.attr){var e=this.attr.decimalFloatingPoint(n.DURATION);if((0,a.isFiniteNumber)(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function t(){return n.PLANNED_DURATION in this.attr?this.attr.decimalFloatingPoint(n.PLANNED_DURATION):null}},{key:"endOnNext",get:function t(){return this.attr.bool(n.END_ON_NEXT)}},{key:"isValid",get:function t(){return!!this.id&&!this._badValueForSameId&&(0,a.isFiniteNumber)(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}],u(t.prototype,e),r&&u(t,r),Object.defineProperty(t,"prototype",{writable:!1}),i}()},"./src/loader/fragment-loader.ts"(t,e,r){"use strict";r.r(e),r.d(e,{LoadError:()=>c,default:()=>u});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../errors */ "./src/errors.ts");function a(t){var e="function"==typeof Map?new Map:void 0;return(a=function t(r){var i;if(null===r||(i=r,-1===Function.toString.call(i).indexOf("[native code]")))return r;if("function"!=typeof r)throw TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(r))return e.get(r);e.set(r,n)}function n(){return s(r,arguments,l(this).constructor)}return n.prototype=Object.create(r.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),o(n,r)})(t)}function s(t,e,r){return(s=!function t(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}()?function t(e,r,i){var n=[null];n.push.apply(n,r);var a=new(Function.bind.apply(e,n));return i&&o(a,i.prototype),a}:Reflect.construct.bind()).apply(null,arguments)}function o(t,e){return(o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function t(e){return e.__proto__||Object.getPrototypeOf(e)})(t)}var u=function(){function t(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}var e=t.prototype;return e.destroy=function t(){this.loader&&(this.loader.destroy(),this.loader=null)},e.abort=function t(){this.loader&&this.loader.abort()},e.load=function t(e,r){var i=this,a=e.url;if(!a)return Promise.reject(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,networkDetails:null},"Fragment does not have a "+(a?"part list":"url")));this.abort();var s=this.config,o=s.fLoader,l=s.loader;return new Promise(function(t,a){i.loader&&i.loader.destroy();var u=i.loader=e.loader=o?new o(s):new l(s),f=d(e),h={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:"initSegment"===e.sn?1/0:131072};e.stats=u.stats,u.load(f,h,{onSuccess:function r(n,a,s,o){i.resetLoader(e,u),t({frag:e,part:null,payload:n.data,networkDetails:o})},onError:function t(r,s,o){i.resetLoader(e,u),a(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:r,networkDetails:o}))},onAbort:function t(r,s,o){i.resetLoader(e,u),a(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,networkDetails:o}))},onTimeout:function t(r,s,o){i.resetLoader(e,u),a(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,networkDetails:o}))},onProgress:function t(i,n,a,s){r&&r({frag:e,part:null,payload:a,networkDetails:s})}})})},e.loadPart=function t(e,r,i){var a=this;this.abort();var s=this.config,o=s.fLoader,l=s.loader;return new Promise(function(t,u){a.loader&&a.loader.destroy();var f=a.loader=e.loader=o?new o(s):new l(s),h=d(e,r),$={timeout:s.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:s.fragLoadingMaxRetryTimeout,highWaterMark:131072};r.stats=f.stats,f.load(h,$,{onSuccess:function n(s,o,l,u){a.resetLoader(e,f),a.updateStatsFromPart(e,r);var d={frag:e,part:r,payload:s.data,networkDetails:u};i(d),t(d)},onError:function t(i,s,o){a.resetLoader(e,f),u(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:r,response:i,networkDetails:o}))},onAbort:function t(i,s,o){e.stats.aborted=r.stats.aborted,a.resetLoader(e,f),u(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.INTERNAL_ABORTED,fatal:!1,frag:e,part:r,networkDetails:o}))},onTimeout:function t(i,s,o){a.resetLoader(e,f),u(new c({type:n.ErrorTypes.NETWORK_ERROR,details:n.ErrorDetails.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:r,networkDetails:o}))}})})},e.updateStatsFromPart=function t(e,r){var i=e.stats,n=r.stats,a=n.total;if(i.loaded+=n.loaded,a){var s=Math.round(e.duration/r.duration),o=Math.min(Math.round(i.loaded/a),s),l=(s-o)*Math.round(i.loaded/o);i.total=i.loaded+l}else i.total=Math.max(i.loaded,i.total);var u=i.loading,d=n.loading;u.start?u.first+=d.first-d.start:(u.start=d.start,u.first=d.first),u.end=d.end},e.resetLoader=function t(e,r){e.loader=null,this.loader===r&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),r.destroy()},t}();function d(t,e){void 0===e&&(e=null);var r=e||t,n={frag:t,part:e,responseType:"arraybuffer",url:r.url,headers:{},rangeStart:0,rangeEnd:0},a=r.byteRangeStartOffset,s=r.byteRangeEndOffset;return(0,i.isFiniteNumber)(a)&&(0,i.isFiniteNumber)(s)&&(n.rangeStart=a,n.rangeEnd=s),n}var c=function(t){var e,r;function i(e){for(var r,i=arguments.length,n=Array(i>1?i-1:0),a=1;a<i;a++)n[a-1]=arguments[a];return(r=t.call.apply(t,[this].concat(n))||this).data=void 0,r.data=e,r}return e=i,r=t,e.prototype=Object.create(r.prototype),e.prototype.constructor=e,o(e,r),i}(a(Error))},"./src/loader/fragment.ts"(t,e,r){"use strict";r.r(e),r.d(e,{BaseSegment:()=>$,ElementaryStreamTypes:()=>n,Fragment:()=>g,Part:()=>v});var i,n,a=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),s=r(/*! url-toolkit */ "./node_modules/url-toolkit/src/url-toolkit.js"),o=r(/*! ../utils/logger */ "./src/utils/logger.ts"),l=r(/*! ./level-key */ "./src/loader/level-key.ts"),u=r(/*! ./load-stats */ "./src/loader/load-stats.ts");function d(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,c(t,e)}function c(t,e){return(c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}function f(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function h(t,e,r){return e&&f(t.prototype,e),r&&f(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(i=n||(n={})).AUDIO="audio",i.VIDEO="video",i.AUDIOVIDEO="audiovideo";var $=function(){function t(t){var e;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=((e={})[n.AUDIO]=null,e[n.VIDEO]=null,e[n.AUDIOVIDEO]=null,e),this.baseurl=t}return t.prototype.setByteRange=function t(e,r){var i=e.split("@",2),n=[];1===i.length?n[0]=r?r.byteRangeEndOffset:0:n[0]=parseInt(i[1]),n[1]=parseInt(i[0])+n[0],this._byteRange=n},h(t,[{key:"byteRange",get:function t(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function t(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function t(){return this.byteRange[1]}},{key:"url",get:function t(){return!this._url&&this.baseurl&&this.relurl&&(this._url=(0,s.buildAbsoluteURL)(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function t(e){this._url=e}}]),t}(),g=function(t){function e(e,r){var i;return(i=t.call(this,r)||this)._decryptdata=null,i.rawProgramDateTime=null,i.programDateTime=null,i.tagList=[],i.duration=0,i.sn=0,i.levelkey=void 0,i.type=void 0,i.loader=null,i.level=-1,i.cc=0,i.startPTS=void 0,i.endPTS=void 0,i.appendedPTS=void 0,i.startDTS=void 0,i.endDTS=void 0,i.start=0,i.deltaPTS=void 0,i.maxStartPTS=void 0,i.minEndPTS=void 0,i.stats=new u.LoadStats,i.urlId=0,i.data=void 0,i.bitrateTest=!1,i.title=null,i.initSegment=null,i.type=e,i}d(e,t);var r=e.prototype;return r.createInitializationVector=function t(e){for(var r=new Uint8Array(16),i=12;i<16;i++)r[i]=e>>8*(15-i)&255;return r},r.setDecryptDataFromLevelKey=function t(e,r){var i=e;return(null==e?void 0:e.method)==="AES-128"&&e.uri&&!e.iv&&((i=l.LevelKey.fromURI(e.uri)).method=e.method,i.iv=this.createInitializationVector(r),i.keyFormat="identity"),i},r.setElementaryStreamInfo=function t(e,r,i,n,a,s){void 0===s&&(s=!1);var o=this.elementaryStreams,l=o[e];if(!l){o[e]={startPTS:r,endPTS:i,startDTS:n,endDTS:a,partial:s};return}l.startPTS=Math.min(l.startPTS,r),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,n),l.endDTS=Math.max(l.endDTS,a)},r.clearElementaryStreamInfo=function t(){var e=this.elementaryStreams;e[n.AUDIO]=null,e[n.VIDEO]=null,e[n.AUDIOVIDEO]=null},h(e,[{key:"decryptdata",get:function t(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var e=this.sn;"number"!=typeof e&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&o.logger.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata}},{key:"end",get:function t(){return this.start+this.duration}},{key:"endProgramDateTime",get:function t(){if(null===this.programDateTime||!(0,a.isFiniteNumber)(this.programDateTime))return null;var e=(0,a.isFiniteNumber)(this.duration)?this.duration:0;return this.programDateTime+1e3*e}},{key:"encrypted",get:function t(){var e;return null!==(e=this.decryptdata)&&void 0!==e&&!!e.keyFormat&&!!this.decryptdata.uri}}]),e}($),v=function(t){function e(e,r,i,n,a){(s=t.call(this,i)||this).fragOffset=0,s.duration=0,s.gap=!1,s.independent=!1,s.relurl=void 0,s.fragment=void 0,s.index=void 0,s.stats=new u.LoadStats,s.duration=e.decimalFloatingPoint("DURATION"),s.gap=e.bool("GAP"),s.independent=e.bool("INDEPENDENT"),s.relurl=e.enumeratedString("URI"),s.fragment=r,s.index=n;var s,o=e.enumeratedString("BYTERANGE");return o&&s.setByteRange(o,a),a&&(s.fragOffset=a.fragOffset+a.duration),s}return d(e,t),h(e,[{key:"start",get:function t(){return this.fragment.start+this.fragOffset}},{key:"end",get:function t(){return this.start+this.duration}},{key:"loaded",get:function t(){var e=this.elementaryStreams;return!!(e.audio||e.video||e.audiovideo)}}]),e}($)},"./src/loader/level-details.ts"(t,e,r){"use strict";r.r(e),r.d(e,{LevelDetails:()=>a});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts");function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=function(){var t,e,r;function a(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.fragments=[],this.dateRanges={},this.url=t}return a.prototype.reloaded=function t(e){if(!e){this.advanced=!0,this.updated=!0;return}var r=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!r,this.advanced=this.endSN>e.endSN||r>0||0===r&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay},t=a,e=[{key:"hasProgramDateTime",get:function t(){return!!this.fragments.length&&(0,i.isFiniteNumber)(this.fragments[this.fragments.length-1].programDateTime)}},{key:"levelTargetDuration",get:function t(){return this.averagetargetduration||this.targetduration||10}},{key:"drift",get:function t(){var e=this.driftEndTime-this.driftStartTime;return e>0?1e3*(this.driftEnd-this.driftStart)/e:1}},{key:"edge",get:function t(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function t(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function t(){var e;return null!==(e=this.fragments)&&void 0!==e&&e.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function t(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function t(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function t(){var e;return null!==(e=this.partList)&&void 0!==e&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}],n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),a}()},"./src/loader/level-key.ts"(t,e,r){"use strict";r.r(e),r.d(e,{LevelKey:()=>a});var i=r(/*! url-toolkit */ "./node_modules/url-toolkit/src/url-toolkit.js");function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var a=function(){var t,e,r;function a(t,e){this._uri=null,this.method=null,this.keyFormat=null,this.keyFormatVersions=null,this.keyID=null,this.key=null,this.iv=null,e?this._uri=(0,i.buildAbsoluteURL)(t,e,{alwaysNormalize:!0}):this._uri=t}return a.fromURL=function t(e,r){return new a(e,r)},a.fromURI=function t(e){return new a(e)},t=a,e=[{key:"uri",get:function t(){return this._uri}}],n(t.prototype,e),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),a}()},"./src/loader/load-stats.ts"(t,e,r){"use strict";r.r(e),r.d(e,{LoadStats:()=>i});var i=function t(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}},"./src/loader/m3u8-parser.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>p});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! url-toolkit */ "./node_modules/url-toolkit/src/url-toolkit.js"),a=r(/*! ./date-range */ "./src/loader/date-range.ts"),s=r(/*! ./fragment */ "./src/loader/fragment.ts"),o=r(/*! ./level-details */ "./src/loader/level-details.ts"),l=r(/*! ./level-key */ "./src/loader/level-key.ts"),u=r(/*! ../utils/attr-list */ "./src/utils/attr-list.ts"),d=r(/*! ../utils/logger */ "./src/utils/logger.ts"),c=r(/*! ../utils/codecs */ "./src/utils/codecs.ts"),f=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-SESSION-DATA:([^\r\n]*)[\r\n]+/g,h=/#EXT-X-MEDIA:(.*)/g,$=RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),g=RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),v=/\.(mp4|m4s|m4v|m4a)$/i,p=function(){function t(){}return t.findGroup=function t(e,r){for(var i=0;i<e.length;i++){var n=e[i];if(n.id===r)return n}},t.convertAVC1ToAVCOTI=function t(e){var r=e.split(".");if(r.length>2){var i=r.shift()+".";return i+=parseInt(r.shift()).toString(16),i+=("000"+parseInt(r.shift()).toString(16)).slice(-4)}return e},t.resolve=function t(e,r){return n.buildAbsoluteURL(r,e,{alwaysNormalize:!0})},t.parseMasterPlaylist=function e(r,i){var n=[],a=[],s={},o=!1;for(f.lastIndex=0;null!=(l=f.exec(r));)if(l[1]){var l,d,c=new u.AttrList(l[1]),h={attrs:c,bitrate:c.decimalInteger("AVERAGE-BANDWIDTH")||c.decimalInteger("BANDWIDTH"),name:c.NAME,url:t.resolve(l[2],i)},$=c.decimalResolution("RESOLUTION");$&&(h.width=$.width,h.height=$.height),m((c.CODECS||"").split(/[ ,]+/).filter(function(t){return t}),h),h.videoCodec&&-1!==h.videoCodec.indexOf("avc1")&&(h.videoCodec=t.convertAVC1ToAVCOTI(h.videoCodec)),null!==(d=h.unknownCodecs)&&void 0!==d&&d.length||a.push(h),n.push(h)}else if(l[3]){var g=new u.AttrList(l[3]);g["DATA-ID"]&&(o=!0,s[g["DATA-ID"]]=g)}return{levels:a.length>0&&a.length<n.length?a:n,sessionData:o?s:null}},t.parseMasterPlaylistMedia=function e(r,i,n,a){void 0===a&&(a=[]);var s,o=[],l=0;for(h.lastIndex=0;null!==(s=h.exec(r));){var d=new u.AttrList(s[1]);if(d.TYPE===n){var c={attrs:d,bitrate:0,id:l++,groupId:d["GROUP-ID"],instreamId:d["INSTREAM-ID"],name:d.NAME||d.LANGUAGE||"",type:n,default:d.bool("DEFAULT"),autoselect:d.bool("AUTOSELECT"),forced:d.bool("FORCED"),lang:d.LANGUAGE,url:d.URI?t.resolve(d.URI,i):""};if(a.length){var f=t.findGroup(a,c.groupId)||a[0];x(c,f,"audioCodec"),x(c,f,"textCodec")}o.push(c)}}return o},t.parseLevelPlaylist=function t(e,r,c,f,h){var p=new o.LevelDetails(r),m=p.fragments,x=null,y=0,S=0,L=0,b=0,D=null,_=new s.Fragment(f,r),k=-1,A=!1;for($.lastIndex=0,p.m3u8=e;null!==(H=$.exec(e));){A&&(A=!1,(_=new s.Fragment(f,r)).start=L,_.sn=y,_.cc=b,_.level=c,x&&(_.initSegment=x,_.rawProgramDateTime=x.rawProgramDateTime,x.rawProgramDateTime=null));var I=H[1];if(I){_.duration=parseFloat(I);var R=(" "+H[2]).slice(1);_.title=R||null,_.tagList.push(R?["INF",I,R]:["INF",I])}else if(H[3])(0,i.isFiniteNumber)(_.duration)&&(_.start=L,K&&(_.levelkey=K),_.sn=y,_.level=c,_.cc=b,_.urlId=h,m.push(_),_.relurl=(" "+H[3]).slice(1),T(_,D),D=_,L+=_.duration,y++,S=0,A=!0);else if(H[4]){var C=(" "+H[4]).slice(1);D?_.setByteRange(C,D):_.setByteRange(C)}else if(H[5])_.rawProgramDateTime=(" "+H[5]).slice(1),_.tagList.push(["PROGRAM-DATE-TIME",_.rawProgramDateTime]),-1===k&&(k=m.length);else{if(!(H=H[0].match(g))){d.logger.warn("No matches on slow regex match for level playlist!");continue}for(V=1;V<H.length&&void 0===H[V];V++);var w=(" "+H[V]).slice(1),P=(" "+H[V+1]).slice(1),F=H[V+2]?(" "+H[V+2]).slice(1):"";switch(w){case"PLAYLIST-TYPE":p.type=P.toUpperCase();break;case"MEDIA-SEQUENCE":y=p.startSN=parseInt(P);break;case"SKIP":var O=new u.AttrList(P),N=O.decimalInteger("SKIPPED-SEGMENTS");if((0,i.isFiniteNumber)(N)){p.skippedSegments=N;for(var M=N;M--;)m.unshift(null);y+=N}var B=O.enumeratedString("RECENTLY-REMOVED-DATERANGES");B&&(p.recentlyRemovedDateranges=B.split("	"));break;case"TARGETDURATION":p.targetduration=parseFloat(P);break;case"VERSION":p.version=parseInt(P);break;case"EXTM3U":break;case"ENDLIST":p.live=!1;break;case"#":(P||F)&&_.tagList.push(F?[P,F]:[P]);break;case"DISCONTINUITY":b++,_.tagList.push(["DIS"]);break;case"GAP":_.tagList.push([w]);break;case"BITRATE":_.tagList.push([w,P]);break;case"DATERANGE":var U=new u.AttrList(P),G=new a.DateRange(U,p.dateRanges[U.ID]);G.isValid||p.skippedSegments?p.dateRanges[G.id]=G:d.logger.warn('Ignoring invalid DATERANGE tag: "'+P+'"'),_.tagList.push(["EXT-X-DATERANGE",P]);break;case"DISCONTINUITY-SEQUENCE":b=parseInt(P);break;case"KEY":var H,V,K,W,Y=new u.AttrList(P),q=Y.enumeratedString("METHOD"),z=Y.URI,X=Y.hexadecimalInteger("IV"),j=Y.enumeratedString("KEYFORMATVERSIONS"),Q=Y.enumeratedString("KEYID"),Z=null!=(W=Y.enumeratedString("KEYFORMAT"))?W:"identity";if(["com.apple.streamingkeydelivery","com.microsoft.playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed","com.widevine"].indexOf(Z)>-1){d.logger.warn("Keyformat "+Z+" is not supported from the manifest");continue}if("identity"!==Z)continue;q&&(K=l.LevelKey.fromURL(r,z),z&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(q)>=0&&(K.method=q,K.keyFormat=Z,Q&&(K.keyID=Q),j&&(K.keyFormatVersions=j),K.iv=X));break;case"START":var J=new u.AttrList(P).decimalFloatingPoint("TIME-OFFSET");(0,i.isFiniteNumber)(J)&&(p.startTimeOffset=J);break;case"MAP":var tt=new u.AttrList(P);if(_.duration){var te=new s.Fragment(f,r);E(te,tt,c,K),x=te,_.initSegment=x,x.rawProgramDateTime&&!_.rawProgramDateTime&&(_.rawProgramDateTime=x.rawProgramDateTime)}else E(_,tt,c,K),x=_,A=!0;break;case"SERVER-CONTROL":var tr=new u.AttrList(P);p.canBlockReload=tr.bool("CAN-BLOCK-RELOAD"),p.canSkipUntil=tr.optionalFloat("CAN-SKIP-UNTIL",0),p.canSkipDateRanges=p.canSkipUntil>0&&tr.bool("CAN-SKIP-DATERANGES"),p.partHoldBack=tr.optionalFloat("PART-HOLD-BACK",0),p.holdBack=tr.optionalFloat("HOLD-BACK",0);break;case"PART-INF":var ti=new u.AttrList(P);p.partTarget=ti.decimalFloatingPoint("PART-TARGET");break;case"PART":var tn=p.partList;tn||(tn=p.partList=[]);var ta=S>0?tn[tn.length-1]:void 0,ts=S++,to=new s.Part(new u.AttrList(P),_,r,ts,ta);tn.push(to),_.duration+=to.duration;break;case"PRELOAD-HINT":var tl=new u.AttrList(P);p.preloadHint=tl;break;case"RENDITION-REPORT":var tu=new u.AttrList(P);p.renditionReports=p.renditionReports||[],p.renditionReports.push(tu);break;default:d.logger.warn("line parsed but not handled: "+H)}}}D&&!D.relurl?(m.pop(),L-=D.duration,p.partList&&(p.fragmentHint=D)):p.partList&&(T(_,D),_.cc=b,p.fragmentHint=_);var td=m.length,tc=m[0],tf=m[td-1];if((L+=p.skippedSegments*p.targetduration)>0&&td&&tf){p.averagetargetduration=L/td;var th=tf.sn;p.endSN="initSegment"!==th?th:0,tc&&(p.startCC=tc.cc,!tc.initSegment&&p.fragments.every(function(t){var e,r,i;return t.relurl&&(e=t.relurl,v.test(null!=(r=null===(i=n.parseURL(e))||void 0===i?void 0:i.path)?r:""))})&&(d.logger.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(_=new s.Fragment(f,r)).relurl=tf.relurl,_.level=c,_.sn="initSegment",tc.initSegment=_,p.needSidxRanges=!0))}else p.endSN=0,p.startCC=0;return p.fragmentHint&&(L+=p.fragmentHint.duration),p.totalduration=L,p.endCC=b,k>0&&function t(e,r){for(var i=e[r],n=r;n--;){var a=e[n];if(!a)return;a.programDateTime=i.programDateTime-1e3*a.duration,i=a}}(m,k),p},t}();function m(t,e){["video","audio","text"].forEach(function(r){var i=t.filter(function(t){return(0,c.isCodecType)(t,r)});if(i.length){var n=i.filter(function(t){return 0===t.lastIndexOf("avc1",0)||0===t.lastIndexOf("mp4a",0)});e[r+"Codec"]=n.length>0?n[0]:i[0],t=t.filter(function(t){return -1===i.indexOf(t)})}}),e.unknownCodecs=t}function x(t,e,r){var i=e[r];i&&(t[r]=i)}function T(t,e){t.rawProgramDateTime?t.programDateTime=Date.parse(t.rawProgramDateTime):null!=e&&e.programDateTime&&(t.programDateTime=e.endProgramDateTime),(0,i.isFiniteNumber)(t.programDateTime)||(t.programDateTime=null,t.rawProgramDateTime=null)}function E(t,e,r,i){t.relurl=e.URI,e.BYTERANGE&&t.setByteRange(e.BYTERANGE),t.level=r,t.sn="initSegment",i&&(t.levelkey=i),t.initSegment=null}},"./src/loader/playlist-loader.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>h});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../events */ "./src/events.ts"),a=r(/*! ../errors */ "./src/errors.ts"),s=r(/*! ../utils/logger */ "./src/utils/logger.ts"),o=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),l=r(/*! ./m3u8-parser */ "./src/loader/m3u8-parser.ts"),u=r(/*! ../types/loader */ "./src/types/loader.ts"),d=r(/*! ../utils/attr-list */ "./src/utils/attr-list.ts");function c(t,e){var r=t.url;return(void 0===r||0===r.indexOf("data:"))&&(r=e.url),r}var f=function(){function t(t){this.hls=void 0,this.loaders=Object.create(null),this.hls=t,this.registerListeners()}var e=t.prototype;return e.startLoad=function t(e){},e.stopLoad=function t(){this.destroyInternalLoaders()},e.registerListeners=function t(){var e=this.hls;e.on(n.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.on(n.Events.LEVEL_LOADING,this.onLevelLoading,this),e.on(n.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(n.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},e.unregisterListeners=function t(){var e=this.hls;e.off(n.Events.MANIFEST_LOADING,this.onManifestLoading,this),e.off(n.Events.LEVEL_LOADING,this.onLevelLoading,this),e.off(n.Events.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(n.Events.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},e.createInternalLoader=function t(e){var r=this.hls.config,i=r.pLoader,n=r.loader,a=new(i||n)(r);return e.loader=a,this.loaders[e.type]=a,a},e.getInternalLoader=function t(e){return this.loaders[e.type]},e.resetInternalLoader=function t(e){this.loaders[e]&&delete this.loaders[e]},e.destroyInternalLoaders=function t(){for(var e in this.loaders){var r=this.loaders[e];r&&r.destroy(),this.resetInternalLoader(e)}},e.destroy=function t(){this.unregisterListeners(),this.destroyInternalLoaders()},e.onManifestLoading=function t(e,r){var i=r.url;this.load({id:null,groupId:null,level:0,responseType:"text",type:u.PlaylistContextType.MANIFEST,url:i,deliveryDirectives:null})},e.onLevelLoading=function t(e,r){var i=r.id,n=r.level,a=r.url,s=r.deliveryDirectives;this.load({id:i,groupId:null,level:n,responseType:"text",type:u.PlaylistContextType.LEVEL,url:a,deliveryDirectives:s})},e.onAudioTrackLoading=function t(e,r){var i=r.id,n=r.groupId,a=r.url,s=r.deliveryDirectives;this.load({id:i,groupId:n,level:null,responseType:"text",type:u.PlaylistContextType.AUDIO_TRACK,url:a,deliveryDirectives:s})},e.onSubtitleTrackLoading=function t(e,r){var i=r.id,n=r.groupId,a=r.url,s=r.deliveryDirectives;this.load({id:i,groupId:n,level:null,responseType:"text",type:u.PlaylistContextType.SUBTITLE_TRACK,url:a,deliveryDirectives:s})},e.load=function t(e){var r,i,n,a,o,l,d=this.hls.config,c=this.getInternalLoader(e);if(c){var f=c.context;if(f&&f.url===e.url){s.logger.trace("[playlist-loader]: playlist request ongoing");return}s.logger.log("[playlist-loader]: aborting previous loader for type: "+e.type),c.abort()}switch(e.type){case u.PlaylistContextType.MANIFEST:i=d.manifestLoadingMaxRetry,n=d.manifestLoadingTimeOut,a=d.manifestLoadingRetryDelay,o=d.manifestLoadingMaxRetryTimeout;break;case u.PlaylistContextType.LEVEL:case u.PlaylistContextType.AUDIO_TRACK:case u.PlaylistContextType.SUBTITLE_TRACK:i=0,n=d.levelLoadingTimeOut;break;default:i=d.levelLoadingMaxRetry,n=d.levelLoadingTimeOut,a=d.levelLoadingRetryDelay,o=d.levelLoadingMaxRetryTimeout}if(c=this.createInternalLoader(e),null!==(r=e.deliveryDirectives)&&void 0!==r&&r.part&&(e.type===u.PlaylistContextType.LEVEL&&null!==e.level?l=this.hls.levels[e.level].details:e.type===u.PlaylistContextType.AUDIO_TRACK&&null!==e.id?l=this.hls.audioTracks[e.id].details:e.type===u.PlaylistContextType.SUBTITLE_TRACK&&null!==e.id&&(l=this.hls.subtitleTracks[e.id].details),l)){var h=l.partTarget,$=l.targetduration;h&&$&&(n=Math.min(1e3*Math.max(3*h,.8*$),n))}var g={timeout:n,maxRetry:i,retryDelay:a,maxRetryDelay:o,highWaterMark:0},v={onSuccess:this.loadsuccess.bind(this),onError:this.loaderror.bind(this),onTimeout:this.loadtimeout.bind(this)};c.load(e,g,v)},e.loadsuccess=function t(e,r,i,n){if(void 0===n&&(n=null),i.isSidxRequest){this.handleSidxRequest(e,i),this.handlePlaylistLoaded(e,r,i,n);return}this.resetInternalLoader(i.type);var a=e.data;if(0!==a.indexOf("#EXTM3U")){this.handleManifestParsingError(e,i,"no EXTM3U delimiter",n);return}r.parsing.start=performance.now(),a.indexOf("#EXTINF:")>0||a.indexOf("#EXT-X-TARGETDURATION:")>0?this.handleTrackOrLevelPlaylist(e,r,i,n):this.handleMasterPlaylist(e,r,i,n)},e.loaderror=function t(e,r,i){void 0===i&&(i=null),this.handleNetworkError(r,i,!1,e)},e.loadtimeout=function t(e,r,i){void 0===i&&(i=null),this.handleNetworkError(r,i,!0)},e.handleMasterPlaylist=function t(e,r,i,a){var o=this.hls,u=e.data,f=c(e,i),h=l.default.parseMasterPlaylist(u,f),$=h.levels,g=h.sessionData;if(!$.length){this.handleManifestParsingError(e,i,"no level found in manifest",a);return}var v=$.map(function(t){return{id:t.attrs.AUDIO,audioCodec:t.audioCodec}}),p=$.map(function(t){return{id:t.attrs.SUBTITLES,textCodec:t.textCodec}}),m=l.default.parseMasterPlaylistMedia(u,f,"AUDIO",v),x=l.default.parseMasterPlaylistMedia(u,f,"SUBTITLES",p),T=l.default.parseMasterPlaylistMedia(u,f,"CLOSED-CAPTIONS");m.length&&(m.some(function(t){return!t.url})||!$[0].audioCodec||$[0].attrs.AUDIO||(s.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new d.AttrList({}),bitrate:0,url:""}))),o.trigger(n.Events.MANIFEST_LOADED,{levels:$,audioTracks:m,subtitles:x,captions:T,url:f,stats:r,networkDetails:a,sessionData:g})},e.handleTrackOrLevelPlaylist=function t(e,r,s,o){var f=this.hls,h=s.id,$=s.level,g=s.type,v=c(e,s),p=(0,i.isFiniteNumber)(h)?h:0,m=(0,i.isFiniteNumber)($)?$:p,x=function t(e){var r=e.type;switch(r){case u.PlaylistContextType.AUDIO_TRACK:return u.PlaylistLevelType.AUDIO;case u.PlaylistContextType.SUBTITLE_TRACK:return u.PlaylistLevelType.SUBTITLE;default:return u.PlaylistLevelType.MAIN}}(s),T=l.default.parseLevelPlaylist(e.data,v,m,x,p);if(!T.fragments.length){f.trigger(n.Events.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.LEVEL_EMPTY_ERROR,fatal:!1,url:v,reason:"no fragments found in level",level:"number"==typeof s.level?s.level:void 0});return}if(g===u.PlaylistContextType.MANIFEST){var E={attrs:new d.AttrList({}),bitrate:0,details:T,name:"",url:v};f.trigger(n.Events.MANIFEST_LOADED,{levels:[E],audioTracks:[],url:v,stats:r,networkDetails:o,sessionData:null})}if(r.parsing.end=performance.now(),T.needSidxRanges){var y,S=null===(y=T.fragments[0].initSegment)||void 0===y?void 0:y.url;this.load({url:S,isSidxRequest:!0,type:g,level:$,levelDetails:T,id:h,groupId:null,rangeStart:0,rangeEnd:2048,responseType:"arraybuffer",deliveryDirectives:null});return}s.levelDetails=T,this.handlePlaylistLoaded(e,r,s,o)},e.handleSidxRequest=function t(e,r){var i=new Uint8Array(e.data),n=(0,o.findBox)(i,["sidx"])[0];if(n){var a=(0,o.parseSegmentIndex)(n);if(a){var s=a.references,l=r.levelDetails;s.forEach(function(t,e){var r=t.info,n=l.fragments[e];if(0===n.byteRange.length&&n.setByteRange(String(1+r.end-r.start)+"@"+String(r.start)),n.initSegment){var a=(0,o.findBox)(i,["moov"])[0],s=a?a.length:null;n.initSegment.setByteRange(String(s)+"@0")}})}}},e.handleManifestParsingError=function t(e,r,i,s){this.hls.trigger(n.Events.ERROR,{type:a.ErrorTypes.NETWORK_ERROR,details:a.ErrorDetails.MANIFEST_PARSING_ERROR,fatal:r.type===u.PlaylistContextType.MANIFEST,url:e.url,reason:i,response:e,context:r,networkDetails:s})},e.handleNetworkError=function t(e,r,i,o){void 0===i&&(i=!1),s.logger.warn("[playlist-loader]: A network "+(i?"timeout":"error")+" occurred while loading "+e.type+" level: "+e.level+" id: "+e.id+' group-id: "'+e.groupId+'"');var l=a.ErrorDetails.UNKNOWN,d=!1,c=this.getInternalLoader(e);switch(e.type){case u.PlaylistContextType.MANIFEST:l=i?a.ErrorDetails.MANIFEST_LOAD_TIMEOUT:a.ErrorDetails.MANIFEST_LOAD_ERROR,d=!0;break;case u.PlaylistContextType.LEVEL:l=i?a.ErrorDetails.LEVEL_LOAD_TIMEOUT:a.ErrorDetails.LEVEL_LOAD_ERROR,d=!1;break;case u.PlaylistContextType.AUDIO_TRACK:l=i?a.ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT:a.ErrorDetails.AUDIO_TRACK_LOAD_ERROR,d=!1;break;case u.PlaylistContextType.SUBTITLE_TRACK:l=i?a.ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT:a.ErrorDetails.SUBTITLE_LOAD_ERROR,d=!1}c&&this.resetInternalLoader(e.type);var f={type:a.ErrorTypes.NETWORK_ERROR,details:l,fatal:d,url:e.url,loader:c,context:e,networkDetails:r};o&&(f.response=o),this.hls.trigger(n.Events.ERROR,f)},e.handlePlaylistLoaded=function t(e,r,i,a){var s=i.type,o=i.level,l=i.id,d=i.groupId,c=i.loader,f=i.levelDetails,h=i.deliveryDirectives;if(!(null!=f&&f.targetduration)){this.handleManifestParsingError(e,i,"invalid target duration",a);return}if(c)switch(f.live&&(c.getCacheAge&&(f.ageHeader=c.getCacheAge()||0),(!c.getCacheAge||isNaN(f.ageHeader))&&(f.ageHeader=0)),s){case u.PlaylistContextType.MANIFEST:case u.PlaylistContextType.LEVEL:this.hls.trigger(n.Events.LEVEL_LOADED,{details:f,level:o||0,id:l||0,stats:r,networkDetails:a,deliveryDirectives:h});break;case u.PlaylistContextType.AUDIO_TRACK:this.hls.trigger(n.Events.AUDIO_TRACK_LOADED,{details:f,id:l||0,groupId:d||"",stats:r,networkDetails:a,deliveryDirectives:h});break;case u.PlaylistContextType.SUBTITLE_TRACK:this.hls.trigger(n.Events.SUBTITLE_TRACK_LOADED,{details:f,id:l||0,groupId:d||"",stats:r,networkDetails:a,deliveryDirectives:h})}},t}();let h=f},"./src/polyfills/number.ts"(t,e,r){"use strict";r.r(e),r.d(e,{MAX_SAFE_INTEGER:()=>n,isFiniteNumber:()=>i});var i=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},n=Number.MAX_SAFE_INTEGER||9007199254740991},"./src/remux/aac-helper.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>n});var i=function(){function t(){}return t.getSilentFrame=function t(e,r){if("mp4a.40.2"===e){if(1===r)return new Uint8Array([0,200,0,128,35,128]);if(2===r)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===r)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);else if(4===r)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(5===r)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(6===r)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===r)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===r)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===r)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}},t}();let n=i},"./src/remux/mp4-generator.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>n});var i=function(){function t(){}return t.init=function e(){for(r in t.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},t.types)t.types.hasOwnProperty(r)&&(t.types[r]=[r.charCodeAt(0),r.charCodeAt(1),r.charCodeAt(2),r.charCodeAt(3)]);var r,i=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);t.HDLR_TYPES={video:i,audio:n};var a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);t.STTS=t.STSC=t.STCO=s,t.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),t.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),t.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),t.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var o=new Uint8Array([105,115,111,109]),l=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);t.FTYP=t.box(t.types.ftyp,o,u,o,l),t.DINF=t.box(t.types.dinf,t.box(t.types.dref,a))},t.box=function t(e){for(var r=8,i=arguments.length,n=Array(i>1?i-1:0),a=1;a<i;a++)n[a-1]=arguments[a];for(var s=n.length,o=s;s--;)r+=n[s].byteLength;var l=new Uint8Array(r);for(l[0]=r>>24&255,l[1]=r>>16&255,l[2]=r>>8&255,l[3]=255&r,l.set(e,4),s=0,r=8;s<o;s++)l.set(n[s],r),r+=n[s].byteLength;return l},t.hdlr=function e(r){return t.box(t.types.hdlr,t.HDLR_TYPES[r])},t.mdat=function e(r){return t.box(t.types.mdat,r)},t.mdhd=function e(r,i){var n=Math.floor((i*=r)/4294967296),a=Math.floor(i%4294967296);return t.box(t.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,85,196,0,0]))},t.mdia=function e(r){return t.box(t.types.mdia,t.mdhd(r.timescale,r.duration),t.hdlr(r.type),t.minf(r))},t.mfhd=function e(r){return t.box(t.types.mfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r]))},t.minf=function e(r){return"audio"===r.type?t.box(t.types.minf,t.box(t.types.smhd,t.SMHD),t.DINF,t.stbl(r)):t.box(t.types.minf,t.box(t.types.vmhd,t.VMHD),t.DINF,t.stbl(r))},t.moof=function e(r,i,n){return t.box(t.types.moof,t.mfhd(r),t.traf(n,i))},t.moov=function e(r){for(var i=r.length,n=[];i--;)n[i]=t.trak(r[i]);return t.box.apply(null,[t.types.moov,t.mvhd(r[0].timescale,r[0].duration)].concat(n).concat(t.mvex(r)))},t.mvex=function e(r){for(var i=r.length,n=[];i--;)n[i]=t.trex(r[i]);return t.box.apply(null,[t.types.mvex].concat(n))},t.mvhd=function e(r,i){var n=Math.floor((i*=r)/4294967296),a=Math.floor(i%4294967296),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return t.box(t.types.mvhd,s)},t.sdtp=function e(r){var i,n,a=r.samples||[],s=new Uint8Array(4+a.length);for(i=0;i<a.length;i++)n=a[i].flags,s[i+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return t.box(t.types.sdtp,s)},t.stbl=function e(r){return t.box(t.types.stbl,t.stsd(r),t.box(t.types.stts,t.STTS),t.box(t.types.stsc,t.STSC),t.box(t.types.stsz,t.STSZ),t.box(t.types.stco,t.STCO))},t.avc1=function e(r){var i,n,a,s=[],o=[];for(i=0;i<r.sps.length;i++)a=(n=r.sps[i]).byteLength,s.push(a>>>8&255),s.push(255&a),s=s.concat(Array.prototype.slice.call(n));for(i=0;i<r.pps.length;i++)a=(n=r.pps[i]).byteLength,o.push(a>>>8&255),o.push(255&a),o=o.concat(Array.prototype.slice.call(n));var l=t.box(t.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|r.sps.length].concat(s).concat([r.pps.length]).concat(o))),u=r.width,d=r.height,c=r.pixelRatio[0],f=r.pixelRatio[1];return t.box(t.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,255&u,d>>8&255,255&d,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,t.box(t.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),t.box(t.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,f>>24,f>>16&255,f>>8&255,255&f])))},t.esds=function t(e){var r=e.config.length;return new Uint8Array([0,0,0,0,3,23+r,0,1,0,4,15+r,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([r]).concat(e.config).concat([6,1,2]))},t.mp4a=function e(r){var i=r.samplerate;return t.box(t.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,r.channelCount,0,16,0,0,0,0,i>>8&255,255&i,0,0]),t.box(t.types.esds,t.esds(r)))},t.mp3=function e(r){var i=r.samplerate;return t.box(t.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,r.channelCount,0,16,0,0,0,0,i>>8&255,255&i,0,0]))},t.stsd=function e(r){return"audio"!==r.type?t.box(t.types.stsd,t.STSD,t.avc1(r)):"mp3"===r.segmentCodec&&"mp3"===r.codec?t.box(t.types.stsd,t.STSD,t.mp3(r)):t.box(t.types.stsd,t.STSD,t.mp4a(r))},t.tkhd=function e(r){var i=r.id,n=r.duration*r.timescale,a=r.width,s=r.height,o=Math.floor(n/4294967296),l=Math.floor(n%4294967296);return t.box(t.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,i>>24&255,i>>16&255,i>>8&255,255&i,0,0,0,0,o>>24,o>>16&255,o>>8&255,255&o,l>>24,l>>16&255,l>>8&255,255&l,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,a>>8&255,255&a,0,0,s>>8&255,255&s,0,0]))},t.traf=function e(r,i){var n=t.sdtp(r),a=r.id,s=Math.floor(i/4294967296),o=Math.floor(i%4294967296);return t.box(t.types.traf,t.box(t.types.tfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a])),t.box(t.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,o>>24,o>>16&255,o>>8&255,255&o])),t.trun(r,n.length+16+20+8+16+8+8),n)},t.trak=function e(r){return r.duration=r.duration||4294967295,t.box(t.types.trak,t.tkhd(r),t.mdia(r))},t.trex=function e(r){var i=r.id;return t.box(t.types.trex,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},t.trun=function e(r,i){var n,a,s,o,l,u,d=r.samples||[],c=d.length,f=12+16*c,h=new Uint8Array(f);for(i+=8+f,h.set(["video"===r.type?1:0,0,15,1,c>>>24&255,c>>>16&255,c>>>8&255,255&c,i>>>24&255,i>>>16&255,i>>>8&255,255&i],0),n=0;n<c;n++)s=(a=d[n]).duration,o=a.size,l=a.flags,u=a.cts,h.set([s>>>24&255,s>>>16&255,s>>>8&255,255&s,o>>>24&255,o>>>16&255,o>>>8&255,255&o,l.isLeading<<2|l.dependsOn,l.isDependedOn<<6|l.hasRedundancy<<4|l.paddingValue<<1|l.isNonSync,61440&l.degradPrio,15&l.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*n);return t.box(t.types.trun,h)},t.initSegment=function e(r){t.types||t.init();var i=t.moov(r),n=new Uint8Array(t.FTYP.byteLength+i.byteLength);return n.set(t.FTYP),n.set(i,t.FTYP.byteLength),n},t}();i.types=void 0,i.HDLR_TYPES=void 0,i.STTS=void 0,i.STSC=void 0,i.STCO=void 0,i.STSZ=void 0,i.VMHD=void 0,i.SMHD=void 0,i.STSD=void 0,i.FTYP=void 0,i.DINF=void 0;let n=i},"./src/remux/mp4-remuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>$,flushTextTrackMetadataCueSamples:()=>v,flushTextTrackUserdataCueSamples:()=>p,normalizePts:()=>g});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./aac-helper */ "./src/remux/aac-helper.ts"),a=r(/*! ./mp4-generator */ "./src/remux/mp4-generator.ts"),s=r(/*! ../events */ "./src/events.ts"),o=r(/*! ../errors */ "./src/errors.ts"),l=r(/*! ../utils/logger */ "./src/utils/logger.ts"),u=r(/*! ../types/loader */ "./src/types/loader.ts"),d=r(/*! ../utils/timescale-conversion */ "./src/utils/timescale-conversion.ts");function c(){return(c=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}var f=null,h=null,$=function(){function t(t,e,r,i){if(void 0===i&&(i=""),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=void 0,this._initDTS=void 0,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=t,this.config=e,this.typeSupported=r,this.ISGenerated=!1,null===f){var n=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);f=n?parseInt(n[1]):0}if(null===h){var a=navigator.userAgent.match(/Safari\/(\d+)/i);h=a?parseInt(a[1]):0}}var e=t.prototype;return e.destroy=function t(){},e.resetTimeStamp=function t(e){l.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e},e.resetNextTimestamp=function t(){l.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},e.resetInitSegment=function t(){l.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},e.getVideoStartPts=function t(e){var r=!1,i=e.reduce(function(t,e){var i=e.pts-t;return i<-4294967296?(r=!0,g(t,e.pts)):i>0?t:e.pts},e[0].pts);return r&&l.logger.debug("PTS rollover detected"),i},e.remux=function t(e,r,i,n,a,s,o,d){var c=a,f=a,h=e.pid>-1,$=r.pid>-1,m=r.samples.length,x=e.samples.length>0,T=o&&m>0||m>1;if((!h||x)&&(!$||T)||this.ISGenerated||o){this.ISGenerated||(S=this.generateIS(e,r,a));var E,y,S,L,b,D,_,k=this.isVideoContiguous,A=-1;if(T&&(A=function t(e){for(var r=0;r<e.length;r++)if(e[r].key)return r;return -1}(r.samples),!k&&this.config.forceKeyFrameOnDiscontinuity)){if(D=!0,A>0){l.logger.warn("[mp4-remuxer]: Dropped "+A+" out of "+m+" video samples due to a missing keyframe");var I=this.getVideoStartPts(r.samples);r.samples=r.samples.slice(A),r.dropped+=A,f+=(r.samples[0].pts-I)/r.inputTimeScale,_=f}else -1===A&&(l.logger.warn("[mp4-remuxer]: No keyframe found out of "+m+" video samples"),D=!1)}if(this.ISGenerated){if(x&&T){var R=this.getVideoStartPts(r.samples),C=(g(e.samples[0].pts,R)-R)/r.inputTimeScale;c+=Math.max(0,C),f+=Math.max(0,-C)}if(x){if(e.samplerate||(l.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),S=this.generateIS(e,r,a)),y=this.remuxAudio(e,c,this.isAudioContiguous,s,$||T||d===u.PlaylistLevelType.AUDIO?f:void 0),T){var w=y?y.endPTS-y.startPTS:0;r.inputTimeScale||(l.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),S=this.generateIS(e,r,a)),E=this.remuxVideo(r,f,k,w)}}else T&&(E=this.remuxVideo(r,f,k,0));E&&(E.firstKeyFrame=A,E.independent=-1!==A,E.firstKeyFramePTS=_)}}return this.ISGenerated&&(i.samples.length&&(b=v(i,a,this._initPTS,this._initDTS)),n.samples.length&&(L=p(n,a,this._initPTS))),{audio:y,video:E,initSegment:S,independent:D,text:L,id3:b}},e.generateIS=function t(e,r,n){var s,o,l,u=e.samples,d=r.samples,c=this.typeSupported,f={},h=!(0,i.isFiniteNumber)(this._initPTS),$="audio/mp4";if(h&&(s=o=1/0),e.config&&u.length&&(e.timescale=e.samplerate,"mp3"===e.segmentCodec&&(c.mpeg?($="audio/mpeg",e.codec=""):c.mp3&&(e.codec="mp3")),f.audio={id:"audio",container:$,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&c.mpeg?new Uint8Array(0):a.default.initSegment([e]),metadata:{channelCount:e.channelCount}},h&&(l=e.inputTimeScale,s=o=u[0].pts-Math.round(l*n))),r.sps&&r.pps&&d.length&&(r.timescale=r.inputTimeScale,f.video={id:"main",container:"video/mp4",codec:r.codec,initSegment:a.default.initSegment([r]),metadata:{width:r.width,height:r.height}},h)){l=r.inputTimeScale;var v=this.getVideoStartPts(d),p=Math.round(l*n);o=Math.min(o,g(d[0].dts,v)-p),s=Math.min(s,v-p)}if(Object.keys(f).length)return this.ISGenerated=!0,h&&(this._initPTS=s,this._initDTS=o),{tracks:f,initPTS:s,timescale:l}},e.remuxVideo=function t(e,r,i,n){var u,$,v,p=e.inputTimeScale,x=e.samples,T=[],E=x.length,y=this._initPTS,S=this.nextAvcDts,L=8,b=this.videoSampleDuration,D=Number.POSITIVE_INFINITY,_=Number.NEGATIVE_INFINITY,k=!1;if(!i||null===S){var A=x[0].pts-g(x[0].dts,x[0].pts);S=r*p-A}for(var I=0;I<E;I++){var R=x[I];R.pts=g(R.pts-y,S),R.dts=g(R.dts-y,S),R.dts<x[I>0?I-1:I].dts&&(k=!0)}k&&x.sort(function(t,e){var r=t.dts-e.dts,i=t.pts-e.pts;return r||i}),u=x[0].dts;var C=($=x[x.length-1].dts)-u,w=C?Math.round(C/(E-1)):b||e.inputTimeScale/30;if(i){var P=u-S,F=P>w,O=P<-1;if((F||O)&&(F?l.logger.warn("AVC: "+(0,d.toMsFromMpegTsClock)(P,!0)+" ms ("+P+"dts) hole between fragments detected, filling it"):l.logger.warn("AVC: "+(0,d.toMsFromMpegTsClock)(-P,!0)+" ms ("+P+"dts) overlapping between fragments detected"),!O||S>x[0].pts)){u=S;var N=x[0].pts-P;x[0].dts=u,x[0].pts=N,l.logger.log("Video: First PTS/DTS adjusted: "+(0,d.toMsFromMpegTsClock)(N,!0)+"/"+(0,d.toMsFromMpegTsClock)(u,!0)+", delta: "+(0,d.toMsFromMpegTsClock)(P,!0)+" ms")}}u=Math.max(0,u);for(var M=0,B=0,U=0;U<E;U++){for(var G=x[U],H=G.units,V=H.length,K=0,W=0;W<V;W++)K+=H[W].data.length;B+=K,M+=V,G.length=K,G.dts=Math.max(G.dts,u),D=Math.min(G.pts,D),_=Math.max(G.pts,_)}$=x[E-1].dts;var Y=B+4*M+8;try{v=new Uint8Array(Y)}catch(q){this.observer.emit(s.Events.ERROR,s.Events.ERROR,{type:o.ErrorTypes.MUX_ERROR,details:o.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:Y,reason:"fail allocating video mdat "+Y});return}var z=new DataView(v.buffer);z.setUint32(0,Y),v.set(a.default.types.mdat,4);for(var X=!1,j=Number.POSITIVE_INFINITY,Q=Number.POSITIVE_INFINITY,Z=Number.NEGATIVE_INFINITY,J=Number.NEGATIVE_INFINITY,tt=0;tt<E;tt++){for(var te=x[tt],tr=te.units,ti=0,tn=0,ta=tr.length;tn<ta;tn++){var ts=tr[tn],to=ts.data,tl=ts.data.byteLength;z.setUint32(L,tl),L+=4,v.set(to,L),L+=tl,ti+=4+tl}var tu=void 0;if(tt<E-1)b=x[tt+1].dts-te.dts,tu=x[tt+1].pts-te.pts;else{var td=this.config,tc=tt>0?te.dts-x[tt-1].dts:w;if(tu=tt>0?te.pts-x[tt-1].pts:w,td.stretchShortVideoTrack&&null!==this.nextAudioPts){var tf=Math.floor(td.maxBufferHole*p),th=(n?D+n*p:this.nextAudioPts)-te.pts;th>tf?((b=th-tc)<0?b=tc:X=!0,l.logger.log("[mp4-remuxer]: It is approximately "+th/90+" ms to the next segment; using duration "+b/90+" ms for the last video frame.")):b=tc}else b=tc}var t$=Math.round(te.pts-te.dts);j=Math.min(j,b),Z=Math.max(Z,b),Q=Math.min(Q,tu),J=Math.max(J,tu),T.push(new m(te.key,b,ti,t$))}if(T.length){if(f){if(f<70){var tg=T[0].flags;tg.dependsOn=2,tg.isNonSync=0}}else if(h&&J-Q<Z-j&&w/Z<.025&&0===T[0].cts){l.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var tv=u,tp=0,tm=T.length;tp<tm;tp++){var tx=tv+T[tp].duration,tT=tv+T[tp].cts;if(tp<tm-1){var tE=tx+T[tp+1].cts;T[tp].duration=tE-tT}else T[tp].duration=tp?T[tp-1].duration:w;T[tp].cts=0,tv=tx}}}console.assert(null!==b,"mp4SampleDuration must be computed"),b=X||!b?w:b,this.nextAvcDts=S=$+b,this.videoSampleDuration=b,this.isVideoContiguous=!0;var ty,tS={data1:a.default.moof(e.sequenceNumber++,u,c({},e,{samples:T})),data2:v,startPTS:D/p,endPTS:(_+b)/p,startDTS:u/p,endDTS:S/p,type:"video",hasAudio:!1,hasVideo:!0,nb:T.length,dropped:e.dropped};return e.samples=[],e.dropped=0,console.assert(v.length,"MDAT length must not be zero"),tS},e.remuxAudio=function t(e,r,i,u,d){var f,h=e.inputTimeScale,$=e.samplerate?e.samplerate:h,v=h/$,p="aac"===e.segmentCodec?1024:1152,x=p*v,T=this._initPTS,E="mp3"===e.segmentCodec&&this.typeSupported.mpeg,y=[],S=void 0!==d,L=e.samples,b=E?0:8,D=this.nextAudioPts||-1,_=r*h;if(this.isAudioContiguous=i=i||L.length&&D>0&&(u&&9e3>Math.abs(_-D)||Math.abs(g(L[0].pts-T,_)-D)<20*x),L.forEach(function(t){t.pts=g(t.pts-T,_)}),!i||D<0){if(!(L=L.filter(function(t){return t.pts>=0})).length)return;D=0===d?0:u&&!S?Math.max(0,_):L[0].pts}if("aac"===e.segmentCodec)for(var k=this.config.maxAudioFramesDrift,A=0,I=D;A<L.length;A++){var R=L[A],C=R.pts,w=C-I,P=Math.abs(1e3*w/h);if(w<=-k*x&&S)0===A&&(l.logger.warn("Audio frame @ "+(C/h).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*w/h)+" ms."),this.nextAudioPts=D=I=C);else if(w>=k*x&&P<1e4&&S){var F=Math.round(w/x);(I=C-F*x)<0&&(F--,I+=x),0===A&&(this.nextAudioPts=D=I),l.logger.warn("[mp4-remuxer]: Injecting "+F+" audio frame @ "+(I/h).toFixed(3)+"s due to "+Math.round(1e3*w/h)+" ms gap.");for(var O=0;O<F;O++){var N=Math.max(I,0),M=n.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);M||(l.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),M=R.unit.subarray()),L.splice(A,0,{unit:M,pts:N}),I+=x,A++}}R.pts=I,I+=x}for(var B=null,U=null,G=0,H=L.length;H--;)G+=L[H].unit.byteLength;for(var V=0,K=L.length;V<K;V++){var W=L[V],Y=W.unit,q=W.pts;if(null!==U)y[V-1].duration=Math.round((q-U)/v);else{if(i&&"aac"===e.segmentCodec&&(q=D),B=q,!(G>0))return;G+=b;try{f=new Uint8Array(G)}catch(z){this.observer.emit(s.Events.ERROR,s.Events.ERROR,{type:o.ErrorTypes.MUX_ERROR,details:o.ErrorDetails.REMUX_ALLOC_ERROR,fatal:!1,bytes:G,reason:"fail allocating audio mdat "+G});return}!E&&(new DataView(f.buffer).setUint32(0,G),f.set(a.default.types.mdat,4))}f.set(Y,b);var X=Y.byteLength;b+=X,y.push(new m(!0,p,X,0)),U=q}var j=y.length;if(j){var Q=y[y.length-1];this.nextAudioPts=D=U+v*Q.duration;var Z=E?new Uint8Array(0):a.default.moof(e.sequenceNumber++,B/v,c({},e,{samples:y}));e.samples=[];var J=B/h,tt=D/h,te={data1:Z,data2:f,startPTS:J,endPTS:tt,startDTS:J,endDTS:tt,type:"audio",hasAudio:!0,hasVideo:!1,nb:j};return this.isAudioContiguous=!0,console.assert(f.length,"MDAT length must not be zero"),te}},e.remuxEmptyAudio=function t(e,r,i,a){var s=e.inputTimeScale,o=e.samplerate?e.samplerate:s,u=this.nextAudioPts,d=(null!==u?u:a.startDTS*s)+this._initDTS,c=a.endDTS*s+this._initDTS,f=s/o*1024,h=Math.ceil((c-d)/f),$=n.default.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(l.logger.warn("[mp4-remuxer]: remux empty Audio"),!$){l.logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}for(var g=[],v=0;v<h;v++){var p=d+v*f;g.push({unit:$,pts:p,dts:p})}return e.samples=g,this.remuxAudio(e,r,i,!1)},t}();function g(t,e){var r;if(null===e)return t;for(r=e<t?-8589934592:8589934592;Math.abs(t-e)>4294967296;)t+=r;return t}function v(t,e,r,i){var n=t.samples.length;if(n){for(var a=t.inputTimeScale,s=0;s<n;s++){var o=t.samples[s];o.pts=g(o.pts-r,e*a)/a,o.dts=g(o.dts-i,e*a)/a}var l=t.samples;return t.samples=[],{samples:l}}}function p(t,e,r){var i=t.samples.length;if(i){for(var n=t.inputTimeScale,a=0;a<i;a++){var s=t.samples[a];s.pts=g(s.pts-r,e*n)/n}t.samples.sort(function(t,e){return t.pts-e.pts});var o=t.samples;return t.samples=[],{samples:o}}}var m=function t(e,r,i,n){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=r,this.size=i,this.cts=n,this.flags=new x(e)},x=function t(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1}},"./src/remux/passthrough-remuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>d});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./mp4-remuxer */ "./src/remux/mp4-remuxer.ts"),a=r(/*! ../utils/mp4-tools */ "./src/utils/mp4-tools.ts"),s=r(/*! ../loader/fragment */ "./src/loader/fragment.ts"),o=r(/*! ../utils/logger */ "./src/utils/logger.ts"),l=function(){function t(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=void 0,this.initTracks=void 0,this.lastEndTime=null}var e=t.prototype;return e.destroy=function t(){},e.resetTimeStamp=function t(e){this.initPTS=e,this.lastEndTime=null},e.resetNextTimestamp=function t(){this.lastEndTime=null},e.resetInitSegment=function t(e,r,i){this.audioCodec=r,this.videoCodec=i,this.generateInitSegment(e),this.emitInitSegment=!0},e.generateInitSegment=function t(e){var r=this.audioCodec,i=this.videoCodec;if(!e||!e.byteLength){this.initTracks=void 0,this.initData=void 0;return}var n=this.initData=(0,a.parseInitSegment)(e);r||(r=u(n.audio,s.ElementaryStreamTypes.AUDIO)),i||(i=u(n.video,s.ElementaryStreamTypes.VIDEO));var l={};n.audio&&n.video?l.audiovideo={container:"video/mp4",codec:r+","+i,initSegment:e,id:"main"}:n.audio?l.audio={container:"audio/mp4",codec:r,initSegment:e,id:"audio"}:n.video?l.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:o.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=l},e.remux=function t(e,r,s,l,u){var d,c=this.initPTS,f=this.lastEndTime,h={audio:void 0,video:void 0,text:l,id3:s,initSegment:void 0};(0,i.isFiniteNumber)(f)||(f=this.lastEndTime=u||0);var $=r.samples;if(!$||!$.length)return h;var g={initPTS:void 0,timescale:1},v=this.initData;if(v&&v.length||(this.generateInitSegment($),v=this.initData),!v||!v.length)return o.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);var p=(0,a.getStartDTS)(v,$);(0,i.isFiniteNumber)(c)||(this.initPTS=g.initPTS=c=p-u);var m=(0,a.getDuration)($,v),x=e?p-c:f,T=x+m;(0,a.offsetStartDTS)(v,$,c),m>0?this.lastEndTime=T:(o.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var E=!!v.audio,y=!!v.video,S="";E&&(S+="audio"),y&&(S+="video");var L={data1:$,startPTS:x,startDTS:x,endPTS:T,endDTS:T,type:S,hasAudio:E,hasVideo:y,nb:1,dropped:0};h.audio="audio"===L.type?L:void 0,h.video="audio"!==L.type?L:void 0,h.initSegment=g;var b=null!=(d=this.initPTS)?d:0;return h.id3=(0,n.flushTextTrackMetadataCueSamples)(s,u,b,b),l.samples.length&&(h.text=(0,n.flushTextTrackUserdataCueSamples)(l,u,b)),h},t}();function u(t,e){var r=null==t?void 0:t.codec;return r&&r.length>4?r:"hvc1"===r||"hev1"===r?"hvc1.1.c.L120.90":"av01"===r?"av01.0.04M.08":"avc1"===r||e===s.ElementaryStreamTypes.VIDEO?"avc1.42e01e":"mp4a.40.5"}let d=l},"./src/task-loop.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});var i=function(){function t(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var e=t.prototype;return e.destroy=function t(){this.onHandlerDestroying(),this.onHandlerDestroyed()},e.onHandlerDestroying=function t(){this.clearNextTick(),this.clearInterval()},e.onHandlerDestroyed=function t(){},e.hasInterval=function t(){return!!this._tickInterval},e.hasNextTick=function t(){return!!this._tickTimer},e.setInterval=function t(e){return!this._tickInterval&&(this._tickInterval=self.setInterval(this._boundTick,e),!0)},e.clearInterval=function t(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)},e.clearNextTick=function t(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)},e.tick=function t(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},e.tickImmediate=function t(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},e.doTick=function t(){},t}()},"./src/types/cmcd.ts"(t,e,r){"use strict";r.r(e),r.d(e,{CMCDObjectType:()=>i,CMCDStreamType:()=>a,CMCDStreamingFormat:()=>n,CMCDVersion:()=>u});var i,n,a,s,o,l,u=1;(s=i||(i={})).MANIFEST="m",s.AUDIO="a",s.VIDEO="v",s.MUXED="av",s.INIT="i",s.CAPTION="c",s.TIMED_TEXT="tt",s.KEY="k",s.OTHER="o",(o=n||(n={})).DASH="d",o.HLS="h",o.SMOOTH="s",o.OTHER="o",(l=a||(a={})).VOD="v",l.LIVE="l"},"./src/types/demuxer.ts"(t,e,r){"use strict";var i,n;r.r(e),r.d(e,{MetadataSchema:()=>i}),(n=i||(i={})).audioId3="org.id3",n.dateRange="com.apple.quicktime.HLS",n.emsg="https://aomedia.org/emsg/ID3"},"./src/types/level.ts"(t,e,r){"use strict";function i(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function n(t,e){var r=t.canSkipUntil,i=t.canSkipDateRanges,n=t.endSN;return r&&(void 0!==e?e-n:0)<r?i?s.v2:s.Yes:(0,s.No)}r.r(e),r.d(e,{HlsSkip:()=>s,HlsUrlParameters:()=>o,Level:()=>l,getSkipValue:()=>n}),(a=s||(s={})).No="",a.Yes="YES",a.v2="v2";var a,s,o=function(){function t(t,e,r){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=r}return t.prototype.addDirectives=function t(e){var r=new self.URL(e);return void 0!==this.msn&&r.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&r.searchParams.set("_HLS_part",this.part.toString()),this.skip&&r.searchParams.set("_HLS_skip",this.skip),r.toString()},t}(),l=function(){var t,e,r;function n(t){this.attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[t.url],this.attrs=t.attrs,this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.unknownCodecs=t.unknownCodecs,this.codecSet=[t.videoCodec,t.audioCodec].filter(function(t){return t}).join(",").replace(/\.[^.,]+/g,"")}return t=n,e=[{key:"maxBitrate",get:function t(){return Math.max(this.realBitrate,this.bitrate)}},{key:"uri",get:function t(){return this.url[this._urlId]||""}},{key:"urlId",get:function t(){return this._urlId},set:function t(e){var r=e%this.url.length;this._urlId!==r&&(this.details=void 0,this._urlId=r)}}],i(t.prototype,e),r&&i(t,r),Object.defineProperty(t,"prototype",{writable:!1}),n}()},"./src/types/loader.ts"(t,e,r){"use strict";var i,n,a,s;r.r(e),r.d(e,{PlaylistContextType:()=>i,PlaylistLevelType:()=>n}),(a=i||(i={})).MANIFEST="manifest",a.LEVEL="level",a.AUDIO_TRACK="audioTrack",a.SUBTITLE_TRACK="subtitleTrack",(s=n||(n={})).MAIN="main",s.AUDIO="audio",s.SUBTITLE="subtitle"},"./src/types/transmuxer.ts"(t,e,r){"use strict";r.r(e),r.d(e,{ChunkMetadata:()=>i});var i=function t(e,r,i,a,s,o){void 0===a&&(a=0),void 0===s&&(s=-1),void 0===o&&(o=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=n(),this.buffering={audio:n(),video:n(),audiovideo:n()},this.level=e,this.sn=r,this.id=i,this.size=a,this.part=s,this.partial=o};function n(){return{start:0,executeStart:0,executeEnd:0,end:0}}},"./src/utils/attr-list.ts"(t,e,r){"use strict";r.r(e),r.d(e,{AttrList:()=>a});var i=/^(\d+)x(\d+)$/,n=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g,a=function(){function t(e){for(var r in"string"==typeof e&&(e=t.parseAttrList(e)),e)e.hasOwnProperty(r)&&(this[r]=e[r])}var e=t.prototype;return e.decimalInteger=function t(e){var r=parseInt(this[e],10);return r>Number.MAX_SAFE_INTEGER?1/0:r},e.hexadecimalInteger=function t(e){if(!this[e])return null;var r=(this[e]||"0x").slice(2);r=(1&r.length?"0":"")+r;for(var i=new Uint8Array(r.length/2),n=0;n<r.length/2;n++)i[n]=parseInt(r.slice(2*n,2*n+2),16);return i},e.hexadecimalIntegerAsNumber=function t(e){var r=parseInt(this[e],16);return r>Number.MAX_SAFE_INTEGER?1/0:r},e.decimalFloatingPoint=function t(e){return parseFloat(this[e])},e.optionalFloat=function t(e,r){var i=this[e];return i?parseFloat(i):r},e.enumeratedString=function t(e){return this[e]},e.bool=function t(e){return"YES"===this[e]},e.decimalResolution=function t(e){var r=i.exec(this[e]);if(null!==r)return{width:parseInt(r[1],10),height:parseInt(r[2],10)}},t.parseAttrList=function t(e){var r,i={};for(n.lastIndex=0;null!==(r=n.exec(e));){var a=r[2];0===a.indexOf('"')&&a.lastIndexOf('"')===a.length-1&&(a=a.slice(1,-1)),i[r[1]]=a}return i},t}()},"./src/utils/binary-search.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});let i={search:function t(e,r){for(var i=0,n=e.length-1,a=null,s=null;i<=n;){var o=r(s=e[a=(i+n)/2|0]);if(o>0)i=a+1;else{if(!(o<0))return s;n=a-1}}return null}}},"./src/utils/buffer-helper.ts"(t,e,r){"use strict";r.r(e),r.d(e,{BufferHelper:()=>a});var i=r(/*! ./logger */ "./src/utils/logger.ts"),n={length:0,start:function t(){return 0},end:function t(){return 0}},a=function(){function t(){}return t.isBuffered=function e(r,i){try{if(r){for(var n=t.getBuffered(r),a=0;a<n.length;a++)if(i>=n.start(a)&&i<=n.end(a))return!0}}catch(s){}return!1},t.bufferInfo=function e(r,i,n){try{if(r){var a,s=t.getBuffered(r),o=[];for(a=0;a<s.length;a++)o.push({start:s.start(a),end:s.end(a)});return this.bufferedInfo(o,i,n)}}catch(l){}return{len:0,start:i,end:i,nextStart:void 0}},t.bufferedInfo=function t(e,r,i){r=Math.max(0,r),e.sort(function(t,e){var r=t.start-e.start;return r||e.end-t.end});var n,a=[];if(i)for(var s=0;s<e.length;s++){var o=a.length;if(o){var l=a[o-1].end;e[s].start-l<i?e[s].end>l&&(a[o-1].end=e[s].end):a.push(e[s])}else a.push(e[s])}else a=e;for(var u=0,d=r,c=r,f=0;f<a.length;f++){var h=a[f].start,$=a[f].end;if(r+i>=h&&r<$)d=h,u=(c=$)-r;else if(r+i<h){n=h;break}}return{len:u,start:d||0,end:c||0,nextStart:n}},t.getBuffered=function t(e){try{return e.buffered}catch(r){return i.logger.log("failed to get media.buffered",r),n}},t}()},"./src/utils/cea-608-parser.ts"(t,e,r){"use strict";r.r(e),r.d(e,{CaptionScreen:()=>m,Row:()=>p,default:()=>L});var i,n,a=r(/*! ../utils/logger */ "./src/utils/logger.ts"),s={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},o=function t(e){var r=e;return s.hasOwnProperty(e)&&(r=s[e]),String.fromCharCode(r)},l={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},u={17:2,18:4,21:6,22:8,23:10,19:13,20:15},d={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},c={25:2,26:4,29:6,30:8,31:10,27:13,28:15},f=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];(n=i||(i={}))[n.ERROR=0]="ERROR",n[n.TEXT=1]="TEXT",n[n.WARNING=2]="WARNING",n[n.INFO=2]="INFO",n[n.DEBUG=3]="DEBUG",n[n.DATA=3]="DATA";var h=function(){function t(){this.time=null,this.verboseLevel=i.ERROR}return t.prototype.log=function t(e,r){this.verboseLevel>=e&&a.logger.log(this.time+" ["+e+"] "+r)},t}(),$=function t(e){for(var r=[],i=0;i<e.length;i++)r.push(e[i].toString(16));return r},g=function(){function t(t,e,r,i,n){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=t||"white",this.underline=e||!1,this.italics=r||!1,this.background=i||"black",this.flash=n||!1}var e=t.prototype;return e.reset=function t(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},e.setStyles=function t(e){for(var r=["foreground","underline","italics","background","flash"],i=0;i<r.length;i++){var n=r[i];e.hasOwnProperty(n)&&(this[n]=e[n])}},e.isDefault=function t(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash},e.equals=function t(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash},e.copy=function t(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash},e.toString=function t(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},t}(),v=function(){function t(t,e,r,i,n,a){this.uchar=void 0,this.penState=void 0,this.uchar=t||" ",this.penState=new g(e,r,i,n,a)}var e=t.prototype;return e.reset=function t(){this.uchar=" ",this.penState.reset()},e.setChar=function t(e,r){this.uchar=e,this.penState.copy(r)},e.setPenState=function t(e){this.penState.copy(e)},e.equals=function t(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)},e.copy=function t(e){this.uchar=e.uchar,this.penState.copy(e.penState)},e.isEmpty=function t(){return" "===this.uchar&&this.penState.isDefault()},t}(),p=function(){function t(t){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var e=0;e<100;e++)this.chars.push(new v);this.logger=t,this.pos=0,this.currPenState=new g}var e=t.prototype;return e.equals=function t(e){for(var r=!0,i=0;i<100;i++)if(!this.chars[i].equals(e.chars[i])){r=!1;break}return r},e.copy=function t(e){for(var r=0;r<100;r++)this.chars[r].copy(e.chars[r])},e.isEmpty=function t(){for(var e=!0,r=0;r<100;r++)if(!this.chars[r].isEmpty()){e=!1;break}return e},e.setCursor=function t(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(i.DEBUG,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(i.DEBUG,"Too large cursor position "+this.pos),this.pos=100)},e.moveCursor=function t(e){var r=this.pos+e;if(e>1)for(var i=this.pos+1;i<r+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(r)},e.backSpace=function t(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},e.insertChar=function t(e){e>=144&&this.backSpace();var r=o(e);if(this.pos>=100){this.logger.log(i.ERROR,"Cannot insert "+e.toString(16)+" ("+r+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(r,this.currPenState),this.moveCursor(1)},e.clearFromPos=function t(e){var r;for(r=e;r<100;r++)this.chars[r].reset()},e.clear=function t(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},e.clearToEndOfRow=function t(){this.clearFromPos(this.pos)},e.getTextString=function t(){for(var e=[],r=!0,i=0;i<100;i++){var n=this.chars[i].uchar;" "!==n&&(r=!1),e.push(n)}return r?"":e.join("")},e.setPenStyles=function t(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)},t}(),m=function(){function t(t){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var e=0;e<15;e++)this.rows.push(new p(t));this.logger=t,this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var e=t.prototype;return e.reset=function t(){for(var e=0;e<15;e++)this.rows[e].clear();this.currRow=14},e.equals=function t(e){for(var r=!0,i=0;i<15;i++)if(!this.rows[i].equals(e.rows[i])){r=!1;break}return r},e.copy=function t(e){for(var r=0;r<15;r++)this.rows[r].copy(e.rows[r])},e.isEmpty=function t(){for(var e=!0,r=0;r<15;r++)if(!this.rows[r].isEmpty()){e=!1;break}return e},e.backSpace=function t(){this.rows[this.currRow].backSpace()},e.clearToEndOfRow=function t(){this.rows[this.currRow].clearToEndOfRow()},e.insertChar=function t(e){this.rows[this.currRow].insertChar(e)},e.setPen=function t(e){this.rows[this.currRow].setPenStyles(e)},e.moveCursor=function t(e){this.rows[this.currRow].moveCursor(e)},e.setCursor=function t(e){this.logger.log(i.INFO,"setCursor: "+e),this.rows[this.currRow].setCursor(e)},e.setPAC=function t(e){this.logger.log(i.INFO,"pacData = "+JSON.stringify(e));var r=e.row-1;if(this.nrRollUpRows&&r<this.nrRollUpRows-1&&(r=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==r){for(var n=0;n<15;n++)this.rows[n].clear();var a=this.currRow+1-this.nrRollUpRows,s=this.lastOutputScreen;if(s){var o=s.rows[a].cueStartTime,l=this.logger.time;if(o&&null!==l&&o<l)for(var u=0;u<this.nrRollUpRows;u++)this.rows[r-this.nrRollUpRows+u+1].copy(s.rows[a+u])}}this.currRow=r;var d=this.rows[this.currRow];if(null!==e.indent){var c=e.indent;d.setCursor(e.indent),e.color=d.chars[Math.max(c-1,0)].penState.foreground}var f={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(f)},e.setBkgData=function t(e){this.logger.log(i.INFO,"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)},e.setRollUpRows=function t(e){this.nrRollUpRows=e},e.rollUp=function t(){if(null===this.nrRollUpRows){this.logger.log(i.DEBUG,"roll_up but nrRollUpRows not set yet");return}this.logger.log(i.TEXT,this.getDisplayText());var e=this.currRow+1-this.nrRollUpRows,r=this.rows.splice(e,1)[0];r.clear(),this.rows.splice(this.currRow,0,r),this.logger.log(i.INFO,"Rolling up")},e.getDisplayText=function t(e){e=e||!1;for(var r=[],i="",n=-1,a=0;a<15;a++){var s=this.rows[a].getTextString();s&&(n=a+1,e?r.push("Row "+n+": '"+s+"'"):r.push(s.trim()))}return r.length>0&&(i=e?"["+r.join(" | ")+"]":r.join("\n")),i},e.getTextAndFormat=function t(){return this.rows},t}(),x=function(){function t(t,e,r){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new m(r),this.nonDisplayedMemory=new m(r),this.lastOutputScreen=new m(r),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=r}var e=t.prototype;return e.reset=function t(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},e.getHandler=function t(){return this.outputFilter},e.setHandler=function t(e){this.outputFilter=e},e.setPAC=function t(e){this.writeScreen.setPAC(e)},e.setBkgData=function t(e){this.writeScreen.setBkgData(e)},e.setMode=function t(e){e!==this.mode&&(this.mode=e,this.logger.log(i.INFO,"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)},e.insertChars=function t(e){for(var r=0;r<e.length;r++)this.writeScreen.insertChar(e[r]);var n=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(i.INFO,n+": "+this.writeScreen.getDisplayText(!0)),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(i.TEXT,"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())},e.ccRCL=function t(){this.logger.log(i.INFO,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},e.ccBS=function t(){this.logger.log(i.INFO,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},e.ccAOF=function t(){},e.ccAON=function t(){},e.ccDER=function t(){this.logger.log(i.INFO,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},e.ccRU=function t(e){this.logger.log(i.INFO,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)},e.ccFON=function t(){this.logger.log(i.INFO,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},e.ccRDC=function t(){this.logger.log(i.INFO,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},e.ccTR=function t(){this.logger.log(i.INFO,"TR"),this.setMode("MODE_TEXT")},e.ccRTD=function t(){this.logger.log(i.INFO,"RTD"),this.setMode("MODE_TEXT")},e.ccEDM=function t(){this.logger.log(i.INFO,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},e.ccCR=function t(){this.logger.log(i.INFO,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},e.ccENM=function t(){this.logger.log(i.INFO,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},e.ccEOC=function t(){if(this.logger.log(i.INFO,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(i.TEXT,"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)},e.ccTO=function t(e){this.logger.log(i.INFO,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)},e.ccMIDROW=function t(e){var r={flash:!1};r.underline=e%2==1,r.italics=e>=46,r.italics?r.foreground="white":r.foreground=["white","green","blue","cyan","red","yellow","magenta"][Math.floor(e/2)-16],this.logger.log(i.INFO,"MIDROW: "+JSON.stringify(r)),this.writeScreen.setPen(r)},e.outputDataUpdate=function t(e){void 0===e&&(e=!1);var r=this.logger.time;null!==r&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,r,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:r):this.cueStartTime=r,this.lastOutputScreen.copy(this.displayedMemory))},e.cueSplitAtTime=function t(e){this.outputFilter&&!this.displayedMemory.isEmpty()&&(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e)},t}(),T=function(){function t(t,e,r){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var i=new h;this.channels=[null,new x(t,e,i),new x(t+1,r,i)],this.cmdHistory=S(),this.logger=i}var e=t.prototype;return e.getHandler=function t(e){return this.channels[e].getHandler()},e.setHandler=function t(e,r){this.channels[e].setHandler(r)},e.addData=function t(e,r){var n,a,s,o=!1;this.logger.time=e;for(var l=0;l<r.length;l+=2)if(a=127&r[l],s=127&r[l+1],0!==a||0!==s){if(this.logger.log(i.DATA,"["+$([r[l],r[l+1]])+"] -> ("+$([a,s])+")"),(n=this.parseCmd(a,s))||(n=this.parseMidrow(a,s)),n||(n=this.parsePAC(a,s)),n||(n=this.parseBackgroundAttributes(a,s)),!n&&(o=this.parseChars(a,s))){var u=this.currentChannel;u&&u>0?this.channels[u].insertChars(o):this.logger.log(i.WARNING,"No channel found yet. TEXT-MODE?")}n||o||this.logger.log(i.WARNING,"Couldn't parse cleaned data "+$([a,s])+" orig: "+$([r[l],r[l+1]]))}},e.parseCmd=function t(e,r){var n=this.cmdHistory;if(!((20===e||28===e||21===e||29===e)&&r>=32&&r<=47||(23===e||31===e)&&r>=33&&r<=35))return!1;if(y(e,r,n))return E(null,null,n),this.logger.log(i.DEBUG,"Repeated command ("+$([e,r])+") is dropped"),!0;var a=20===e||21===e||23===e?1:2,s=this.channels[a];return 20===e||21===e||28===e||29===e?32===r?s.ccRCL():33===r?s.ccBS():34===r?s.ccAOF():35===r?s.ccAON():36===r?s.ccDER():37===r?s.ccRU(2):38===r?s.ccRU(3):39===r?s.ccRU(4):40===r?s.ccFON():41===r?s.ccRDC():42===r?s.ccTR():43===r?s.ccRTD():44===r?s.ccEDM():45===r?s.ccCR():46===r?s.ccENM():47===r&&s.ccEOC():s.ccTO(r-32),E(e,r,n),this.currentChannel=a,!0},e.parseMidrow=function t(e,r){var n=0;if((17===e||25===e)&&r>=32&&r<=47){if((n=17===e?1:2)!==this.currentChannel)return this.logger.log(i.ERROR,"Mismatch channel in midrow parsing"),!1;var a=this.channels[n];return!!a&&(a.ccMIDROW(r),this.logger.log(i.DEBUG,"MIDROW ("+$([e,r])+")"),!0)}return!1},e.parsePAC=function t(e,r){var i,n=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&r>=64&&r<=127||(16===e||24===e)&&r>=64&&r<=95))return!1;if(y(e,r,n))return E(null,null,n),!0;var a=e<=23?1:2;i=r>=64&&r<=95?1===a?l[e]:d[e]:1===a?u[e]:c[e];var s=this.channels[a];return!!s&&(s.setPAC(this.interpretPAC(i,r)),E(e,r,n),this.currentChannel=a,!0)},e.interpretPAC=function t(e,r){var i,n={color:null,italics:!1,indent:null,underline:!1,row:e};return i=r>95?r-96:r-64,n.underline=(1&i)==1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=4*Math.floor((i-16)/2),n},e.parseChars=function t(e,r){var n,a,s=null,l=null;if(e>=25?(n=2,l=e-8):(n=1,l=e),l>=17&&l<=19?(a=17===l?r+80:18===l?r+112:r+144,this.logger.log(i.INFO,"Special char '"+o(a)+"' in channel "+n),s=[a]):e>=32&&e<=127&&(s=0===r?[e]:[e,r]),s){var u=$(s);this.logger.log(i.DEBUG,"Char codes =  "+u.join(",")),E(e,r,this.cmdHistory)}return s},e.parseBackgroundAttributes=function t(e,r){if(!((16===e||24===e)&&r>=32&&r<=47||(23===e||31===e)&&r>=45&&r<=47))return!1;var i,n={};return 16===e||24===e?(i=Math.floor((r-32)/2),n.background=f[i],r%2==1&&(n.background=n.background+"_semi")):45===r?n.background="transparent":(n.foreground="black",47===r&&(n.underline=!0)),this.channels[e<=23?1:2].setBkgData(n),E(e,r,this.cmdHistory),!0},e.reset=function t(){for(var e=0;e<Object.keys(this.channels).length;e++){var r=this.channels[e];r&&r.reset()}this.cmdHistory=S()},e.cueSplitAtTime=function t(e){for(var r=0;r<this.channels.length;r++){var i=this.channels[r];i&&i.cueSplitAtTime(e)}},t}();function E(t,e,r){r.a=t,r.b=e}function y(t,e,r){return r.a===t&&r.b===e}function S(){return{a:null,b:null}}let L=T},"./src/utils/codecs.ts"(t,e,r){"use strict";r.r(e),r.d(e,{isCodecSupportedInMp4:()=>a,isCodecType:()=>n});var i={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}};function n(t,e){var r=i[e];return!!r&&!0===r[t.slice(0,4)]}function a(t,e){return MediaSource.isTypeSupported((e||"video")+'/mp4;codecs="'+t+'"')}},"./src/utils/cues.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>o});var i=r(/*! ./vttparser */ "./src/utils/vttparser.ts"),n=r(/*! ./webvtt-parser */ "./src/utils/webvtt-parser.ts"),a=r(/*! ./texttrack-utils */ "./src/utils/texttrack-utils.ts"),s=/\s/;let o={newCue:function t(e,r,o,l){for(var u,d,c,f,h,$=[],g=self.VTTCue||self.TextTrackCue,v=0;v<l.rows.length;v++)if(u=l.rows[v],c=!0,f=0,h="",!u.isEmpty()){for(var p=0;p<u.chars.length;p++)s.test(u.chars[p].uchar)&&c?f++:(h+=u.chars[p].uchar,c=!1);u.cueStartTime=r,r===o&&(o+=1e-4),f>=16?f--:f++;var m=(0,i.fixLineBreaks)(h.trim()),x=(0,n.generateCueId)(r,o,m);e&&e.cues&&e.cues.getCueById(x)||((d=new g(r,o,m)).id=x,d.line=v+1,d.align="left",d.position=10+Math.min(80,10*Math.floor(8*f/32)),$.push(d))}return e&&$.length&&($.sort(function(t,e){return"auto"===t.line||"auto"===e.line?0:t.line>8&&e.line>8?e.line-t.line:t.line-e.line}),$.forEach(function(t){return(0,a.addCueToTrack)(e,t)})),$}}},"./src/utils/discontinuities.ts"(t,e,r){"use strict";r.r(e),r.d(e,{adjustSlidingStart:()=>d,alignMediaPlaylistByPDT:()=>h,alignPDT:()=>f,alignStream:()=>c,findDiscontinuousReferenceFrag:()=>l,findFirstFragWithCC:()=>s,shouldAlignOnDiscontinuities:()=>o});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./logger */ "./src/utils/logger.ts"),a=r(/*! ../controller/level-helper */ "./src/controller/level-helper.ts");function s(t,e){for(var r=null,i=0,n=t.length;i<n;i++){var a=t[i];if(a&&a.cc===e){r=a;break}}return r}function o(t,e,r){return!!e.details&&(!!(r.endCC>r.startCC)||!!t&&!!(t.cc<r.startCC))}function l(t,e,r){void 0===r&&(r=0);var i=t.fragments,a=e.fragments;if(!a.length||!i.length){n.logger.log("No fragments to align");return}var o=s(i,a[0].cc);if(!o||o&&!o.startPTS){n.logger.log("No frag in previous level to align on");return}return o}function u(t,e){if(t){var r=t.start+e;t.start=t.startPTS=r,t.endPTS=r+t.duration}}function d(t,e){for(var r=e.fragments,i=0,n=r.length;i<n;i++)u(r[i],t);e.fragmentHint&&u(e.fragmentHint,t),e.alignedSliding=!0}function c(t,e,r){e&&(function t(e,r,a){if(o(e,a,r)){var s=l(a.details,r);s&&(0,i.isFiniteNumber)(s.start)&&(n.logger.log("Adjusting PTS using last level due to CC increase within current level "+r.url),d(s.start,r))}}(t,r,e),!r.alignedSliding&&e.details&&f(r,e.details),r.alignedSliding||!e.details||r.skippedSegments||(0,a.adjustSliding)(e.details,r))}function f(t,e){if(e.fragments.length&&t.hasProgramDateTime&&e.hasProgramDateTime){var r=e.fragments[0].programDateTime,a=t.fragments[0].programDateTime,s=(a-r)/1e3+e.fragments[0].start;s&&(0,i.isFiniteNumber)(s)&&(n.logger.log("Adjusting PTS using programDateTime delta "+(a-r)+"ms, sliding:"+s.toFixed(3)+" "+t.url+" "),d(s,t))}}function h(t,e){if(t.hasProgramDateTime&&e.hasProgramDateTime){var r=t.fragments,i=e.fragments;if(r.length&&i.length){var n=i[Math.round(i.length/2)-1],a=s(r,n.cc)||r[Math.round(r.length/2)-1],o=n.programDateTime,l=a.programDateTime;null!==o&&null!==l&&d((l-o)/1e3-(a.start-n.start),t)}}}},"./src/utils/ewma-bandwidth-estimator.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>a});var i=r(/*! ../utils/ewma */ "./src/utils/ewma.ts"),n=function(){function t(t,e,r){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultEstimate_=r,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new i.default(t),this.fast_=new i.default(e)}var e=t.prototype;return e.update=function t(e,r){var n=this.slow_,a=this.fast_;this.slow_.halfLife!==e&&(this.slow_=new i.default(e,n.getEstimate(),n.getTotalWeight())),this.fast_.halfLife!==r&&(this.fast_=new i.default(r,a.getEstimate(),a.getTotalWeight()))},e.sample=function t(e,r){var i=(e=Math.max(e,this.minDelayMs_))/1e3,n=8*r/i;this.fast_.sample(i,n),this.slow_.sample(i,n)},e.canEstimate=function t(){var e=this.fast_;return e&&e.getTotalWeight()>=this.minWeight_},e.getEstimate=function t(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},e.destroy=function t(){},t}();let a=n},"./src/utils/ewma.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>n});var i=function(){function t(t,e,r){void 0===e&&(e=0),void 0===r&&(r=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=r}var e=t.prototype;return e.sample=function t(e,r){var i=Math.pow(this.alpha_,e);this.estimate_=r*(1-i)+i*this.estimate_,this.totalWeight_+=e},e.getTotalWeight=function t(){return this.totalWeight_},e.getEstimate=function t(){if(this.alpha_){var e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_},t}();let n=i},"./src/utils/fetch-loader.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>g,fetchSupported:()=>c});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ../loader/load-stats */ "./src/loader/load-stats.ts"),a=r(/*! ../demux/chunk-cache */ "./src/demux/chunk-cache.ts");function s(t){var e="function"==typeof Map?new Map:void 0;return(s=function t(r){var i;if(null===r||(i=r,-1===Function.toString.call(i).indexOf("[native code]")))return r;if("function"!=typeof r)throw TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(r))return e.get(r);e.set(r,n)}function n(){return o(r,arguments,u(this).constructor)}return n.prototype=Object.create(r.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),l(n,r)})(t)}function o(t,e,r){return(o=!function t(){if("undefined"==typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}()?function t(e,r,i){var n=[null];n.push.apply(n,r);var a=new(Function.bind.apply(e,n));return i&&l(a,i.prototype),a}:Reflect.construct.bind()).apply(null,arguments)}function l(t,e){return(l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){return e.__proto__=r,e})(t,e)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function t(e){return e.__proto__||Object.getPrototypeOf(e)})(t)}function d(){return(d=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}function c(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1}var f=function(){function t(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||h,this.controller=new self.AbortController,this.stats=new n.LoadStats}var e=t.prototype;return e.destroy=function t(){this.loader=this.callbacks=null,this.abortInternal()},e.abortInternal=function t(){var e=this.response;e&&e.ok||(this.stats.aborted=!0,this.controller.abort())},e.abort=function t(){var e;this.abortInternal(),null!==(e=this.callbacks)&&void 0!==e&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},e.load=function t(e,r,n){var a,s,o,l=this,u=this.stats;if(u.loading.start)throw Error("Loader can only be used once.");u.loading.start=self.performance.now();var c=(a=e,s=this.controller.signal,o={method:"GET",mode:"cors",credentials:"same-origin",signal:s,headers:new self.Headers(d({},a.headers))},a.rangeEnd&&o.headers.set("Range","bytes="+a.rangeStart+"-"+String(a.rangeEnd-1)),o),f=n.onProgress,h="arraybuffer"===e.responseType,g=h?"byteLength":"length";this.context=e,this.config=r,this.callbacks=n,this.request=this.fetchSetup(e,c),self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(function(){l.abortInternal(),n.onTimeout(u,e,l.response)},r.timeout),self.fetch(this.request).then(function(t){if(l.response=l.loader=t,!t.ok){var n=t.status,a=t.statusText;throw new $(a||"fetch, bad network response",n,t)}return(u.loading.first=Math.max(self.performance.now(),u.loading.start),u.total=parseInt(t.headers.get("Content-Length")||"0"),f&&(0,i.isFiniteNumber)(r.highWaterMark))?l.loadProgressively(t,u,e,r.highWaterMark,f):h?t.arrayBuffer():t.text()}).then(function(t){var a=l.response;self.clearTimeout(l.requestTimeout),u.loading.end=Math.max(self.performance.now(),u.loading.first);var s=t[g];s&&(u.loaded=u.total=s);var o={url:a.url,data:t};f&&!(0,i.isFiniteNumber)(r.highWaterMark)&&f(u,e,t,a),n.onSuccess(o,u,e,a)}).catch(function(t){if(self.clearTimeout(l.requestTimeout),!u.aborted){var r=t&&t.code||0,i=t?t.message:null;n.onError({code:r,text:i},e,t?t.details:null)}})},e.getCacheAge=function t(){var e=null;if(this.response){var r=this.response.headers.get("age");e=r?parseFloat(r):null}return e},e.loadProgressively=function t(e,r,i,n,s){void 0===n&&(n=0);var o=new a.default,l=e.body.getReader();return function t(){return l.read().then(function(a){if(a.done)return o.dataLength&&s(r,i,o.flush(),e),Promise.resolve(new ArrayBuffer(0));var l=a.value,u=l.length;return r.loaded+=u,u<n||o.dataLength?(o.push(l),o.dataLength>=n&&s(r,i,o.flush(),e)):s(r,i,l,e),t()}).catch(function(){return Promise.reject()})}()},t}();function h(t,e){return new self.Request(t.url,e)}var $=function(t){var e,r;function i(e,r,i){var n;return(n=t.call(this,e)||this).code=void 0,n.details=void 0,n.code=r,n.details=i,n}return e=i,r=t,e.prototype=Object.create(r.prototype),e.prototype.constructor=e,l(e,r),i}(s(Error));let g=f},"./src/utils/imsc1-ttml-parser.ts"(t,e,r){"use strict";r.r(e),r.d(e,{IMSC1_CODEC:()=>d,parseIMSC1:()=>$});var i=r(/*! ./mp4-tools */ "./src/utils/mp4-tools.ts"),n=r(/*! ./vttparser */ "./src/utils/vttparser.ts"),a=r(/*! ./vttcue */ "./src/utils/vttcue.ts"),s=r(/*! ../demux/id3 */ "./src/demux/id3.ts"),o=r(/*! ./timescale-conversion */ "./src/utils/timescale-conversion.ts"),l=r(/*! ./webvtt-parser */ "./src/utils/webvtt-parser.ts");function u(){return(u=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t}).apply(this,arguments)}var d="stpp.ttml.im1t",c=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,f=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,h={left:"start",center:"center",right:"end",start:"start",end:"end"};function $(t,e,r,n,d){var c=(0,i.findBox)(new Uint8Array(t),["mdat"]);if(0===c.length){d(Error("Could not parse IMSC1 mdat"));return}var f=c.map(function(t){return(0,s.utf8ArrayToStr)(t)}),$=(0,o.toTimescaleFromScale)(e,1,r);try{f.forEach(function(t){return n(function t(e,r){var i=new DOMParser().parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!i)throw Error("Invalid ttml");var n={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(n).reduce(function(t,e){return t[e]=i.getAttribute("ttp:"+e)||n[e],t},{}),o="preserve"!==i.getAttribute("xml:space"),d=v(g(i,"styling","style")),c=v(g(i,"layout","region")),f=g(i,"body","[begin]");return[].map.call(f,function(t){var e=function t(e,r){return[].slice.call(e.childNodes).reduce(function(e,i,n){var a;return"br"===i.nodeName&&n?e+"\n":null!==(a=i.childNodes)&&void 0!==a&&a.length?t(i,r):r?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent},"")}(t,o);if(!e||!t.hasAttribute("begin"))return null;var i=x(t.getAttribute("begin"),s),n=x(t.getAttribute("dur"),s),f=x(t.getAttribute("end"),s);if(null===i)throw m(t);if(null===f){if(null===n)throw m(t);f=i+n}var $=new a.default(i-r,f-r,e);$.id=(0,l.generateCueId)($.startTime,$.endTime,$.text);var g,v,T,E,y,S,L=c[t.getAttribute("region")],b=d[t.getAttribute("style")];$.position=10,$.size=80;var D=(g=L,v=b,T=d,E="http://www.w3.org/ns/ttml#styling",y=null,S=null!=g&&g.hasAttribute("style")?g.getAttribute("style"):null,S&&T.hasOwnProperty(S)&&(y=T[S]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce(function(t,e){var r=p(v,E,e)||p(g,E,e)||p(y,E,e);return r&&(t[e]=r),t},{})),_=D.textAlign;if(_){var k=h[_];k&&($.lineAlign=k),$.align=_}return u($,D),$}).filter(function(t){return null!==t})}(t,$))})}catch(T){d(T)}}function g(t,e,r){var i=t.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(r)):[]}function v(t){return t.reduce(function(t,e){var r=e.getAttribute("xml:id");return r&&(t[r]=e),t},{})}function p(t,e,r){return t&&t.hasAttributeNS(e,r)?t.getAttributeNS(e,r):null}function m(t){return Error("Could not parse ttml timestamp "+t)}function x(t,e){if(!t)return null;var r,i,a,s,o=(0,n.parseTimeStamp)(t);return null===o&&(c.test(t)?o=(r=t,i=e,a=c.exec(r),s=(0|a[4])+(0|a[5])/i.subFrameRate,(0|a[1])*3600+(0|a[2])*60+(0|a[3])+s/i.frameRate):f.test(t)&&(o=function t(e,r){var i=f.exec(e),n=Number(i[1]),a=i[2];switch(a){case"h":return 3600*n;case"m":return 60*n;case"ms":return 1e3*n;case"f":return n/r.frameRate;case"t":return n/r.tickRate}return n}(t,e))),o}},"./src/utils/logger.ts"(t,e,r){"use strict";r.r(e),r.d(e,{enableLogs:()=>s,logger:()=>o});var i=function t(){},n={trace:i,debug:i,log:i,warn:i,info:i,error:i},a=n;function s(t,e){if(self.console&&!0===t||"object"==typeof t){!function t(e){for(var r=arguments.length,n=Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];n.forEach(function(t){var r,n;a[t]=e[t]?e[t].bind(e):(r=t,(n=self.console[r])?n.bind(self.console,"["+r+"] >"):i)})}(t,"debug","log","info","warn","error");try{a.log('Debug logs enabled for "'+e+'"')}catch(r){a=n}}else a=n}var o=a},"./src/utils/mediasource-helper.ts"(t,e,r){"use strict";function i(){return self.MediaSource||self.WebKitMediaSource}r.r(e),r.d(e,{getMediaSource:()=>i})},"./src/utils/mp4-tools.ts"(t,e,r){"use strict";r.r(e),r.d(e,{RemuxerTrackIdConfig:()=>o,appendUint8Array:()=>E,bin2str:()=>l,computeRawDurationFromSamples:()=>m,discardEPB:()=>b,findBox:()=>h,getDuration:()=>p,getStartDTS:()=>v,offsetStartDTS:()=>x,parseEmsg:()=>D,parseInitSegment:()=>g,parseSEIMessageFromNALu:()=>L,parseSamples:()=>y,parseSegmentIndex:()=>$,readSint32:()=>c,readUint16:()=>u,readUint32:()=>d,segmentValidRange:()=>T,writeUint32:()=>f});var i=r(/*! ./typed-array */ "./src/utils/typed-array.ts"),n=r(/*! ../loader/fragment */ "./src/loader/fragment.ts"),a=r(/*! ../demux/id3 */ "./src/demux/id3.ts"),s=[].push,o={video:1,audio:2,id3:3,text:4};function l(t){return String.fromCharCode.apply(null,t)}function u(t,e){var r=t[e]<<8|t[e+1];return r<0?65536+r:r}function d(t,e){var r=c(t,e);return r<0?4294967296+r:r}function c(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function f(t,e,r){t[e]=r>>24,t[e+1]=r>>16&255,t[e+2]=r>>8&255,t[e+3]=255&r}function h(t,e){var r=[];if(!e.length)return r;for(var i=t.byteLength,n=0;n<i;){var a=d(t,n),o=l(t.subarray(n+4,n+8)),u=a>1?n+a:i;if(o===e[0]){if(1===e.length)r.push(t.subarray(n+8,u));else{var c=h(t.subarray(n+8,u),e.slice(1));c.length&&s.apply(r,c)}}n=u}return r}function $(t){var e=[],r=t[0],i=8,n=d(t,i);i+=4,0===r?i+=8:i+=16,i+=2;var a=t.length+0,s=u(t,i);i+=2;for(var o=0;o<s;o++){var l=i,c=d(t,l);l+=4;var f=2147483647&c;if(1==(2147483648&c)>>>31)return console.warn("SIDX has hierarchical references (not supported)"),null;var h=d(t,l);l+=4,e.push({referenceSize:f,subsegmentDuration:h,info:{duration:h/n,start:a,end:a+f-1}}),a+=f,l+=4,i=l}return{earliestPresentationTime:0,timescale:n,version:r,referencesCount:s,references:e}}function g(t){for(var e=[],r=h(t,["moov","trak"]),i=0;i<r.length;i++){var a=r[i],s=h(a,["tkhd"])[0];if(s){var o=s[0],u=0===o?12:20,c=d(s,u),f=h(a,["mdia","mdhd"])[0];if(f){u=0===(o=f[0])?12:20;var $=d(f,u),g=h(a,["mdia","hdlr"])[0];if(g){var v=l(g.subarray(8,12)),p={soun:n.ElementaryStreamTypes.AUDIO,vide:n.ElementaryStreamTypes.VIDEO}[v];if(p){var m=h(a,["mdia","minf","stbl","stsd"])[0],x=void 0;m&&(x=l(m.subarray(12,16))),e[c]={timescale:$,type:p},e[p]={timescale:$,id:c,codec:x}}}}}}return h(t,["moov","mvex","trex"]).forEach(function(t){var r=e[d(t,4)];r&&(r.default={duration:d(t,12),flags:d(t,20)})}),e}function v(t,e){return h(e,["moof","traf"]).reduce(function(e,r){var i=h(r,["tfdt"])[0],n=i[0],a=h(r,["tfhd"]).reduce(function(e,r){var a=t[d(r,4)];if(a){var s=d(i,4);1===n&&(s*=4294967296,s+=d(i,8));var o=s/(a.timescale||9e4);if(isFinite(o)&&(null===e||o<e))return o}return e},null);return null!==a&&isFinite(a)&&(null===e||a<e)?a:e},null)||0}function p(t,e){for(var r=0,i=0,a=0,s=h(t,["moof","traf"]),o=0;o<s.length;o++){var l=s[o],u=h(l,["tfhd"])[0],c=e[d(u,4)];if(c){var f=c.default,g=d(u,0)|(null==f?void 0:f.flags),v=null==f?void 0:f.duration;8&g&&(v=2&g?d(u,12):d(u,8));for(var p=c.timescale||9e4,x=h(l,["trun"]),T=0;T<x.length;T++){if(!(r=m(x[T]))&&v){var E=d(x[T],4);r=v*E}c.type===n.ElementaryStreamTypes.VIDEO?i+=r/p:c.type===n.ElementaryStreamTypes.AUDIO&&(a+=r/p)}}}if(0===i&&0===a){for(var y=0,S=h(t,["sidx"]),L=0;L<S.length;L++){var b=$(S[L]);null!=b&&b.references&&(y+=b.references.reduce(function(t,e){return t+e.info.duration||0},0))}return y}return i||a}function m(t){var e=d(t,0),r=8;1&e&&(r+=4),4&e&&(r+=4);for(var i=0,n=d(t,4),a=0;a<n;a++){if(256&e){var s=d(t,r);i+=s,r+=4}512&e&&(r+=4),1024&e&&(r+=4),2048&e&&(r+=4)}return i}function x(t,e,r){h(e,["moof","traf"]).forEach(function(e){h(e,["tfhd"]).forEach(function(i){var n=t[d(i,4)];if(n){var a=n.timescale||9e4;h(e,["tfdt"]).forEach(function(t){var e=t[0],i=d(t,4);if(0===e)i-=r*a,i=Math.max(i,0),f(t,4,i);else{i*=4294967296,i+=d(t,8),i-=r*a;var n=Math.floor((i=Math.max(i,0))/4294967296),s=Math.floor(i%4294967296);f(t,4,n),f(t,8,s)}})}})})}function T(t){var e={valid:null,remainder:null},r=h(t,["moof"]);if(!r)return e;if(r.length<2)return e.remainder=t,e;var n=r[r.length-1];return e.valid=(0,i.sliceUint8)(t,0,n.byteOffset-8),e.remainder=(0,i.sliceUint8)(t,n.byteOffset-8),e}function E(t,e){var r=new Uint8Array(t.length+e.length);return r.set(t),r.set(e,t.length),r}function y(t,e){var r=[],i=e.samples,a=e.timescale,s=e.id,o=!1;return h(i,["moof"]).map(function(l){var u=l.byteOffset-8;h(l,["traf"]).map(function(l){var f=h(l,["tfdt"]).map(function(t){var e=t[0],r=d(t,4);return 1===e&&(r*=4294967296,r+=d(t,8)),r/a})[0];return void 0!==f&&(t=f),h(l,["tfhd"]).map(function(f){var $=d(f,4),g=16777215&d(f,0),v=0,p=0,m=8;$===s&&((1&g)!=0&&(m+=8),(2&g)!=0&&(m+=4),(8&g)!=0&&(v=d(f,m),m+=4),(16&g)!=0&&(p=d(f,m),m+=4),(32&g)!=0&&(m+=4),"video"===e.type&&(o=function t(e){if(!e)return!1;var r=e.indexOf("."),i=r<0?e:e.substring(0,r);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}(e.codec)),h(l,["trun"]).map(function(s){var l=s[0],f=16777215&d(s,0),h=0,$=(256&f)!=0,g=0,m=(512&f)!=0,x=0,T=(1024&f)!=0,E=(2048&f)!=0,y=0,b=d(s,4),D=8;(1&f)!=0&&(h=d(s,D),D+=4),(4&f)!=0&&(D+=4);for(var _=h+u,k=0;k<b;k++){if($?(g=d(s,D),D+=4):g=v,m?(x=d(s,D),D+=4):x=p,T&&(D+=4),E&&(y=0===l?d(s,D):c(s,D),D+=4),e.type===n.ElementaryStreamTypes.VIDEO)for(var A=0;A<x;){var I=d(i,_);if(S(o,i[_+=4])){var R=i.subarray(_,_+I);L(R,o?2:1,t+y/a,r)}_+=I,A+=I+4}t+=g/a}}))})})}),r}function S(t,e){if(!t)return 6==(31&e);var r=e>>1&63;return 39===r||40===r}function L(t,e,r,i){var n=b(t),s=0;s+=e;for(var o=0,l=0,c=!1,f=0;s<n.length;){o=0;do{if(s>=n.length)break;o+=f=n[s++]}while(255===f);l=0;do{if(s>=n.length)break;l+=f=n[s++]}while(255===f);var h=n.length-s;if(!c&&4===o&&s<n.length){if(c=!0,181===n[s++]){var $=u(n,s);if(s+=2,49===$){var g=d(n,s);if(s+=4,1195456820===g){var v=n[s++];if(3===v){var p=n[s++],m=31&p,x=64&p,T=x?2+3*m:0,E=new Uint8Array(T);if(x){E[0]=p;for(var y=1;y<T;y++)E[y]=n[s++]}i.push({type:v,payloadType:o,pts:r,bytes:E})}}}}}else if(5===o&&l<h){if(c=!0,l>16){for(var S=[],L=0;L<16;L++){var D=n[s++].toString(16);S.push(1==D.length?"0"+D:D),(3===L||5===L||7===L||9===L)&&S.push("-")}for(var _=l-16,k=new Uint8Array(_),A=0;A<_;A++)k[A]=n[s++];i.push({payloadType:o,pts:r,uuid:S.join(""),userData:(0,a.utf8ArrayToStr)(k),userDataBytes:k})}}else if(l<h)s+=l;else if(l>h)break}}function b(t){for(var e=t.byteLength,r=[],i=1;i<e-2;)0===t[i]&&0===t[i+1]&&3===t[i+2]?(r.push(i+2),i+=2):i++;if(0===r.length)return t;var n=e-r.length,a=new Uint8Array(n),s=0;for(i=0;i<n;s++,i++)s===r[0]&&(s++,r.shift()),a[i]=t[s];return a}function D(t){var e=t[0],r="",i="",n=0,a=0,s=0,o=0,u=0,c=0;if(0===e){for(;"\0"!==l(t.subarray(c,c+1));)r+=l(t.subarray(c,c+1)),c+=1;for(r+=l(t.subarray(c,c+1)),c+=1;"\0"!==l(t.subarray(c,c+1));)i+=l(t.subarray(c,c+1)),c+=1;i+=l(t.subarray(c,c+1)),c+=1,n=d(t,12),a=d(t,16),o=d(t,20),u=d(t,24),c=28}else if(1===e){c+=4,n=d(t,c);var f=d(t,c+=4),h=d(t,c+=4);for(c+=4,Number.isSafeInteger(s=4294967296*f+h)||(s=Number.MAX_SAFE_INTEGER,console.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),o=d(t,c),c+=4,u=d(t,c),c+=4;"\0"!==l(t.subarray(c,c+1));)r+=l(t.subarray(c,c+1)),c+=1;for(r+=l(t.subarray(c,c+1)),c+=1;"\0"!==l(t.subarray(c,c+1));)i+=l(t.subarray(c,c+1)),c+=1;i+=l(t.subarray(c,c+1)),c+=1}var $=t.subarray(c,t.byteLength);return{schemeIdUri:r,value:i,timeScale:n,presentationTime:s,presentationTimeDelta:a,eventDuration:o,id:u,payload:$}}},"./src/utils/output-filter.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});var i=function(){function t(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}var e=t.prototype;return e.dispatchCue=function t(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},e.newCue=function t(e,r,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=r,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)},e.reset=function t(){this.cueRanges=[],this.startTime=null},t}()},"./src/utils/texttrack-utils.ts"(t,e,r){"use strict";r.r(e),r.d(e,{addCueToTrack:()=>a,clearCurrentCues:()=>s,getCuesInRange:()=>l,removeCuesInRange:()=>o,sendAddTrackEvent:()=>n});var i=r(/*! ./logger */ "./src/utils/logger.ts");function n(t,e){var r;try{r=new Event("addtrack")}catch(i){(r=document.createEvent("Event")).initEvent("addtrack",!1,!1)}r.track=t,e.dispatchEvent(r)}function a(t,e){var r=t.mode;if("disabled"===r&&(t.mode="hidden"),t.cues&&!t.cues.getCueById(e.id))try{if(t.addCue(e),!t.cues.getCueById(e.id))throw Error("addCue is failed for: "+e)}catch(n){i.logger.debug("[texttrack-utils]: "+n);var a=new self.TextTrackCue(e.startTime,e.endTime,e.text);a.id=e.id,t.addCue(a)}"disabled"===r&&(t.mode=r)}function s(t){var e=t.mode;if("disabled"===e&&(t.mode="hidden"),t.cues)for(var r=t.cues.length;r--;)t.removeCue(t.cues[r]);"disabled"===e&&(t.mode=e)}function o(t,e,r,i){var n=t.mode;if("disabled"===n&&(t.mode="hidden"),t.cues&&t.cues.length>0)for(var a=l(t.cues,e,r),s=0;s<a.length;s++)(!i||i(a[s]))&&t.removeCue(a[s]);"disabled"===n&&(t.mode=n)}function l(t,e,r){var i=[],n=function t(e,r){if(r<e[0].startTime)return 0;var i=e.length-1;if(r>e[i].endTime)return -1;for(var n=0,a=i;n<=a;){var s=Math.floor((a+n)/2);if(r<e[s].startTime)a=s-1;else{if(!(r>e[s].startTime)||!(n<i))return s;n=s+1}}return e[n].startTime-r<r-e[a].startTime?n:a}(t,e);if(n>-1)for(var a=n,s=t.length;a<s;a++){var o=t[a];if(o.startTime>=e&&o.endTime<=r)i.push(o);else if(o.startTime>r)break}return i}},"./src/utils/time-ranges.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});let i={toString:function t(e){for(var r="",i=e.length,n=0;n<i;n++)r+="["+e.start(n).toFixed(3)+","+e.end(n).toFixed(3)+"]";return r}}},"./src/utils/timescale-conversion.ts"(t,e,r){"use strict";function i(t,e,r,i){void 0===r&&(r=1),void 0===i&&(i=!1);var n=t*e*r;return i?Math.round(n):n}function n(t,e,r,n){return void 0===r&&(r=1),void 0===n&&(n=!1),i(t,e,1/r,n)}function a(t,e){return void 0===e&&(e=!1),i(t,1e3,11111111111111112e-21,e)}function s(t,e){return void 0===e&&(e=1),i(t,9e4,1/e)}r.r(e),r.d(e,{toMpegTsClockFromTimescale:()=>s,toMsFromMpegTsClock:()=>a,toTimescaleFromBase:()=>i,toTimescaleFromScale:()=>n})},"./src/utils/typed-array.ts"(t,e,r){"use strict";function i(t,e,r){return Uint8Array.prototype.slice?t.slice(e,r):new Uint8Array(Array.prototype.slice.call(t,e,r))}r.r(e),r.d(e,{sliceUint8:()=>i})},"./src/utils/vttcue.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>i});let i=function(){if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;var t=["","lr","rl"],e=["start","middle","end","left","right"];function r(t,e){if("string"!=typeof e||!Array.isArray(t))return!1;var r=e.toLowerCase();return!!~t.indexOf(r)&&r}function i(t){return r(e,t)}function n(t){for(var e=arguments.length,r=Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];for(var n=1;n<arguments.length;n++){var a=arguments[n];for(var s in a)t[s]=a[s]}return t}function a(e,a,s){var o=this,l={enumerable:!0};o.hasBeenReset=!1;var u="",d=!1,c=e,f=a,h=s,$=null,g="",v=!0,p="auto",m="start",x=50,T="middle",E=50,y="middle";Object.defineProperty(o,"id",n({},l,{get:function t(){return u},set:function t(e){u=""+e}})),Object.defineProperty(o,"pauseOnExit",n({},l,{get:function t(){return d},set:function t(e){d=!!e}})),Object.defineProperty(o,"startTime",n({},l,{get:function t(){return c},set:function t(e){if("number"!=typeof e)throw TypeError("Start time must be set to a number.");c=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",n({},l,{get:function t(){return f},set:function t(e){if("number"!=typeof e)throw TypeError("End time must be set to a number.");f=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",n({},l,{get:function t(){return h},set:function t(e){h=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",n({},l,{get:function t(){return $},set:function t(e){$=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",n({},l,{get:function t(){return g},set:function e(i){var n,a=(n=i,r(t,n));if(!1===a)throw SyntaxError("An invalid or illegal string was specified.");g=a,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",n({},l,{get:function t(){return v},set:function t(e){v=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",n({},l,{get:function t(){return p},set:function t(e){if("number"!=typeof e&&"auto"!==e)throw SyntaxError("An invalid number or illegal string was specified.");p=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",n({},l,{get:function t(){return m},set:function t(e){var r=i(e);if(!r)throw SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",n({},l,{get:function t(){return x},set:function t(e){if(e<0||e>100)throw Error("Position must be between 0 and 100.");x=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",n({},l,{get:function t(){return T},set:function t(e){var r=i(e);if(!r)throw SyntaxError("An invalid or illegal string was specified.");T=r,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",n({},l,{get:function t(){return E},set:function t(e){if(e<0||e>100)throw Error("Size must be between 0 and 100.");E=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",n({},l,{get:function t(){return y},set:function t(e){var r=i(e);if(!r)throw SyntaxError("An invalid or illegal string was specified.");y=r,this.hasBeenReset=!0}})),o.displayState=void 0}return a.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},a}()},"./src/utils/vttparser.ts"(t,e,r){"use strict";r.r(e),r.d(e,{VTTParser:()=>f,fixLineBreaks:()=>c,parseTimeStamp:()=>a});var i=r(/*! ./vttcue */ "./src/utils/vttcue.ts"),n=function(){function t(){}return t.prototype.decode=function t(e,r){if(!e)return"";if("string"!=typeof e)throw Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))},t}();function a(t){function e(t,e,r,i){return(0|t)*3600+(0|e)*60+(0|r)+parseFloat(i||0)}var r=t.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return r?parseFloat(r[2])>59?e(r[2],r[3],0,r[4]):e(r[1],r[2],r[3],r[4]):null}var s=function(){function t(){this.values=Object.create(null)}var e=t.prototype;return e.set=function t(e,r){this.get(e)||""===r||(this.values[e]=r)},e.get=function t(e,r,i){return i?this.has(e)?this.values[e]:r[i]:this.has(e)?this.values[e]:r},e.has=function t(e){return e in this.values},e.alt=function t(e,r,i){for(var n=0;n<i.length;++n)if(r===i[n]){this.set(e,r);break}},e.integer=function t(e,r){/^-?\d+$/.test(r)&&this.set(e,parseInt(r,10))},e.percent=function t(e,r){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(r)){var t=parseFloat(r);if(t>=0&&t<=100)return this.set(e,t),!0}return!1},t}();function o(t,e,r,i){var n=i?t.split(i):[t];for(var a in n){if("string"==typeof n[a]){var s,o=n[a].split(r);if(2===o.length){e(o[0],o[1])}}}}var l=new i.default(0,0,""),u="middle"===l.align?"middle":"center";function d(t,e,r){var i,n,d,c,f,h=t;function $(){var e=a(t);if(null===e)throw Error("Malformed timestamp: "+h);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e}function g(){t=t.replace(/^\s+/,"")}if(g(),e.startTime=$(),g(),"-->"!==t.slice(0,3))throw Error("Malformed time stamp (time stamps must be separated by '-->'): "+h);t=t.slice(3),g(),e.endTime=$(),g(),i=t,n=e,d=new s,o(i,function(t,e){var i;switch(t){case"region":for(var n=r.length-1;n>=0;n--)if(r[n].id===e){d.set(t,r[n].region);break}break;case"vertical":d.alt(t,e,["rl","lr"]);break;case"line":i=e.split(","),d.integer(t,i[0]),d.percent(t,i[0])&&d.set("snapToLines",!1),d.alt(t,i[0],["auto"]),2===i.length&&d.alt("lineAlign",i[1],["start",u,"end"]);break;case"position":i=e.split(","),d.percent(t,i[0]),2===i.length&&d.alt("positionAlign",i[1],["start",u,"end","line-left","line-right","auto"]);break;case"size":d.percent(t,e);break;case"align":d.alt(t,e,["start",u,"end","left","right"])}},/:/,/\s/),n.region=d.get("region",null),n.vertical=d.get("vertical",""),"auto"===(c=d.get("line","auto"))&&-1===l.line&&(c=-1),n.line=c,n.lineAlign=d.get("lineAlign","start"),n.snapToLines=d.get("snapToLines",!0),n.size=d.get("size",100),n.align=d.get("align",u),"auto"===(f=d.get("position","auto"))&&50===l.position&&(f="start"===n.align||"left"===n.align?0:"end"===n.align||"right"===n.align?100:50),n.position=f}function c(t){return t.replace(/<br(?: \/)?>/gi,"\n")}var f=function(){function t(){this.state="INITIAL",this.buffer="",this.decoder=new n,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var e=t.prototype;return e.parse=function t(e){var r=this;function n(){var t=r.buffer,e=0;for(t=c(t);e<t.length&&"\r"!==t[e]&&"\n"!==t[e];)++e;var i=t.slice(0,e);return"\r"===t[e]&&++e,"\n"===t[e]&&++e,r.buffer=t.slice(e),i}function a(t){o(t,function(t,e){},/:/)}e&&(r.buffer+=r.decoder.decode(e,{stream:!0}));try{var s="";if("INITIAL"===r.state){if(!/\r\n|\n/.test(r.buffer))return this;var l=(s=n()).match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!l||!l[0])throw Error("Malformed WebVTT signature.");r.state="HEADER"}for(var u=!1;r.buffer&&/\r\n|\n/.test(r.buffer);)switch(u?u=!1:s=n(),r.state){case"HEADER":/:/.test(s)?a(s):s||(r.state="ID");continue;case"NOTE":s||(r.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){r.state="NOTE";break}if(!s)continue;if(r.cue=new i.default(0,0,""),r.state="CUE",-1===s.indexOf("-->")){r.cue.id=s;continue}case"CUE":if(!r.cue){r.state="BADCUE";continue}try{d(s,r.cue,r.regionList)}catch(f){r.cue=null,r.state="BADCUE";continue}r.state="CUETEXT";continue;case"CUETEXT":var h=-1!==s.indexOf("-->");if(!s||h&&(u=!0)){r.oncue&&r.cue&&r.oncue(r.cue),r.cue=null,r.state="ID";continue}if(null===r.cue)continue;r.cue.text&&(r.cue.text+="\n"),r.cue.text+=s;continue;case"BADCUE":s||(r.state="ID")}}catch($){"CUETEXT"===r.state&&r.cue&&r.oncue&&r.oncue(r.cue),r.cue=null,r.state="INITIAL"===r.state?"BADWEBVTT":"BADCUE"}return this},e.flush=function t(){var e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw Error("Malformed WebVTT signature.")}catch(r){e.onparsingerror&&e.onparsingerror(r)}return e.onflush&&e.onflush(),this},t}()},"./src/utils/webvtt-parser.ts"(t,e,r){"use strict";r.r(e),r.d(e,{generateCueId:()=>f,parseWebVTT:()=>$});var i=r(/*! ./src/polyfills/number */ "./src/polyfills/number.ts"),n=r(/*! ./vttparser */ "./src/utils/vttparser.ts"),a=r(/*! ../demux/id3 */ "./src/demux/id3.ts"),s=r(/*! ./timescale-conversion */ "./src/utils/timescale-conversion.ts"),o=r(/*! ../remux/mp4-remuxer */ "./src/remux/mp4-remuxer.ts"),l=/\r\n|\n\r|\n|\r/g,u=function t(e,r,i){return void 0===i&&(i=0),e.slice(i,i+r.length)===r},d=function t(e){var r=parseInt(e.slice(-3)),n=parseInt(e.slice(-6,-4)),a=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(0,i.isFiniteNumber)(r)||!(0,i.isFiniteNumber)(n)||!(0,i.isFiniteNumber)(a)||!(0,i.isFiniteNumber)(s))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+e);return r+=1e3*n,r+=6e4*a,r+=36e5*s},c=function t(e){for(var t=5381,r=e.length;r;)t=33*t^e.charCodeAt(--r);return(t>>>0).toString()};function f(t,e,r){return c(t.toString())+c(e.toString())+c(r)}var h=function t(e,r,i){var n,a=e[r],s=e[a.prevCC];if(!s||!s.new&&a.new){e.ccOffset=e.presentationOffset=a.start,a.new=!1;return}for(;null!==(n=s)&&void 0!==n&&n.new;)e.ccOffset+=a.start-s.start,a.new=!1,s=e[(a=s).prevCC];e.presentationOffset=i};function $(t,e,r,i,c,$,g,v){var p,m=new n.VTTParser,x=(0,a.utf8ArrayToStr)(new Uint8Array(t)).trim().replace(l,"\n").split("\n"),T=[],E=(0,s.toMpegTsClockFromTimescale)(e,r),y="00:00.000",S=0,L=0,b=!0;m.oncue=function(t){var e=i[c],r=i.ccOffset,n=(S-E)/9e4;null!=e&&e.new&&(void 0!==L?r=i.ccOffset=e.start:h(i,c,n)),n&&(r=n-i.presentationOffset);var a=t.endTime-t.startTime,s=(0,o.normalizePts)((t.startTime+r-L)*9e4,9e4*$)/9e4;t.startTime=Math.max(s,0),t.endTime=Math.max(s+a,0);var l=t.text.trim();t.text=decodeURIComponent(encodeURIComponent(l)),t.id||(t.id=f(t.startTime,t.endTime,l)),t.endTime>0&&T.push(t)},m.onparsingerror=function(t){p=t},m.onflush=function(){if(p){v(p);return}g(T)},x.forEach(function(t){if(b){if(u(t,"X-TIMESTAMP-MAP=")){b=!1,t.slice(16).split(",").forEach(function(t){u(t,"LOCAL:")?y=t.slice(6):u(t,"MPEGTS:")&&(S=parseInt(t.slice(7)))});try{L=d(y)/1e3}catch(e){p=e}return}""===t&&(b=!1)}m.parse(t+"\n")}),m.flush()}},"./src/utils/xhr-loader.ts"(t,e,r){"use strict";r.r(e),r.d(e,{default:()=>o});var i=r(/*! ../utils/logger */ "./src/utils/logger.ts"),n=r(/*! ../loader/load-stats */ "./src/loader/load-stats.ts"),a=/^age:\s*[\d.]+\s*$/m,s=function(){function t(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=t?t.xhrSetup:null,this.stats=new n.LoadStats,this.retryDelay=0}var e=t.prototype;return e.destroy=function t(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},e.abortInternal=function t(){var e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))},e.abort=function t(){var e;this.abortInternal(),null!==(e=this.callbacks)&&void 0!==e&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},e.load=function t(e,r,i){if(this.stats.loading.start)throw Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=r,this.callbacks=i,this.retryDelay=r.retryDelay,this.loadInternal()},e.loadInternal=function t(){var e=this.config,r=this.context;if(e){var i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0;var a=this.xhrSetup;try{if(a)try{a(i,r.url)}catch(s){i.open("GET",r.url,!0),a(i,r.url)}i.readyState||i.open("GET",r.url,!0);var o=this.context.headers;if(o)for(var l in o)i.setRequestHeader(l,o[l])}catch(u){this.callbacks.onError({code:i.status,text:u.message},r,i);return}r.rangeEnd&&i.setRequestHeader("Range","bytes="+r.rangeStart+"-"+(r.rangeEnd-1)),i.onreadystatechange=this.readystatechange.bind(this),i.onprogress=this.loadprogress.bind(this),i.responseType=r.responseType,self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),e.timeout),i.send()}},e.readystatechange=function t(){var e=this.context,r=this.loader,n=this.stats;if(e&&r){var a=r.readyState,s=this.config;if(!n.aborted&&a>=2){if(self.clearTimeout(this.requestTimeout),0===n.loading.first&&(n.loading.first=Math.max(self.performance.now(),n.loading.start)),4===a){r.onreadystatechange=null,r.onprogress=null;var o=r.status,l="arraybuffer"===r.responseType;if(o>=200&&o<300&&(l&&r.response||null!==r.responseText)){if(n.loading.end=Math.max(self.performance.now(),n.loading.first),d=l?(u=r.response).byteLength:(u=r.responseText).length,n.loaded=n.total=d,!this.callbacks)return;var u,d,c=this.callbacks.onProgress;if(c&&c(n,e,u,r),!this.callbacks)return;var f={url:r.responseURL,data:u};this.callbacks.onSuccess(f,n,e,r)}else n.retry>=s.maxRetry||o>=400&&o<499?(i.logger.error(o+" while loading "+e.url),this.callbacks.onError({code:o,text:r.statusText},e,r)):(i.logger.warn(o+" while loading "+e.url+", retrying in "+this.retryDelay+"..."),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,s.maxRetryDelay),n.retry++)}else self.clearTimeout(this.requestTimeout),this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.timeout)}}},e.loadtimeout=function t(){i.logger.warn("timeout while loading "+this.context.url);var e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))},e.loadprogress=function t(e){var r=this.stats;r.loaded=e.loaded,e.lengthComputable&&(r.total=e.total)},e.getCacheAge=function t(){var e=null;if(this.loader&&a.test(this.loader.getAllResponseHeaders())){var r=this.loader.getResponseHeader("age");e=r?parseFloat(r):null}return e},t}();let o=s},"./node_modules/eventemitter3/index.js"(t){"use strict";var e=Object.prototype.hasOwnProperty,r="~";function i(){}function n(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function a(t,e,i,a,s){if("function"!=typeof i)throw TypeError("The listener must be a function");var o=new n(i,a||t,s),l=r?r+e:e;return t._events[l]?t._events[l].fn?t._events[l]=[t._events[l],o]:t._events[l].push(o):(t._events[l]=o,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function o(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(r=!1)),o.prototype.eventNames=function t(){var i,n,a=[];if(0===this._eventsCount)return a;for(n in i=this._events)e.call(i,n)&&a.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(i)):a},o.prototype.listeners=function t(e){var i=r?r+e:e,n=this._events[i];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,s=n.length,o=Array(s);a<s;a++)o[a]=n[a].fn;return o},o.prototype.listenerCount=function t(e){var i=r?r+e:e,n=this._events[i];return n?n.fn?1:n.length:0},o.prototype.emit=function t(e,i,n,a,s,o){var l=r?r+e:e;if(!this._events[l])return!1;var u,d,c=this._events[l],f=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),f){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,i),!0;case 3:return c.fn.call(c.context,i,n),!0;case 4:return c.fn.call(c.context,i,n,a),!0;case 5:return c.fn.call(c.context,i,n,a,s),!0;case 6:return c.fn.call(c.context,i,n,a,s,o),!0}for(d=1,u=Array(f-1);d<f;d++)u[d-1]=arguments[d];c.fn.apply(c.context,u)}else{var h,$=c.length;for(d=0;d<$;d++)switch(c[d].once&&this.removeListener(e,c[d].fn,void 0,!0),f){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,i);break;case 3:c[d].fn.call(c[d].context,i,n);break;case 4:c[d].fn.call(c[d].context,i,n,a);break;default:if(!u)for(h=1,u=Array(f-1);h<f;h++)u[h-1]=arguments[h];c[d].fn.apply(c[d].context,u)}}return!0},o.prototype.on=function t(e,r,i){return a(this,e,r,i,!1)},o.prototype.once=function t(e,r,i){return a(this,e,r,i,!0)},o.prototype.removeListener=function t(e,i,n,a){var o=r?r+e:e;if(!this._events[o])return this;if(!i)return s(this,o),this;var l=this._events[o];if(l.fn)l.fn!==i||a&&!l.once||n&&l.context!==n||s(this,o);else{for(var u=0,d=[],c=l.length;u<c;u++)(l[u].fn!==i||a&&!l[u].once||n&&l[u].context!==n)&&d.push(l[u]);d.length?this._events[o]=1===d.length?d[0]:d:s(this,o)}return this},o.prototype.removeAllListeners=function t(e){var n;return e?(n=r?r+e:e,this._events[n]&&s(this,n)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,t.exports=o},"./node_modules/url-toolkit/src/url-toolkit.js":function(t){var e,r,i,n,a,s;r=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,i=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,a=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,s={buildAbsoluteURL:function(t,e,r){if(r=r||{},t=t.trim(),!(e=e.trim())){if(!r.alwaysNormalize)return t;var n=s.parseURL(t);if(!n)throw Error("Error trying to parse base URL.");return n.path=s.normalizePath(n.path),s.buildURLFromParts(n)}var a=s.parseURL(e);if(!a)throw Error("Error trying to parse relative URL.");if(a.scheme)return r.alwaysNormalize?(a.path=s.normalizePath(a.path),s.buildURLFromParts(a)):e;var o=s.parseURL(t);if(!o)throw Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=i.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var u={scheme:o.scheme,netLoc:a.netLoc,path:null,params:a.params,query:a.query,fragment:a.fragment};if(!a.netLoc&&(u.netLoc=o.netLoc,"/"!==a.path[0])){if(a.path){var d=o.path,c=d.substring(0,d.lastIndexOf("/")+1)+a.path;u.path=s.normalizePath(c)}else u.path=o.path,a.params||(u.params=o.params,a.query||(u.query=o.query))}return null===u.path&&(u.path=r.alwaysNormalize?s.normalizePath(a.path):a.path),s.buildURLFromParts(u)},parseURL:function(t){var e=r.exec(t);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(n,"");t.length!==(t=t.replace(a,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}},t.exports=s}},e={};function r(i){var n=e[i];if(void 0!==n)return n.exports;var a=e[i]={exports:{}};return t[i].call(a.exports,a,a.exports,r),a.exports}r.m=t,r.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return r.d(e,{a:e}),e},r.d=(t,e)=>{for(var i in e)r.o(e,i)&&!r.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},r.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i=r("./src/hls.ts");return i.default})());
